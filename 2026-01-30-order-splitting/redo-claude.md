so what exactly needs to be reverted (read only please, just explain)                                                                                                                                  
                                                                                                                                                                                                         
⏺ What Needs to Be Reverted                                                                                                                                                                              
                                                                                                                                                                                                         
  Core Logic (Must Revert)                                                                                                                                                                               
                                                                                                                                                                                                         
  1. src/lib/data/actions/orders.ts - createOrder() function                                                                                                                                             
  - Current: Creates ONE order, then creates multiple PlannedShipment records, links items via PlannedShipmentID                                                                                         
  - Revert to: Loop through getOrderGroupKey() groups, create SEPARATE orders per collection, each with its own ShipStartDate/ShipEndDate on the order header                                            
  - Return type: Change from single { orderId, orderNumber } back to array { orders: [{ orderId, orderNumber }, ...] }                                                                                   
                                                                                                                                                                                                         
  2. src/app/api/drafts/[id]/submit/route.ts - Draft submission                                                                                                                                          
  - Current: Uses planned shipments approach (single order)                                                                                                                                              
  - Revert to: Order splitting approach                                                                                                                                                                  
                                                                                                                                                                                                         
  3. src/lib/types/order.ts - Return types                                                                                                                                                               
  - Current: CreateOrderResult returns single order                                                                                                                                                      
  - Revert to: Returns array of created orders                                                                                                                                                           
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  UI That Becomes Inconsistent (Should Revert or Modify)                                                                                                                                                 
                                                                                                                                                                                                         
  4. src/components/buyer/email-confirmation-modal.tsx                                                                                                                                                   
  - Current: "Your order will ship in X shipments"                                                                                                                                                       
  - Revert to: "Your cart was split into X orders by delivery window" (original language)                                                                                                                
                                                                                                                                                                                                         
  5. src/app/buyer/(shop)/my-order/client.tsx - Shipment derivation                                                                                                                                      
  - Current: Computes plannedShipments array for single-order multi-shipment UI                                                                                                                          
  - Revert to: Could show "preview of orders to be created" or simplify to single date picker                                                                                                            
                                                                                                                                                                                                         
  6. src/components/buyer/order-form.tsx - Multi-shipment cards                                                                                                                                          
  - Current: Shows shipment cards with per-collection dates when plannedShipments.length > 1                                                                                                             
  - Revert to: Either remove, or repurpose as "orders preview"                                                                                                                                           
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Features That Become Orphaned (Can Remove or Leave)                                                                                                                                                    
  ┌───────────────────────────────────┬──────────────────────────────────────────────────────────┬──────────────────────────────────────────────────┐                                                    
  │              Feature              │                         Location                         │                   What Happens                   │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ PlannedShipment creation          │ createOrder()                                            │ Skip/remove                                      │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ PlannedShipmentID on items        │ CustomerOrdersItems                                      │ Don't populate (leave column, just null)         │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ Admin planned shipments UI        │ planned-shipments-section.tsx, planned-shipment-card.tsx │ Unused (each order = 1 collection)               │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ Item movement between shipments   │ move-item-modal.tsx, planned-shipments.ts                │ Unused                                           │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ Edit mode shipment handling       │ Phase 5 work in order-context.tsx, client.tsx            │ Unused                                           │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ Shipment count badge              │ orders-table.tsx                                         │ Always shows 1 (or remove)                       │                                                    
  ├───────────────────────────────────┼──────────────────────────────────────────────────────────┼──────────────────────────────────────────────────┤                                                    
  │ Collection date → shipment impact │ affected-orders-preview-dialog.tsx                       │ Would affect orders, not shipments within orders │                                                    
  └───────────────────────────────────┴──────────────────────────────────────────────────────────┴──────────────────────────────────────────────────┘                                                    
  ---                                                                                                                                                                                                    
  What Can Stay (Still Useful)                                                                                                                                                                           
  ┌────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────┐                                                                                
  │                  Feature                   │                                Why Keep                                │                                                                                
  ├────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────┤                                                                                
  │ Ship date validation (validateShipDates()) │ Still validates each split order's dates against its collection window │                                                                                
  ├────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────┤                                                                                
  │ Order notes clearing fix                   │ Unrelated to splitting                                                 │                                                                                
  ├────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────┤                                                                                
  │ Product search fix                         │ Unrelated                                                              │                                                                                
  ├────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────────┤                                                                                
  │ PlannedShipment table in DB                │ Leave it - no harm, already in prod, might use later                   │                                                                                
  └────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────────┘                                                                                
  ---                                                                                                                                                                                                    
  Summary: Minimum Revert Scope                                                                                                                                                                          
                                                                                                                                                                                                         
  Must change (3 files):                                                                                                                                                                                 
  1. src/lib/data/actions/orders.ts - restore splitting logic                                                                                                                                            
  2. src/app/api/drafts/[id]/submit/route.ts - restore splitting logic                                                                                                                                   
  3. src/lib/types/order.ts - restore array return type                                                                                                                                                  
                                                                                                                                                                                                         
  Should change (3 files):                                                                                                                                                                               
  4. src/components/buyer/email-confirmation-modal.tsx - restore "split into X orders" language                                                                                                          
  5. src/app/buyer/(shop)/my-order/client.tsx - simplify or remove multi-shipment derivation                                                                                                             
  6. src/components/buyer/order-form.tsx - remove/simplify multi-shipment UI                                                                                                                             
                                                                                                                                                                                                         
  Can leave as-is (orphaned but harmless):                                                                                                                                                               
  - Admin planned shipments UI (just won't show multiple)                                                                                                                                                
  - PlannedShipment table (empty but exists)                                                                                                                                                             
  - Item movement feature (unused)                                                                                                                                                                       
                                                                                                                                                                                                         
✻ Churned for 33s                                                                                                                                                                                        
                                                                                                                                                                                                         
❯ Consider this paralllel perspective: Here’s what I found by checking the pre‑PlannedShipment code (commit 8d9f99a, read‑only):                                                                         
                                                                                                                                                                                                         
    Original behavior (confirmed in code)                                                                                                                                                                
                                                                                                                                                                                                         
    - Single ship window per order. The buyer form only had shipStartDate and shipEndDate fields (no per‑shipment cards). Defaults: pre‑order uses category on‑route                                     
      dates, ATS uses today → today+14, edit mode uses existing order header dates. src/components/buyer/order-form.tsx                                                                                  
    - Server split into multiple orders by delivery window + order type. createOrder() grouped items by order type (ATS vs Pre‑Order) and ship window/category, then                                     
      created one CustomerOrders header per group, each with its own order number and its own header ship dates (from the group’s window, otherwise the form dates). src/                                
      lib/data/actions/orders.ts                                                                                                                                                                         
    - Order items carried category/ship‑window metadata (not planned shipments). The order input schema had categoryId/categoryName/shipWindowStart/shipWindowEnd on                                     
      items, and no plannedShipments field. src/lib/schemas/order.ts                                                                                                                                     
    - UI acknowledged splitting. After submit, the buyer flow showed a toast like “Order split into X orders by delivery window,” then opened a single‑order email modal                                 
      (no shipment summary). src/components/buyer/order-form.tsx, src/components/buyer/email-confirmation-modal.tsx                                                                                      
    - Draft submit also split into multiple orders. Draft submission used the same grouping logic and created multiple orders on submit. src/app/api/drafts/[id]/submit/                                 
      route.ts                                                                                                                                                                                           
                                                                                                                                                                                                         
    Net conclusion                                                                                                                                                                                       
    The original system behavior was one ship window per order and multiple orders created at submit when delivery windows differed. There was no “planned shipments”                                    
    concept in the order data model or buyer UI—only the existing fulfillment shipments table.                                                                                                           
                                                                                                                                                                                                         
    If you want, I can now bucket the current changes into (a) rollback, (b) keep, (c) reset/repurpose, with exact files per bucket. + Below is a clean bucketization assuming the target is restore     
   split‑order behavior and remove “planned shipments inside a single order”. Files listed are exact                                                                                                     
    paths.                                                                                                                                                                                               
                                                                                                                                                                                                         
    (a) Rollback — remove/restore to pre‑PlannedShipment behavior (dedicated UI/components)                                                                                                              
                                                                                                                                                                                                         
    - src/components/buyer/shipment-date-card.tsx                                                                                                                                                        
    - src/components/ui/shipment-timeline.tsx                                                                                                                                                            
    - src/components/admin/order-detail/planned-shipments-section.tsx                                                                                                                                    
    - src/components/admin/order-detail/planned-shipment-card.tsx                                                                                                                                        
    - src/components/admin/order-detail/move-item-modal.tsx                                                                                                                                              
    - src/lib/data/actions/planned-shipments.ts                                                                                                                                                          
    - src/components/buyer/email-confirmation-modal.tsx                                                                                                                                                  
    - src/lib/email/templates.ts                                                                                                                                                                         
    - src/lib/email/send-order-emails.ts                                                                                                                                                                 
    - src/lib/pdf/order-confirmation.ts                                                                                                                                                                  
    - src/app/api/orders/[id]/pdf/route.ts                                                                                                                                                               
    - src/lib/types/planned-shipment.ts                                                                                                                                                                  
    - src/lib/utils/shipment-helpers.ts                                                                                                                                                                  
    - src/components/admin/shipment-modal.tsx                                                                                                                                                            
    - src/lib/data/actions/shipments.ts                                                                                                                                                                  
    - src/components/ui/index.ts                                                                                                                                                                         
                                                                                                                                                                                                         
    (b) Keep — safe to retain as‑is                                                                                                                                                                      
                                                                                                                                                                                                         
    - src/lib/data/queries/products.ts                                                                                                                                                                   
                                                                                                                                                                                                         
    (c) Reset/repurpose — core flows to revert to split‑order logic, while preserving any non‑shipment fixes                                                                                             
                                                                                                                                                                                                         
    - src/lib/data/actions/orders.ts                                                                                                                                                                     
    - src/app/api/drafts/[id]/submit/route.ts                                                                                                                                                            
    - src/lib/schemas/order.ts                                                                                                                                                                           
    - src/components/buyer/order-form.tsx                                                                                                                                                                
    - src/app/buyer/(shop)/my-order/client.tsx                                                                                                                                                           
    - src/lib/contexts/order-context.tsx                                                                                                                                                                 
    - src/lib/data/queries/orders.ts                                                                                                                                                                     
    - src/lib/types/order.ts                                                                                                                                                                             
    - src/components/admin/orders-table.tsx                                                                                                                                                              
    - src/components/rep/rep-orders-table.tsx                                                                                                                                                            
    - src/components/admin/order-detail-client.tsx                                                                                                                                                       
    - src/app/admin/(protected)/(admin)/orders/[id]/page.tsx                                                                                                                                             
    - src/app/api/drafts/[id]/route.ts                                                                                                                                                                   
    - src/lib/validation/ship-window.ts                                                                                                                                                                  
    - src/app/buyer/(shop)/my-order/page.tsx                                                                                                                                                             
    - src/lib/data/actions/collections.ts                                                                                                                                                                
    - src/lib/data/queries/collections.ts                                                                                                                                                                
    - src/components/admin/collections/collection-modal.tsx                                                                                                                                              
    - src/components/admin/collections/affected-orders-preview-dialog.tsx                                                                                                                                
    - src/app/admin/(protected)/(admin)/collections/[id]/affected-orders/client.tsx                                                                                                                      
    - src/lib/email/shipment-date-change.ts                                                                                                                                                              
    - prisma/schema.prisma                                                                                                                                                                               
    - prisma/migrations/manual_add_planned_shipments.sql                                                                                                                                                 
    - pending-migration.sql                                                                                                                                                                              
    - current-db-schema.prisma                                                                                                                                                                           
   (DO NOT EDIT)                                                                                                                                                                                         
                                                                                                                                                                                                         
⏺ This is a more comprehensive bucketing than mine. Let me synthesize both analyses:                                                                                                                     
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Comparison: My Analysis vs. Parallel Analysis                                                                                                                                                          
  ┌──────────────────────────────────┬────────────────────────────────────────────────┬──────────────────────────────────────────┐                                                                       
  │              Aspect              │                  My Analysis                   │            Parallel Analysis             │                                                                       
  ├──────────────────────────────────┼────────────────────────────────────────────────┼──────────────────────────────────────────┤                                                                       
  │ Core files to revert             │ 3 files                                        │ 6 files in bucket (c) core               │                                                                       
  ├──────────────────────────────────┼────────────────────────────────────────────────┼──────────────────────────────────────────┤                                                                       
  │ UI components to remove/rollback │ Mentioned as "orphaned"                        │ 16 files explicitly listed in bucket (a) │                                                                       
  ├──────────────────────────────────┼────────────────────────────────────────────────┼──────────────────────────────────────────┤                                                                       
  │ Files to keep                    │ 3 features (validation, notes fix, search fix) │ Just products.ts                         │                                                                       
  ├──────────────────────────────────┼────────────────────────────────────────────────┼──────────────────────────────────────────┤                                                                       
  │ Total scope                      │ ~6 files                                       │ ~40+ files across buckets                │                                                                       
  └──────────────────────────────────┴────────────────────────────────────────────────┴──────────────────────────────────────────┘                                                                       
  The parallel analysis is more thorough - it identified dedicated components I missed (like shipment-timeline.tsx, shipment-helpers.ts) and the full downstream impact (emails, PDFs, collection change 
  workflow).                                                                                                                                                                                             
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Key Insight from Bucket (a)                                                                                                                                                                            
                                                                                                                                                                                                         
  These are NEW files created specifically for PlannedShipments that didn't exist before:                                                                                                                
                                                                                                                                                                                                         
  src/components/buyer/shipment-date-card.tsx          ← NEW                                                                                                                                             
  src/components/ui/shipment-timeline.tsx              ← NEW                                                                                                                                             
  src/components/admin/order-detail/planned-shipments-section.tsx  ← NEW                                                                                                                                 
  src/components/admin/order-detail/planned-shipment-card.tsx      ← NEW                                                                                                                                 
  src/components/admin/order-detail/move-item-modal.tsx            ← NEW                                                                                                                                 
  src/lib/data/actions/planned-shipments.ts            ← NEW                                                                                                                                             
  src/lib/types/planned-shipment.ts                    ← NEW                                                                                                                                             
  src/lib/utils/shipment-helpers.ts                    ← NEW                                                                                                                                             
                                                                                                                                                                                                         
  These can potentially be deleted entirely rather than reverted.                                                                                                                                        
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Key Insight from Bucket (c)                                                                                                                                                                            
                                                                                                                                                                                                         
  These are existing files that were modified - they need careful surgical revert:                                                                                                                       
  ┌──────────────────────────────┬───────────────────────────────────────────────┬──────────────────────────────┐                                                                                        
  │             File             │                 What Changed                  │      Revert Complexity       │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ orders.ts (actions)          │ Core createOrder() logic                      │ High - restore grouping loop │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ drafts/[id]/submit/route.ts  │ Same splitting logic                          │ High                         │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ order.ts (schemas)           │ Added plannedShipments to input               │ Medium                       │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ order-form.tsx               │ Added multi-shipment UI                       │ Medium                       │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ order-context.tsx            │ Added shipment state management               │ Medium                       │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ orders.ts (queries)          │ Added plannedShipmentCount, shipment fetching │ Medium                       │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ email-confirmation-modal.tsx │ Language change                               │ Low                          │                                                                                        
  ├──────────────────────────────┼───────────────────────────────────────────────┼──────────────────────────────┤                                                                                        
  │ collection-modal.tsx         │ Added shipment impact preview                 │ Medium                       │                                                                                        
  └──────────────────────────────┴───────────────────────────────────────────────┴──────────────────────────────┘                                                                                        
  ---                                                                                                                                                                                                    
  What About ship-window.ts Validation?                                                                                                                                                                  
                                                                                                                                                                                                         
  The parallel analysis puts src/lib/validation/ship-window.ts in bucket (c) reset/repurpose.                                                                                                            
                                                                                                                                                                                                         
  Question: Was ship date validation against collection windows NEW, or did it exist before in some form?                                                                                                
                                                                                                                                                                                                         
  If new → could remove or keep (still useful for validating each split order)                                                                                                                           
  If existed → restore original form                                                                                                                                                                     
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Schema Consideration                                                                                                                                                                                   
                                                                                                                                                                                                         
  prisma/schema.prisma                                                                                                                                                                                   
  prisma/migrations/manual_add_planned_shipments.sql                                                                                                                                                     
                                                                                                                                                                                                         
  The PlannedShipment model is in prod. Options:                                                                                                                                                         
  1. Leave table, just don't use it - safest, no migration needed                                                                                                                                        
  2. Remove from schema, add rollback migration - cleaner but riskier                                                                                                                                    
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Suggested Approach                                                                                                                                                                                     
                                                                                                                                                                                                         
  Given the scope (~40 files), would a git-based revert to a pre-PlannedShipment commit be cleaner than surgical file-by-file changes? Then selectively re-apply:                                        
  - Product search fix                                                                                                                                                                                   
  - Order notes fix                                                                                                                                                                                      
  - Any other unrelated improvements                                                                                                                                                                     
                                                                                                                                                                                                         
  What's your preference on approach?                                                                                                                                                                    
                                                                                                                                                                                                         
✻ Worked for 32s                                                                                                                                                                                         
                                                                                                                                                                                                         
❯ A git-based revert won't work because I have had messy commits since then.                                                                                      About this issue - The                 
  PlannedShipment model is in prod. Options:                                                                                                                                                             
    1. Leave table, just don't use it - safest, no migration needed      Leave table for now, thanks. I'm not sure what to do, what do you advise?                                                       
                                                                                                                                                                                                         
⏺ Given the constraints (messy git history, PlannedShipment table stays), here's my advice:                                                                                                              
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Recommended Approach: Phased Revert                                                                                                                                                                    
                                                                                                                                                                                                         
  Phase 1: Core Behavior (Do First, Test Immediately)                                                                                                                                                    
                                                                                                                                                                                                         
  Goal: Orders split again. Everything else can be inconsistent temporarily.                                                                                                                             
  ┌─────────────────────────────────────────┬───────────────────────────────────────┬─────────────────────────────┐                                                                                      
  │                  File                   │                Change                 │          Why First          │                                                                                      
  ├─────────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────────┤                                                                                      
  │ src/lib/data/actions/orders.ts          │ Restore createOrder() splitting logic │ This IS the behavior change │                                                                                      
  ├─────────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────────┤                                                                                      
  │ src/app/api/drafts/[id]/submit/route.ts │ Restore splitting logic               │ Drafts must match           │                                                                                      
  ├─────────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────────┤                                                                                      
  │ src/lib/types/order.ts                  │ Return orders[] array again           │ Type safety                 │                                                                                      
  ├─────────────────────────────────────────┼───────────────────────────────────────┼─────────────────────────────┤                                                                                      
  │ src/lib/schemas/order.ts                │ Remove/ignore plannedShipments input  │ Schema alignment            │                                                                                      
  └─────────────────────────────────────────┴───────────────────────────────────────┴─────────────────────────────┘                                                                                      
  After Phase 1: Test that submitting a cart with 2 collections creates 2 separate orders. UI will look weird but behavior is correct.                                                                   
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Phase 2: UI Alignment (Do Next)                                                                                                                                                                        
                                                                                                                                                                                                         
  Goal: UI matches the split-order reality.                                                                                                                                                              
  ┌───────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────┐                                                                  
  │                       File                        │                                    Change                                     │                                                                  
  ├───────────────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                                  
  │ src/components/buyer/email-confirmation-modal.tsx │ Restore "split into X orders" language                                        │                                                                  
  ├───────────────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                                  
  │ src/components/buyer/order-form.tsx               │ Remove multi-shipment cards, back to single date picker (or "orders preview") │                                                                  
  ├───────────────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                                  
  │ src/app/buyer/(shop)/my-order/client.tsx          │ Remove/simplify shipment derivation                                           │                                                                  
  ├───────────────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                                  
  │ src/lib/contexts/order-context.tsx                │ Remove shipment assignment state                                              │                                                                  
  └───────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┘                                                                  
  After Phase 2: Buyer flow looks and works like before.                                                                                                                                                 
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Phase 3: Cleanup (Can Defer)                                                                                                                                                                           
                                                                                                                                                                                                         
  Goal: Remove dead code. Not urgent - it won't break anything.                                                                                                                                          
                                                                                                                                                                                                         
  - Delete new components (shipment-date-card.tsx, planned-shipments-section.tsx, etc.)                                                                                                                  
  - Remove unused queries/actions (planned-shipments.ts)                                                                                                                                                 
  - Clean up admin order detail (planned shipments section won't show anything meaningful)                                                                                                               
  - Update collection date change workflow (affects orders, not shipments)                                                                                                                               
                                                                                                                                                                                                         
  This can wait - orphaned code is ugly but harmless.                                                                                                                                                    
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Why This Order?                                                                                                                                                                                        
                                                                                                                                                                                                         
  1. Phase 1 fixes the actual problem - orders split correctly                                                                                                                                           
  2. Phase 2 prevents user confusion - UI matches behavior                                                                                                                                               
  3. Phase 3 is technical debt - can tackle later or incrementally                                                                                                                                       
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Practical Next Step                                                                                                                                                                                    
                                                                                                                                                                                                         
  Want me to start with Phase 1? I would:                                                                                                                                                                
  1. Find the pre-PlannedShipment version of createOrder() (from git history or reconstruction)                                                                                                          
  2. Identify exactly what to restore vs. what to keep (like the mode: 'insensitive' fix)                                                                                                                
  3. Present the specific changes before making them                                                                                                                                                     
                                                                                                                                                                                                         
  This keeps you in control and lets you verify each step.                                                                                                                                               
                                                                                                                                                                                                         
✻ Crunched for 35s                                                                                                                                                                                       
                                                                                                                                                                                                         
❯ Here is the feedback from our codex expert engineering agent to help sharpen up the plan: A staged rollback is valid but keep ship-window validation intact to avoid breaking delivery timing.         
  It's safest to retain the current collection-based shipStart/End                                                                                                                                       
    windows if that is now the canonical source, though offering an option to revert to category-based windows can help if data quality supports it. Emphasize reviewing                                 
    createOrder return types since downstream UI expects shipments arrays; update API response types accordingly. Note that admin/rep lists rely on plannedShipmentCount                                 
    from queries, which should be removed or repurposed for split orders. Also, clarify preOrder logic changes tied to collection types versus SkuCategories in                                          
    createOrder and assess if reverting is needed. For the unused table, advise leaving it in place for now to avoid orphaned references but mark it clearly deprecated.                                 
    Provide a checklist covering these validation points, type updates, UI impact, and data source decisions to guide safe rollout and rollback.                                                         
                                                                                                                                                                                                         
    Reviewing and enhancing rollback plan                                                                                                                                                                
                                                                                                                                                                                                         
    The plan is solid but Phase 1 should also update order-form and email modal to handle the new orders array shape and prevent runtime errors. Ship-window validation                                  
    must be kept per order group to meet delivery policies, or reverting it risks violating requirements temporarily. Decide whether to use category-based or collection-                                
    based ship windows and pre-order detection based on canonical data. Phase 2 should focus on buyer UI updates to single date fields and removing multi-shipment flows,                                
    while Phase 3 cleans up planned shipment UI and related admin queries. Keeping the PlannedShipment table is advised but writes should be disabled to avoid                                           
    inconsistencies, and code relying on it (e.g., admin shipment modal) must handle empty data gracefully. This ensures a safe, staged migration without breaking                                       
    existing user flows.                                                                                                                                                                                 
                                                                                                                                                                                                         
  • Plan is directionally right, but Phase 1 is a little too small to be safe. Here’s the review with the minimum adjustments I’d recommend.                                                             
                                                                                                                                                                                                         
    Phase 1 (Core behavior) — add these to avoid runtime/type breakage                                                                                                                                   
                                                                                                                                                                                                         
    - Add a minimal consumer fix in src/components/buyer/order-form.tsx so it can handle the reverted return shape (orders[]). Right now that file expects the “single                                   
      order + shipments” path; if you flip the backend without a tiny front‑end change, the submit flow will break.                                                                                      
    - Decide and align ship‑window source before restoring grouping logic:                                                                                                                               
        - Old behavior used SkuCategories.OnRouteAvailableDate/End.                                                                                                                                      
        - Current code uses Collection.shipWindowStart/End.                                                                                                                                              
        - Pick one as canonical (likely Collection, since it’s now the source of truth), and ensure the split grouping uses that same source.                                                            
    - Keep ship‑window validation, but move it to per‑order group (not per‑planned‑shipment). Otherwise you’ll lose the CEO rule (“cannot be earlier than collection                                     
      window”) during Phase 1.                                                                                                                                                                           
    - Pre‑Order detection source: old logic used SkuCategories.IsPreOrder; current uses Collection.type. Choose one and keep it consistent across create/draft paths.                                    
                                                                                                                                                                                                         
    So Phase 1 should be:                                                                                                                                                                                
                                                                                                                                                                                                         
    - src/lib/data/actions/orders.ts (restore splitting, align window source, per‑group validation, pre‑order logic)                                                                                     
    - src/app/api/drafts/[id]/submit/route.ts (same)                                                                                                                                                     
    - src/lib/types/order.ts (return shape)                                                                                                                                                              
    - src/lib/schemas/order.ts (drop plannedShipments input)                                                                                                                                             
    - src/components/buyer/order-form.tsx (minimal compatibility update)                                                                                                                                 
                                                                                                                                                                                                         
    Phase 2 (UI alignment) — good as‑is, but call out admin/rep lists                                                                                                                                    
                                                                                                                                                                                                         
    - Your list is correct. I’d add:                                                                                                                                                                     
        - src/components/admin/orders-table.tsx and src/components/rep/rep-orders-table.tsx                                                                                                              
          These still assume shipment counts / timelines; with split orders they will look wrong or redundant.                                                                                           
                                                                                                                                                                                                         
    Phase 3 (Cleanup) — good, but include collection workflow + shipment modal                                                                                                                           
                                                                                                                                                                                                         
    - Add:                                                                                                                                                                                               
        - src/components/admin/shipment-modal.tsx and src/lib/data/actions/shipments.ts                                                                                                                  
          These currently reference planned shipments; once planned shipments are unused, they should degrade gracefully or be cleaned up.                                                               
        - src/lib/data/actions/collections.ts, src/lib/data/queries/collections.ts, src/components/admin/collections/*, src/app/admin/(protected)/(admin)/collections/                                   
          [id]/affected-orders/client.tsx                                                                                                                                                                
          The collection‑change flow is currently shipment‑based and will be misleading under split‑order behavior.                                                                                      
                                                                                                                                                                                                         
    On leaving PlannedShipment in prod                                                                                                                                                                   
                                                                                                                                                                                                         
    - I agree with “leave it for now.” Best advice: stop writing to it, but don’t remove it. Treat it as dormant until you decide future use. No migration risk, no data                                 
      loss risk. You can optionally add a small guard later to ensure it stays unused (e.g., no writes in create/draft/update).                                                                          
                                                                                                                                                                                                         
    Bottom line                                                                                                                                                                                          
                                                                                                                                                                                                         
    - Your phase order is good, but Phase 1 needs a small front‑end compatibility fix plus a firm decision on ship‑window source and pre‑order source. That prevents a                                   
      “behavior is correct but app is broken” gap.                                                                                                                                                       
                                                                                                                                                                                                         
    If you want, I can refine Phase 1 into a concrete, file‑by‑file checklist (still read‑only) with the exact function blocks to swap back to pre‑PlannedShipment                                       
    behavior.                                                                                                                                                                                            
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › Yes, refine Phase 1 into a concrete, file‑by‑file checklist (still read‑only) with the exact function blocks to swap back to pre‑PlannedShipment                                                     
      behavior                                                                                                                                                                                           
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • I'm inspecting current orders.ts to identify exact function blocks like createOrder and helpers affecting planned shipments, noting places to swap legacy grouping                                   
    from commit 8d9f99a. I'll specify function names, file paths, and how to replace current shipment handling by restoring _getOrderGroupKey usage and removing newer                                   
    helpers accordingly.                                                                                                                                                                                 
                                                                                                                                                                                                         
    Preparing concise function references                                                                                                                                                                
                                                                                                                                                                                                         
    I'll limit snippets to under 25 words and focus on function names with surrounding comments, especially around createOrder and draft submit, using sed for targeted                                  
    segments.                                                                                                                                                                                            
                                                                                                                                                                                                         
  • Explored                                                                                                                                                                                             
    └ Search createOrder\(|updateOrder\(|getLegacyDatesFromShipments|deriveShipmentsFromItems|_getOrderGroupKey in orders.ts                                                                             
      Read orders.ts                                                                                                                                                                                     
                                                                                                                                                                                                         
  • Creating a detailed, per-file checklist specifying exact code blocks to remove or restore for the Phase1 rollback, focusing on handling group order logic without                                    
    planned shipments and simplifying validation accordingly.                                                                                                                                            
                                                                                                                                                                                                         
    Extending Phase1 checklist with order creation and draft submit details                                                                                                                              
                                                                                                                                                                                                         
    Clarifying steps to revert order creation to looping over groups, removing planned shipments and related fields, adjusting email sending per order, and returning                                    
    orders array with primary order info. Planning to reintroduce old group key logic based on collectionId and adjust ship date validation per group. Also noting need                                  
    to restore old grouping function in draft submit route to replace planned shipments handling.                                                                                                        
                                                                                                                                                                                                         
  • Explored                                                                                                                                                                                             
    └ Read route.ts, order.ts                                                                                                                                                                            
                                                                                                                                                                                                         
  • Phase1 requires minimal changes to handle the new createOrder result with orders array while preventing UI breakage; the plan is to adapt order-form to construct a                                  
    shipments array from result.orders for the modal and toasts, accepting imperfect UI but ensuring correctness and no crashes.                                                                         
                                                                                                                                                                                                         
    Verifying order-form dependencies on shipment count                                                                                                                                                  
                                                                                                                                                                                                         
    I'm checking if reverting types to return orders array and removing plannedShipmentCount breaks order-form logic, especially around ShipmentSummary usage in                                         
    submission and modal handling.                                                                                                                                                                       
                                                                                                                                                                                                         
  • Explored                                                                                                                                                                                             
    └ Search EmailConfirmationModal|plannedShipments|orderCount|submittedOrder in order-form.tsx                                                                                                         
      Read order-form.tsx                                                                                                                                                                                
                                                                                                                                                                                                         
  • Phase1 requires removing plannedShipments from the schema and input, so the frontend must stop sending it. This means the order-form's createOrder call and related                                  
    variables must revert to pre-plannedShipments logic to compile and work correctly, even if the multi-shipment UI remains inconsistent.                                                               
                                                                                                                                                                                                         
    Detailing Phase1 revert checklist with function blocks                                                                                                                                               
                                                                                                                                                                                                         
    I’m outlining precise function blocks to swap back to pre-PlannedShipment behavior for Phase1, referencing old grouping logic (commit 8d9f99a) and noting key                                        
    removals like plannedShipments from createOrder input, schema, and validation. This includes disabling shipment validation gating in the order-form onSubmit to avoid                                
    submit blocks, keeping updateOrder unchanged, and adjusting API submit routes and types accordingly.                                                                                                 
                                                                                                                                                                                                         
  ─ Worked for 33s ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────                                
                                                                                                                                                                                                         
  • Phase 1 checklist — exact blocks to swap back (read‑only)                                                                                                                                            
    Target: restore split‑order behavior while keeping the app compiling. Use commit 8d9f99a as the reference shape for the legacy blocks.                                                               
                                                                                                                                                                                                         
    1) src/lib/data/actions/orders.ts — createOrder()                                                                                                                                                    
                                                                                                                                                                                                         
    - Replace the “planned shipments” pipeline                                                                                                                                                           
      Remove block: from // Use provided plannedShipments or derive from items through the end of the shipment validation section (the entire “Server‑side validation:                                   
      Batch fetch collections and validate dates” loop).                                                                                                                                                 
      Restore block: legacy grouping loop (from 8d9f99a) that:                                                                                                                                           
        - Builds itemGroups using getOrderGroupKey (you already have _getOrderGroupKey; use it).                                                                                                         
        - Creates one order per group with its own order number.                                                                                                                                         
    - Replace single‑order totals/dates                                                                                                                                                                  
      Remove block: // Calculate order totals and legacy dates (and the legacyDates calculation).                                                                                                        
      Restore block: per‑group orderAmount, shipStart, shipEnd using group item metadata (collection window when present, otherwise form dates).                                                         
    - Replace single‑order transaction                                                                                                                                                                   
      Remove block: everything under // Generate SINGLE order number through // CREATE PLANNED SHIPMENTS and the PlannedShipmentID mapping.                                                              
      Restore block: “Create one order per group” loop (from 8d9f99a) that:                                                                                                                              
        - Generates orderNumber per group (A/P based on group’s pre‑order status).                                                                                                                       
        - Creates CustomerOrders and CustomerOrdersItems without PlannedShipmentID.                                                                                                                      
        - Increments OrderCount by createdOrders.length, not by 1.                                                                                                                                       
    - Replace single‑order email + return payload                                                                                                                                                        
      Remove block: // Send email for the single order and shipmentSummaries built from planned shipments.                                                                                               
      Restore block: send email per created order and return { orders: [...] } (plus a primaryOrder for backward compatibility).                                                                         
      Also remove: plannedShipmentCount and createdShipmentIds usage.                                                                                                                                    
                                                                                                                                                                                                         
    2) src/app/api/drafts/[id]/submit/route.ts — draft submit                                                                                                                                            
                                                                                                                                                                                                         
    - Replace planned‑shipment derivation                                                                                                                                                                
      Remove block: // Phase 9: Use planned shipments instead of splitting orders through the planned‑shipment validation loop.                                                                          
      Restore block: legacy getOrderGroupKey grouping (from 8d9f99a) using the existing items array and skuPreOrderMap.                                                                                  
    - Replace single‑order transaction                                                                                                                                                                   
      Remove block: // Create SINGLE order + // Create planned shipments + PlannedShipmentID assignment.                                                                                                 
      Restore block: loop creating one order per group, creating items without PlannedShipmentID.                                                                                                        
    - Adjust return payload                                                                                                                                                                              
      Remove: plannedShipmentCount.                                                                                                                                                                      
      Return: { orders: [...] } (plus orderId/orderNumber of the first order for compatibility).                                                                                                         
                                                                                                                                                                                                         
    3) src/lib/schemas/order.ts — input schema                                                                                                                                                           
                                                                                                                                                                                                         
    - Remove planned‑shipment input from order creation                                                                                                                                                  
      Remove block: plannedShipmentSchema definition and the plannedShipments field inside createOrderInputSchema.                                                                                       
      Keep: orderItemSchema fields collectionId/collectionName/shipWindowStart/shipWindowEnd (needed for grouping).                                                                                      
                                                                                                                                                                                                         
    4) src/lib/types/order.ts — CreateOrderResult                                                                                                                                                        
                                                                                                                                                                                                         
    - Restore legacy return shape                                                                                                                                                                        
      Remove: plannedShipmentCount.                                                                                                                                                                      
      Set orders[] as primary return (array of created orders).                                                                                                                                          
      Optionally keep: orderId/orderNumber for the first order (backward compatibility, as in 8d9f99a).                                                                                                  
                                                                                                                                                                                                         
    5) src/components/buyer/order-form.tsx — create‑order submit branch                                                                                                                                  
                                                                                                                                                                                                         
    - Stop sending planned shipments to createOrder()                                                                                                                                                    
      Remove block: finalPlannedShipments assembly + getLegacyDatesFromShipments() usage + plannedShipments: in the payload.                                                                             
      Restore block: legacy call that only passes items with collectionId/shipWindowStart/shipWindowEnd.                                                                                                 
    - Avoid client‑side shipment validation blocking                                                                                                                                                     
      Remove block: if (hasShipmentValidationErrors && !overrideConfirmed) { ... } because it’s based on planned shipments and will incorrectly block split orders.                                      
      (Server‑side validation remains in createOrder() per group.)                                                                                                                                       
    - Keep result handling based on result.orders                                                                                                                                                        
      The modal can still consume orders[] even if the text is wrong (Phase 2 will fix language).                                                                                                        
                                                                                                                                                                                                         
                                                                                                                                                                                                         
⏺ This is a solid, detailed checklist. Let me organize it for clarity:                                                                                                                                   
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Phase 1 Checklist Summary                                                                                                                                                                              
                                                                                                                                                                                                         
  Decisions Required Before Starting                                                                                                                                                                     
  ┌────────────────────┬────────────────────────────────────────┬────────────────────────────────┬────────────────────────────────┐                                                                      
  │      Decision      │             Old (8d9f99a)              │            Current             │         Recommendation         │                                                                      
  ├────────────────────┼────────────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤                                                                      
  │ Ship window source │ SkuCategories.OnRouteAvailableDate/End │ Collection.shipWindowStart/End │ Use Collection (now canonical) │                                                                      
  ├────────────────────┼────────────────────────────────────────┼────────────────────────────────┼────────────────────────────────┤                                                                      
  │ PreOrder detection │ SkuCategories.IsPreOrder               │ Collection.type                │ Use Collection (consistent)    │                                                                      
  └────────────────────┴────────────────────────────────────────┴────────────────────────────────┴────────────────────────────────┘                                                                      
  ---                                                                                                                                                                                                    
  File-by-File Changes                                                                                                                                                                                   
  ┌─────┬─────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────┐                                                                        
  │  #  │                  File                   │                               Action Summary                                │                                                                        
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                        
  │ 1   │ src/lib/data/actions/orders.ts          │ Restore grouping loop, remove PlannedShipment creation, return orders[]     │                                                                        
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                        
  │ 2   │ src/app/api/drafts/[id]/submit/route.ts │ Same - restore grouping, remove PlannedShipment                             │                                                                        
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                        
  │ 3   │ src/lib/schemas/order.ts                │ Remove plannedShipments from input schema                                   │                                                                        
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                        
  │ 4   │ src/lib/types/order.ts                  │ Return orders[] array, remove plannedShipmentCount                          │                                                                        
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                        
  │ 5   │ src/components/buyer/order-form.tsx     │ Stop sending plannedShipments, remove client-side shipment validation block │                                                                        
  └─────┴─────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────┘                                                                        
  ---                                                                                                                                                                                                    
  Key Points                                                                                                                                                                                             
                                                                                                                                                                                                         
  1. Ship-window validation stays - but moves to per-order-group (not per-planned-shipment)                                                                                                              
  2. _getOrderGroupKey() already exists - just need to use it                                                                                                                                            
  3. PlannedShipmentID columns stay in DB - just don't populate them                                                                                                                                     
  4. Email sends per created order - not once for single order                                                                                                                                           
  5. Modal will work - consumes orders[], language fix is Phase 2                                                                                                                                        
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  After Phase 1 Completes                                                                                                                                                                                
                                                                                                                                                                                                         
  What works:                                                                                                                                                                                            
  - Cart with 2 collections → 2 separate orders created                                                                                                                                                  
  - Each order has correct ship dates from its collection                                                                                                                                                
  - Validation enforces "not earlier than collection window"                                                                                                                                             
                                                                                                                                                                                                         
  What looks wrong (fixed in Phase 2):                                                                                                                                                                   
  - Modal may say wrong things about shipments                                                                                                                                                           
  - Multi-shipment UI cards still visible (but ignored)                                                                                                                                                  
  - Admin/rep tables show shipment counts that don't mean anything                                                                                                                                       
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Ready for me to proceed with Phase 1 implementation?                                                                                                                                                   
                                                                                                                                                                                                         
❯ From Codex engineering expert to help harden the plan for phase 1 - write the plan for phase 1 after considering carefully - Here are the exact “replace this block with that block” snippets from     
   commit 8d9f99a, organized by your Phase 1 files. I’ve included precise anchor instructions so                                                                                                         
    you can drop them in without guesswork (still read‑only).                                                                                                                                            
                                                                                                                                                                                                         
    1) src/lib/data/actions/orders.ts — createOrder() core logic                                                                                                                                         
    Replace the block inside createOrder() that starts at the comment:                                                                                                                                   
    // Derive order type from SKU data (master source: Collection.type)                                                                                                                                  
    and ends at the return { success: true, ... } in that function.                                                                                                                                      
                                                                                                                                                                                                         
    Replace with this block from 8d9f99a:                                                                                                                                                                
                                                                                                                                                                                                         
    // Derive order type from SKU data (master source: SkuCategories.IsPreOrder)                                                                                                                         
    const skuVariantIds = data.items.map((item) => BigInt(item.skuVariantId))                                                                                                                            
    const skuPreOrderMap = await deriveIsPreOrderFromSkus(skuVariantIds)                                                                                                                                 
                                                                                                                                                                                                         
    // Group items by order type AND ship window (auto-split mixed ATS/Pre-Order)                                                                                                                        
    const itemGroups = new Map<string, typeof data.items>()                                                                                                                                              
    for (const item of data.items) {                                                                                                                                                                     
      const key = getOrderGroupKey(item, skuPreOrderMap)                                                                                                                                                 
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    // Track created orders                                                                                                                                                                              
    const createdOrders: Array<{                                                                                                                                                                         
      orderId: string                                                                                                                                                                                    
      orderNumber: string                                                                                                                                                                                
      categoryName: string | null                                                                                                                                                                        
      shipWindowStart: string | null                                                                                                                                                                     
      shipWindowEnd: string | null                                                                                                                                                                       
      orderAmount: number                                                                                                                                                                                
      items: typeof data.items                                                                                                                                                                           
    }> = []                                                                                                                                                                                              
                                                                                                                                                                                                         
    // Create orders in a single transaction for atomicity                                                                                                                                               
    await prisma.$transaction(async (tx) => {                                                                                                                                                            
      // Look up rep by ID - fail if not found                                                                                                                                                           
      const rep = await tx.reps.findUnique({                                                                                                                                                             
        where: { ID: parseInt(data.salesRepId) },                                                                                                                                                        
        select: { Name: true, Code: true },                                                                                                                                                              
      })                                                                                                                                                                                                 
      if (!rep) {                                                                                                                                                                                        
        throw new Error('Invalid sales rep')                                                                                                                                                             
      }                                                                                                                                                                                                  
      const salesRepName = rep.Name ?? ''                                                                                                                                                                
      const salesRepCode = rep.Code?.trim() || rep.Name || ''                                                                                                                                            
                                                                                                                                                                                                         
      // Determine customerId for strong ownership                                                                                                                                                       
      let customerId: number | null = data.customerId ?? null                                                                                                                                            
      if (!customerId) {                                                                                                                                                                                 
        const existingByName = await tx.customers.findFirst({                                                                                                                                            
          where: { StoreName: data.storeName },                                                                                                                                                          
          select: { ID: true },                                                                                                                                                                          
        })                                                                                                                                                                                               
        if (existingByName) {                                                                                                                                                                            
          customerId = existingByName.ID                                                                                                                                                                 
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // Create one order per ship window group (and order type)                                                                                                                                         
      for (const [groupKey, groupItems] of itemGroups) {                                                                                                                                                 
        // Determine order type from first item's SKU (all items in group have same type)                                                                                                                
        const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                                    
        const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                               
                                                                                                                                                                                                         
        // Generate order number with appropriate prefix                                                                                                                                                 
        const orderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                         
                                                                                                                                                                                                         
        // Calculate group total                                                                                                                                                                         
        const orderAmount = groupItems.reduce(                                                                                                                                                           
          (sum, item) => sum + item.price * item.quantity,                                                                                                                                               
          0                                                                                                                                                                                              
        )                                                                                                                                                                                                
                                                                                                                                                                                                         
        // Use item's ship window if available, else form dates                                                                                                                                          
        const firstItem = groupItems[0]                                                                                                                                                                  
        const shipStart = firstItem.shipWindowStart                                                                                                                                                      
          ? new Date(firstItem.shipWindowStart)                                                                                                                                                          
          : new Date(data.shipStartDate)                                                                                                                                                                 
        const shipEnd = firstItem.shipWindowEnd                                                                                                                                                          
          ? new Date(firstItem.shipWindowEnd)                                                                                                                                                            
          : new Date(data.shipEndDate)                                                                                                                                                                   
                                                                                                                                                                                                         
        // Create order header                                                                                                                                                                           
        const newOrder = await tx.customerOrders.create({                                                                                                                                                
          data: {                                                                                                                                                                                        
            OrderNumber: orderNumber,                                                                                                                                                                    
            BuyerName: data.buyerName,                                                                                                                                                                   
            StoreName: data.storeName,                                                                                                                                                                   
            SalesRep: salesRepName,                                                                                                                                                                      
            CustomerEmail: data.customerEmail,                                                                                                                                                           
            CustomerPhone: data.customerPhone,                                                                                                                                                           
            Country: data.currency, // Legacy: stores currency, not country                                                                                                                              
            OrderAmount: orderAmount,                                                                                                                                                                    
            OrderNotes: data.orderNotes ?? '',                                                                                                                                                           
            CustomerPO: data.customerPO ?? '',                                                                                                                                                           
            ShipStartDate: shipStart,                                                                                                                                                                    
            ShipEndDate: shipEnd,                                                                                                                                                                        
            OrderDate: new Date(),                                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            IsShipped: false,                                                                                                                                                                            
            OrderStatus: 'Pending',                                                                                                                                                                      
            IsTransferredToShopify: false,                                                                                                                                                               
            IsPreOrder: isPreOrder, // Derived from SKU category, not client input                                                                                                                       
            RepID: parseInt(data.salesRepId),                                                                                                                                                            
            CustomerID: customerId,                                                                                                                                                                      
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        // Create line items for this group                                                                                                                                                              
        await tx.customerOrdersItems.createMany({                                                                                                                                                        
          data: groupItems.map((item) => ({                                                                                                                                                              
            CustomerOrderID: newOrder.ID,                                                                                                                                                                
            OrderNumber: orderNumber,                                                                                                                                                                    
            SKU: item.sku,                                                                                                                                                                               
            SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                                     
            Quantity: item.quantity,                                                                                                                                                                     
            Price: item.price,                                                                                                                                                                           
            PriceCurrency: data.currency,                                                                                                                                                                
            Notes: '',                                                                                                                                                                                   
          })),                                                                                                                                                                                           
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        createdOrders.push({                                                                                                                                                                             
          orderId: newOrder.ID.toString(),                                                                                                                                                               
          orderNumber,                                                                                                                                                                                   
          categoryName: firstItem.categoryName ?? null,                                                                                                                                                  
          shipWindowStart: firstItem.shipWindowStart ?? null,                                                                                                                                            
          shipWindowEnd: firstItem.shipWindowEnd ?? null,                                                                                                                                                
          orderAmount,                                                                                                                                                                                   
          items: groupItems,                                                                                                                                                                             
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // Find or create customer (only once, not per order)                                                                                                                                              
      const existingCustomer = await tx.customers.findFirst({                                                                                                                                            
        where: { StoreName: data.storeName },                                                                                                                                                            
        select: { ID: true, OrderCount: true },                                                                                                                                                          
      })                                                                                                                                                                                                 
                                                                                                                                                                                                         
      if (existingCustomer) {                                                                                                                                                                            
        await tx.customers.update({                                                                                                                                                                      
          where: { ID: existingCustomer.ID },                                                                                                                                                            
          data: {                                                                                                                                                                                        
            CustomerName: data.buyerName,                                                                                                                                                                
            Email: data.customerEmail,                                                                                                                                                                   
            Phone: data.customerPhone,                                                                                                                                                                   
            Rep: salesRepCode,                                                                                                                                                                           
            Street1: data.street1,                                                                                                                                                                       
            Street2: data.street2 ?? '',                                                                                                                                                                 
            City: data.city,                                                                                                                                                                             
            StateProvince: data.stateProvince,                                                                                                                                                           
            ZipPostal: data.zipPostal,                                                                                                                                                                   
            Country: data.country,                                                                                                                                                                       
            ShippingStreet1: data.shippingStreet1,                                                                                                                                                       
            ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                                 
            ShippingCity: data.shippingCity,                                                                                                                                                             
            ShippingStateProvince: data.shippingStateProvince,                                                                                                                                           
            ShippingZipPostal: data.shippingZipPostal,                                                                                                                                                   
            ShippingCountry: data.shippingCountry,                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            LastOrderDate: new Date(),                                                                                                                                                                   
            OrderCount: (existingCustomer.OrderCount ?? 0) + createdOrders.length,                                                                                                                       
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
      } else {                                                                                                                                                                                           
        // Create new customer and update all orders with CustomerID                                                                                                                                     
        const newCustomer = await tx.customers.create({                                                                                                                                                  
          data: {                                                                                                                                                                                        
            StoreName: data.storeName,                                                                                                                                                                   
            CustomerName: data.buyerName,                                                                                                                                                                
            Email: data.customerEmail,                                                                                                                                                                   
            Phone: data.customerPhone,                                                                                                                                                                   
            Rep: salesRepCode,                                                                                                                                                                           
            Street1: data.street1,                                                                                                                                                                       
            Street2: data.street2 ?? '',                                                                                                                                                                 
            City: data.city,                                                                                                                                                                             
            StateProvince: data.stateProvince,                                                                                                                                                           
            ZipPostal: data.zipPostal,                                                                                                                                                                   
            Country: data.country,                                                                                                                                                                       
            ShippingStreet1: data.shippingStreet1,                                                                                                                                                       
            ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                                 
            ShippingCity: data.shippingCity,                                                                                                                                                             
            ShippingStateProvince: data.shippingStateProvince,                                                                                                                                           
            ShippingZipPostal: data.shippingZipPostal,                                                                                                                                                   
            ShippingCountry: data.shippingCountry,                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            FirstOrderDate: new Date(),                                                                                                                                                                  
            LastOrderDate: new Date(),                                                                                                                                                                   
            OrderCount: createdOrders.length,                                                                                                                                                            
          },                                                                                                                                                                                             
          select: { ID: true },                                                                                                                                                                          
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        // Update all created orders with new customer's ID                                                                                                                                              
        for (const order of createdOrders) {                                                                                                                                                             
          await tx.customerOrders.update({                                                                                                                                                               
            where: { ID: BigInt(order.orderId) },                                                                                                                                                        
            data: { CustomerID: newCustomer.ID },                                                                                                                                                        
          })                                                                                                                                                                                             
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    // Send order confirmation emails (non-blocking) unless skipEmail is set                                                                                                                             
    // When skipEmail is true, emails are sent via the confirmation popup instead                                                                                                                        
    if (!data.skipEmail) {                                                                                                                                                                               
      // Send email for each created order                                                                                                                                                               
      for (const order of createdOrders) {                                                                                                                                                               
        sendOrderEmails({                                                                                                                                                                                
          orderId: order.orderId,                                                                                                                                                                        
          orderNumber: order.orderNumber,                                                                                                                                                                
          storeName: data.storeName,                                                                                                                                                                     
          buyerName: data.buyerName,                                                                                                                                                                     
          customerEmail: data.customerEmail,                                                                                                                                                             
          customerPhone: data.customerPhone,                                                                                                                                                             
          salesRep: data.storeName, // Will be looked up by email service                                                                                                                                
          orderAmount: order.orderAmount,                                                                                                                                                                
          currency: data.currency,                                                                                                                                                                       
          shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(data.shipStartDate),                                                                                         
          shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(data.shipEndDate),                                                                                                 
          orderDate: new Date(),                                                                                                                                                                         
          orderNotes: data.orderNotes,                                                                                                                                                                   
          customerPO: data.customerPO,                                                                                                                                                                   
          items: order.items.map((item) => ({                                                                                                                                                            
            sku: item.sku,                                                                                                                                                                               
            quantity: item.quantity,                                                                                                                                                                     
            price: item.price,                                                                                                                                                                           
            lineTotal: item.price * item.quantity,                                                                                                                                                       
          })),                                                                                                                                                                                           
        }).catch((err) => {                                                                                                                                                                              
          console.error(`Order email error for ${order.orderNumber}:`, err)                                                                                                                              
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    revalidatePath('/admin/orders')                                                                                                                                                                      
                                                                                                                                                                                                         
    // Return first order for backwards compatibility, plus full orders array                                                                                                                            
    const primaryOrder = createdOrders[0]                                                                                                                                                                
    return {                                                                                                                                                                                             
      success: true,                                                                                                                                                                                     
      orderId: primaryOrder?.orderId,                                                                                                                                                                    
      orderNumber: primaryOrder?.orderNumber,                                                                                                                                                            
      orders: createdOrders.map((o) => ({                                                                                                                                                                
        orderId: o.orderId,                                                                                                                                                                              
        orderNumber: o.orderNumber,                                                                                                                                                                      
        categoryName: o.categoryName,                                                                                                                                                                    
        shipWindowStart: o.shipWindowStart,                                                                                                                                                              
        shipWindowEnd: o.shipWindowEnd,                                                                                                                                                                  
      })),                                                                                                                                                                                               
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    Note: this block uses getOrderGroupKey and category* fields as in 8d9f99a. If you’re keeping Collection as canonical, swap category* → collection* and call                                          
    _getOrderGroupKey.                                                                                                                                                                                   
                                                                                                                                                                                                         
    ———                                                                                                                                                                                                  
                                                                                                                                                                                                         
    2) src/app/api/drafts/[id]/submit/route.ts — grouping + split creation                                                                                                                               
    Replace the block that starts at:                                                                                                                                                                    
    // Phase 9: Use planned shipments instead of splitting orders                                                                                                                                        
    and ends at the JSON response (current single‑order path).                                                                                                                                           
                                                                                                                                                                                                         
    Replace with this block from 8d9f99a:                                                                                                                                                                
                                                                                                                                                                                                         
    // Group items by order type AND ship window (auto-split mixed ATS/Pre-Order)                                                                                                                        
    const itemGroups = new Map<string, typeof items>()                                                                                                                                                   
    for (const item of items) {                                                                                                                                                                          
      const key = getOrderGroupKey(item, skuPreOrderMap)                                                                                                                                                 
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    const currency = formData.currency || 'CAD'                                                                                                                                                          
                                                                                                                                                                                                         
    // Track created orders                                                                                                                                                                              
    const createdOrders: Array<{                                                                                                                                                                         
      orderId: string                                                                                                                                                                                    
      orderNumber: string                                                                                                                                                                                
      categoryName: string | null                                                                                                                                                                        
      shipWindowStart: string | null                                                                                                                                                                     
      shipWindowEnd: string | null                                                                                                                                                                       
      orderAmount: number                                                                                                                                                                                
      items: typeof items                                                                                                                                                                                
    }> = []                                                                                                                                                                                              
                                                                                                                                                                                                         
    await prisma.$transaction(async (tx) => {                                                                                                                                                            
      // Delete the draft first (we'll create new orders)                                                                                                                                                
      await tx.customerOrdersItems.deleteMany({                                                                                                                                                          
        where: { CustomerOrderID: draft.ID },                                                                                                                                                            
      })                                                                                                                                                                                                 
      await tx.customerOrders.delete({                                                                                                                                                                   
        where: { ID: draft.ID },                                                                                                                                                                         
      })                                                                                                                                                                                                 
                                                                                                                                                                                                         
      // Create one order per ship window group (and order type)                                                                                                                                         
      for (const [, groupItems] of itemGroups) {                                                                                                                                                         
        // Derive order type from first item's SKU (all items in group have same type)                                                                                                                   
        const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                                    
        const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                               
        const groupOrderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                    
        const groupAmount = groupItems.reduce((sum, item) => sum + item.price * item.quantity, 0)                                                                                                        
                                                                                                                                                                                                         
        // Use item's ship window if available, else form dates                                                                                                                                          
        const firstItem = groupItems[0]                                                                                                                                                                  
        const shipStart = firstItem.shipWindowStart                                                                                                                                                      
          ? new Date(firstItem.shipWindowStart)                                                                                                                                                          
          : new Date(formData.shipStartDate)                                                                                                                                                             
        const shipEnd = firstItem.shipWindowEnd                                                                                                                                                          
          ? new Date(firstItem.shipWindowEnd)                                                                                                                                                            
          : new Date(formData.shipEndDate)                                                                                                                                                               
                                                                                                                                                                                                         
        // Create order header                                                                                                                                                                           
        const newOrder = await tx.customerOrders.create({                                                                                                                                                
          data: {                                                                                                                                                                                        
            OrderNumber: groupOrderNumber,                                                                                                                                                               
            OrderStatus: 'Pending',                                                                                                                                                                      
            BuyerName: formData.buyerName,                                                                                                                                                               
            StoreName: formData.storeName,                                                                                                                                                               
            SalesRep: salesRepName,                                                                                                                                                                      
            CustomerEmail: formData.customerEmail,                                                                                                                                                       
            CustomerPhone: formData.customerPhone,                                                                                                                                                       
            Country: currency,                                                                                                                                                                           
            OrderAmount: groupAmount,                                                                                                                                                                    
            OrderNotes: formData.orderNotes || '',                                                                                                                                                       
            CustomerPO: formData.customerPO || '',                                                                                                                                                       
            ShipStartDate: shipStart,                                                                                                                                                                    
            ShipEndDate: shipEnd,                                                                                                                                                                        
            OrderDate: new Date(),                                                                                                                                                                       
            Website: formData.website || '',                                                                                                                                                             
            IsShipped: false,                                                                                                                                                                            
            IsTransferredToShopify: false,                                                                                                                                                               
            IsPreOrder: isPreOrder, // Derived from SKU category, not preOrderMeta                                                                                                                       
            RepID: parseInt(formData.salesRepId),                                                                                                                                                        
            CustomerID: customerId,                                                                                                                                                                      
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        // Create order items for this group                                                                                                                                                             
        await tx.customerOrdersItems.createMany({                                                                                                                                                        
          data: groupItems.map(item => ({                                                                                                                                                                
            CustomerOrderID: newOrder.ID,                                                                                                                                                                
            OrderNumber: groupOrderNumber,                                                                                                                                                               
            SKU: item.sku,                                                                                                                                                                               
            SKUVariantID: item.skuVariantId,                                                                                                                                                             
            Quantity: item.quantity,                                                                                                                                                                     
            Price: item.price,                                                                                                                                                                           
            PriceCurrency: currency,                                                                                                                                                                     
            Notes: '',                                                                                                                                                                                   
          })),                                                                                                                                                                                           
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        createdOrders.push({                                                                                                                                                                             
          orderId: String(newOrder.ID),                                                                                                                                                                  
          orderNumber: groupOrderNumber,                                                                                                                                                                 
          categoryName: firstItem.categoryName,                                                                                                                                                          
          shipWindowStart: firstItem.shipWindowStart,                                                                                                                                                    
          shipWindowEnd: firstItem.shipWindowEnd,                                                                                                                                                        
          orderAmount: groupAmount,                                                                                                                                                                      
          items: groupItems,                                                                                                                                                                             
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    // Send confirmation emails for each created order (non-blocking)                                                                                                                                    
    for (const order of createdOrders) {                                                                                                                                                                 
      sendOrderEmails({                                                                                                                                                                                  
        orderId: order.orderId,                                                                                                                                                                          
        orderNumber: order.orderNumber,                                                                                                                                                                  
        storeName: formData.storeName,                                                                                                                                                                   
        buyerName: formData.buyerName,                                                                                                                                                                   
        salesRep: salesRepName,                                                                                                                                                                          
        customerEmail: formData.customerEmail,                                                                                                                                                           
        customerPhone: formData.customerPhone,                                                                                                                                                           
        shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(formData.shipStartDate),                                                                                       
        shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(formData.shipEndDate),                                                                                               
        orderDate: new Date(),                                                                                                                                                                           
        orderNotes: formData.orderNotes,                                                                                                                                                                 
        customerPO: formData.customerPO,                                                                                                                                                                 
        items: order.items.map(i => ({                                                                                                                                                                   
          sku: i.sku,                                                                                                                                                                                    
          quantity: i.quantity,                                                                                                                                                                          
          price: i.price,                                                                                                                                                                                
          lineTotal: i.price * i.quantity,                                                                                                                                                               
        })),                                                                                                                                                                                             
        currency,                                                                                                                                                                                        
        orderAmount: order.orderAmount,                                                                                                                                                                  
      }).catch(err => {                                                                                                                                                                                  
        console.error(`Failed to send order emails for ${order.orderNumber}:`, err)                                                                                                                      
      })                                                                                                                                                                                                 
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    // Return first order for backwards compatibility, plus full orders array                                                                                                                            
    const primaryOrder = createdOrders[0]                                                                                                                                                                
    return NextResponse.json({                                                                                                                                                                           
      success: true,                                                                                                                                                                                     
      orderId: primaryOrder?.orderId,                                                                                                                                                                    
      orderNumber: primaryOrder?.orderNumber,                                                                                                                                                            
      orders: createdOrders.map(o => ({                                                                                                                                                                  
        orderId: o.orderId,                                                                                                                                                                              
        orderNumber: o.orderNumber,                                                                                                                                                                      
        categoryName: o.categoryName,                                                                                                                                                                    
        shipWindowStart: o.shipWindowStart,                                                                                                                                                              
        shipWindowEnd: o.shipWindowEnd,                                                                                                                                                                  
      })),                                                                                                                                                                                               
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    Also restore the getOrderGroupKey() helper in this file (it was removed). Use the exact 8d9f99a version if needed.                                                                                   
                                                                                                                                                                                                         
    ———                                                                                                                                                                                                  
                                                                                                                                                                                                         
    3) src/lib/schemas/order.ts — remove plannedShipments                                                                                                                                                
    Replace the current orderItemSchema + createOrderInputSchema (the parts that include plannedShipments) with the 8d9f99a versions below.                                                              
                                                                                                                                                                                                         
    /**                                                                                                                                                                                                  
     * Schema for cart items passed to createOrder                                                                                                                                                       
     * Includes ship window metadata for order splitting by delivery date                                                                                                                                
     */                                                                                                                                                                                                  
    export const orderItemSchema = z.object({                                                                                                                                                            
      sku: z.string().min(1),                                                                                                                                                                            
      skuVariantId: z.union([z.bigint(), z.number()]),                                                                                                                                                   
      quantity: z.number().int().positive(),                                                                                                                                                             
      price: z.number().nonnegative(),                                                                                                                                                                   
      // Ship window grouping fields (for splitting orders by delivery date)                                                                                                                             
      categoryId: z.number().nullable().optional(),                                                                                                                                                      
      categoryName: z.string().nullable().optional(),                                                                                                                                                    
      shipWindowStart: z.string().nullable().optional(),                                                                                                                                                 
      shipWindowEnd: z.string().nullable().optional(),                                                                                                                                                   
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    export type OrderItem = z.infer<typeof orderItemSchema>                                                                                                                                              
                                                                                                                                                                                                         
    /**                                                                                                                                                                                                  
     * Full order creation input schema                                                                                                                                                                  
     */                                                                                                                                                                                                  
    export const createOrderInputSchema = orderFormSchema.extend({                                                                                                                                       
      currency: z.enum(['USD', 'CAD']),                                                                                                                                                                  
      items: z.array(orderItemSchema).min(1, 'Order must have at least one item'),                                                                                                                       
      // isPreOrder is now derived from SKU data on the server.                                                                                                                                          
      // Kept optional for backwards compatibility but ignored by server.                                                                                                                                
      isPreOrder: z.boolean().optional(),                                                                                                                                                                
      // Optional customer ID for existing customer - enables strong ownership on order                                                                                                                  
      // Nullable to handle client state sending null for new stores                                                                                                                                     
      customerId: z.number().int().positive().nullable().optional(),                                                                                                                                     
      // Skip automatic email sending - emails will be sent via confirmation popup                                                                                                                       
      skipEmail: z.boolean().optional(),                                                                                                                                                                 
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    ———                                                                                                                                                                                                  
                                                                                                                                                                                                         
    4) src/lib/types/order.ts — CreateOrderResult + UpdateOrderInput                                                                                                                                     
    Replace the current CreateOrderResult and UpdateOrderInput blocks with the 8d9f99a definitions below.                                                                                                
                                                                                                                                                                                                         
    /**                                                                                                                                                                                                  
     * Result shape from createOrder action.                                                                                                                                                             
     * Supports single order (backwards compat) or multiple orders (when split by ship window).                                                                                                          
     */                                                                                                                                                                                                  
    export interface CreateOrderResult {                                                                                                                                                                 
      success: boolean                                                                                                                                                                                   
      // Single order (backwards compat - primary order when split)                                                                                                                                      
      orderId?: string                                                                                                                                                                                   
      orderNumber?: string                                                                                                                                                                               
      // Multiple orders (when split by ship window)                                                                                                                                                     
      orders?: Array<{                                                                                                                                                                                   
        orderId: string                                                                                                                                                                                  
        orderNumber: string                                                                                                                                                                              
        categoryName: string | null                                                                                                                                                                      
        shipWindowStart: string | null                                                                                                                                                                   
        shipWindowEnd: string | null                                                                                                                                                                     
      }>                                                                                                                                                                                                 
      error?: string                                                                                                                                                                                     
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    /**                                                                                                                                                                                                  
     * Input for updating an existing order.                                                                                                                                                             
     */                                                                                                                                                                                                  
    export interface UpdateOrderInput {                                                                                                                                                                  
      orderId: string                                                                                                                                                                                    
      storeName: string                                                                                                                                                                                  
      buyerName: string                                                                                                                                                                                  
      salesRepId: string                                                                                                                                                                                 
      customerEmail: string                                                                                                                                                                              
      customerPhone: string                                                                                                                                                                              
      currency: 'USD' | 'CAD'                                                                                                                                                                            
      shipStartDate: string                                                                                                                                                                              
      shipEndDate: string                                                                                                                                                                                
      orderNotes?: string                                                                                                                                                                                
      customerPO?: string                                                                                                                                                                                
      website?: string                                                                                                                                                                                   
      items: Array<{                                                                                                                                                                                     
        sku: string                                                                                                                                                                                      
        skuVariantId: number                                                                                                                                                                             
        quantity: number                                                                                                                                                                                 
        price: number                                                                                                                                                                                    
      }>                                                                                                                                                                                                 
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    ———                                                                                                                                                                                                  
                                                                                                                                                                                                         
    5) src/components/buyer/order-form.tsx — createOrder call + remove shipment validation block                                                                                                         
    Two targeted swaps here:                                                                                                                                                                             
                                                                                                                                                                                                         
    A) Remove the shipment validation guard                                                                                                                                                              
    Replace the start of onSubmit with the 8d9f99a version (removes the planned‑shipment validation gate):                                                                                               
                                                                                                                                                                                                         
    const onSubmit = async (data: OrderFormData) => {                                                                                                                                                    
      if (isSubmitting) return // Prevent double-click                                                                                                                                                   
      setIsSubmitting(true)                                                                                                                                                                              
                                                                                                                                                                                                         
    B) Replace the createOrder payload block                                                                                                                                                             
    Replace the current createOrder call (the block that builds finalPlannedShipments, legacyDates, and passes plannedShipments) with this 8d9f99a call:                                                 
                                                                                                                                                                                                         
    // Create new order with customerId for strong ownership                                                                                                                                             
    // Skip automatic email - show confirmation popup instead                                                                                                                                            
    // Includes ship window metadata for order splitting by delivery date                                                                                                                                
    const result = await createOrder({                                                                                                                                                                   
      ...data,                                                                                                                                                                                           
      currency,                                                                                                                                                                                          
      items: cartItems.map((item) => ({                                                                                                                                                                  
        sku: item.sku,                                                                                                                                                                                   
        skuVariantId: item.skuVariantId,                                                                                                                                                                 
        quantity: item.quantity,                                                                                                                                                                         
        price: item.price,                                                                                                                                                                               
        categoryId: item.categoryId,                                                                                                                                                                     
        categoryName: item.categoryName,                                                                                                                                                                 
        shipWindowStart: item.shipWindowStart,                                                                                                                                                           
        shipWindowEnd: item.shipWindowEnd,                                                                                                                                                               
      })),                                                                                                                                                                                               
      isPreOrder, // P prefix for pre-orders, A prefix for ATS                                                                                                                                           
      customerId: selectedCustomerId, // Pass selected customer ID for strong ownership                                                                                                                  
      skipEmail: true, // Emails will be sent via confirmation popup                                                                                                                                     
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
   +  This looks solid and internally consistent. Two small clarifications/additions to make Phase 1 safer:                                                                                              
                                                                                                                                                                                                         
    - In both createOrder() and draft submit, increment Customer.OrderCount by the number of created orders, not by 1. (This was part of the legacy split‑order path.)                                   
    - Keep per‑group ship‑window validation aligned to the same source you choose for grouping (Collection). If a collection window is missing, decide up front whether                                  
      to block or allow; right now the planned‑shipment path blocks unless override.                                                                                                                     
                                                                                                                                                                                                         
    Otherwise I agree with your checklist as‑is, including the decision table (Collection is the canonical source for both ship windows and pre‑order detection). If you                                 
    want, I can turn each Phase 1 item into exact “replace this block with that block” snippets from 8d9f99a (still read‑only).                                                                          
                                                                                                                                                                                                         
  • Model changed to gpt-5.2-codex xhigh                                                                                                                                                                 
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › Yes, turn each Phase 1 item into exact “replace this block with that block” snippets from 8d9f99a  - also tell me how you can implement this plan on one branch or another, thanks                   
                                                                                                                                                                                                         
⏺ Phase 1 Implementation Plan                                                                                                                                                                            
                                                                                                                                                                                                         
  Based on the Codex expert's detailed snippets and guidance, here's the consolidated plan:                                                                                                              
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Pre-Implementation Decisions (Confirmed)                                                                                                                                                               
  ┌───────────────────────────┬────────────────────────────────────────────┬────────────────────────────────────┐                                                                                        
  │         Decision          │                   Choice                   │             Rationale              │                                                                                        
  ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                        
  │ Ship window source        │ Collection (shipWindowStart/shipWindowEnd) │ Now canonical in prod              │                                                                                        
  ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                        
  │ PreOrder detection        │ Collection.type                            │ Consistent with current data model │                                                                                        
  ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                        
  │ Missing collection window │ Allow with form dates                      │ Matches legacy behavior            │                                                                                        
  ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                        
  │ Field naming              │ Use collection* not category*              │ Align with current schema          │                                                                                        
  └───────────────────────────┴────────────────────────────────────────────┴────────────────────────────────────┘                                                                                        
  ---                                                                                                                                                                                                    
  Files to Change (5 files)                                                                                                                                                                              
  ┌─────┬─────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────┐                                                                
  │  #  │                  File                   │                                       Changes                                       │                                                                
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────┤                                                                
  │ 1   │ src/lib/data/actions/orders.ts          │ Replace createOrder() core - restore grouping loop, remove PlannedShipment creation │                                                                
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────┤                                                                
  │ 2   │ src/app/api/drafts/[id]/submit/route.ts │ Replace submit logic - restore grouping, remove PlannedShipment                     │                                                                
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────┤                                                                
  │ 3   │ src/lib/schemas/order.ts                │ Remove plannedShipments from input schema                                           │                                                                
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────┤                                                                
  │ 4   │ src/lib/types/order.ts                  │ Restore orders[] return type, remove plannedShipmentCount                           │                                                                
  ├─────┼─────────────────────────────────────────┼─────────────────────────────────────────────────────────────────────────────────────┤                                                                
  │ 5   │ src/components/buyer/order-form.tsx     │ Remove shipment validation block, simplify createOrder call                         │                                                                
  └─────┴─────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────┘                                                                
  ---                                                                                                                                                                                                    
  Adaptations from 8d9f99a Snippets                                                                                                                                                                      
                                                                                                                                                                                                         
  The Codex snippets use category* fields. We need to adapt:                                                                                                                                             
  ┌──────────────────────────┬──────────────────────────────────────┐                                                                                                                                    
  │      8d9f99a (old)       │            Current (keep)            │                                                                                                                                    
  ├──────────────────────────┼──────────────────────────────────────┤                                                                                                                                    
  │ categoryId               │ collectionId                         │                                                                                                                                    
  ├──────────────────────────┼──────────────────────────────────────┤                                                                                                                                    
  │ categoryName             │ collectionName                       │                                                                                                                                    
  ├──────────────────────────┼──────────────────────────────────────┤                                                                                                                                    
  │ getOrderGroupKey()       │ _getOrderGroupKey() (already exists) │                                                                                                                                    
  ├──────────────────────────┼──────────────────────────────────────┤                                                                                                                                    
  │ SkuCategories.IsPreOrder │ Collection.type === 'PreOrder'       │                                                                                                                                    
  └──────────────────────────┴──────────────────────────────────────┘                                                                                                                                    
  ---                                                                                                                                                                                                    
  Key Implementation Notes                                                                                                                                                                               
                                                                                                                                                                                                         
  1. Customer.OrderCount - Increment by createdOrders.length, not 1                                                                                                                                      
  2. Ship window validation - Keep validation per-group using Collection windows                                                                                                                         
  3. PlannedShipmentID - Don't populate (leave null), column stays in DB                                                                                                                                 
  4. Email sending - Send per created order (loop), not once                                                                                                                                             
  5. Return shape - { orderId, orderNumber, orders: [...] } for backwards compat                                                                                                                         
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Verification After Phase 1                                                                                                                                                                             
                                                                                                                                                                                                         
  npm run type-check   # No type errors                                                                                                                                                                  
  npm run lint         # No lint errors                                                                                                                                                                  
  npm run build        # Builds successfully                                                                                                                                                             
                                                                                                                                                                                                         
  Manual test:                                                                                                                                                                                           
  1. Add items from 2 different collections to cart                                                                                                                                                      
  2. Submit order                                                                                                                                                                                        
  3. Verify 2 separate orders created (different order numbers)                                                                                                                                          
  4. Each order has correct ship dates from its collection                                                                                                                                               
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Branch Strategy                                                                                                                                                                                        
                                                                                                                                                                                                         
  I'll implement on the current branch (fix/export-triggeredby) or create a new branch if you prefer. Options:                                                                                           
  ┌────────┬──────────────────────┬─────────────────────────────────────────────────────────────────┐                                                                                                    
  │ Option │     Branch Name      │                            Approach                             │                                                                                                    
  ├────────┼──────────────────────┼─────────────────────────────────────────────────────────────────┤                                                                                                    
  │ A      │ Current branch       │ Continue on fix/export-triggeredby, commit Phase 1 changes      │                                                                                                    
  ├────────┼──────────────────────┼─────────────────────────────────────────────────────────────────┤                                                                                                    
  │ B      │ New branch           │ Create fix/revert-planned-shipments from current HEAD           │                                                                                                    
  ├────────┼──────────────────────┼─────────────────────────────────────────────────────────────────┤                                                                                                    
  │ C      │ New branch from main │ Create fix/revert-planned-shipments from main (cleaner history) │                                                                                                    
  └────────┴──────────────────────┴─────────────────────────────────────────────────────────────────┘                                                                                                    
  Recommendation: Option B - new branch fix/revert-planned-shipments from current HEAD, so you can review the revert separately.                                                                         
                                                                                                                                                                                                         
  ---                                                                                                                                                                                                    
  Ready to proceed? Let me know:                                                                                                                                                                         
  1. Which branch strategy (A, B, or C)?                                                                                                                                                                 
  2. Any other concerns before I start implementation?                                                                                                                                                   
                                                                                                                                                                                                         
❯ Good catch on: The Codex snippets use category* fields: I don't understand what this means: same snippets re‑expressed with Collection‑based fields instead of category*, I can generate a second      
  set that’s still “exact                                                                                                                                                                                
    replacements,” but                                                                                                                                                                                   
      aligned to your canonical‑Collection decision - di you just present something that is NOT aligned with the canonical‑Collection decision ?                                                         
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • Good catch — you’re right to question that.                                                                                                                                                          
                                                                                                                                                                                                         
    What I gave you were verbatim snippets from commit 8d9f99a, which used category‑based fields (categoryId, categoryName, shipWindowStart/End sourced from                                             
    SkuCategories). That is not aligned with your current canonical decision (Collection).                                                                                                               
                                                                                                                                                                                                         
    So yes: the snippets I pasted are exact pre‑PlannedShipment code, but not aligned with the “Collection is canonical” decision. That’s why I offered to re‑express                                    
    them.                                                                                                                                                                                                
                                                                                                                                                                                                         
    If you want, I’ll now provide the same blocks, but rewritten to use Collection‑based fields (still following the legacy split‑order flow), so they’re consistent with                                
    the decision table.                                                                                                                                                                                  
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › provide the same blocks, but rewritten to use Collection‑based fields (still following the legacy split‑order flow), so they’re consistent with                                                      
      the decision table.                                                                                                                                                                                
   + use everything you can here that can help sharpen the plan/implementation: ere’s the companion update for src/components/buyer/order-form.tsx to align with the orders[] array                      
  (collection‑based split orders). This is read‑only guidance.                                                                                                                                           
                                                                                                                                                                                                         
    Replace the block that starts:                                                                                                                                                                       
    if (result.success && result.orders?.length) {                                                                                                                                                       
    and ends at the final else { ... } in the createOrder branch with the snippet below.                                                                                                                 
                                                                                                                                                                                                         
    if (result.success && result.orders?.length) {                                                                                                                                                       
      // Store order summaries for the modal (orders[] is the canonical return)                                                                                                                          
      setSubmittedShipments(result.orders.map((o) => ({                                                                                                                                                  
        orderId: o.orderId,                                                                                                                                                                              
        orderNumber: o.orderNumber,                                                                                                                                                                      
        collectionName: o.collectionName,                                                                                                                                                                
        shipWindowStart: o.shipWindowStart,                                                                                                                                                              
        shipWindowEnd: o.shipWindowEnd,                                                                                                                                                                  
        orderAmount: o.orderAmount ?? orderTotal,                                                                                                                                                        
      })))                                                                                                                                                                                               
                                                                                                                                                                                                         
      // NOTE: Do NOT call clearDraft() here - it empties the cart and triggers redirect                                                                                                                 
      // clearDraft() is called in handleEmailConfirm/handleEmailSkip after modal interaction                                                                                                            
                                                                                                                                                                                                         
      setShowEmailModal(true)                                                                                                                                                                            
    } else if (result.success && result.orderId) {                                                                                                                                                       
      // Backwards compatibility: single order without orders array                                                                                                                                      
      setSubmittedShipments([{                                                                                                                                                                           
        orderId: result.orderId,                                                                                                                                                                         
        orderNumber: result.orderNumber || '',                                                                                                                                                           
        collectionName: null,                                                                                                                                                                            
        shipWindowStart: null,                                                                                                                                                                           
        shipWindowEnd: null,                                                                                                                                                                             
        orderAmount: orderTotal,                                                                                                                                                                         
      }])                                                                                                                                                                                                
      setShowEmailModal(true)                                                                                                                                                                            
    } else {                                                                                                                                                                                             
      toast.error(result.error || 'Failed to create order')                                                                                                                                              
      setIsSubmitting(false)                                                                                                                                                                             
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    This keeps the current modal flow working while fully shifting to the orders[] return shape (with a safe fallback for older responses). Language fixes (“orders” vs                                  
    “shipments”) stay in Phase 2.+ Below are the same Phase 1 blocks with per‑group ship‑window validation inserted, using Collection windows. I’m showing exact insertion points for createOrder()      
  and                                                                                                                                                                                                    
    the draft submit route.                                                                                                                                                                              
                                                                                                                                                                                                         
    1) src/lib/data/actions/orders.ts — createOrder()                                                                                                                                                    
    Insert this after the itemGroups block (right after you build the map) and before // Track created orders.                                                                                           
                                                                                                                                                                                                         
    Insert here (anchor):                                                                                                                                                                                
                                                                                                                                                                                                         
    // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                         
    const itemGroups = new Map<string, typeof data.items>()                                                                                                                                              
    for (const item of data.items) {                                                                                                                                                                     
      const key = _getOrderGroupKey(                                                                                                                                                                     
        { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                            
        skuPreOrderMap                                                                                                                                                                                   
      )                                                                                                                                                                                                  
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    // INSERT VALIDATION BLOCK HERE                                                                                                                                                                      
                                                                                                                                                                                                         
    // Track created orders                                                                                                                                                                              
    const createdOrders: Array<{                                                                                                                                                                         
      ...                                                                                                                                                                                                
    }> = []                                                                                                                                                                                              
                                                                                                                                                                                                         
    Validation block to insert (Collection windows, per group):                                                                                                                                          
                                                                                                                                                                                                         
    // Fetch collection windows once for validation                                                                                                                                                      
    const allCollectionIds = [                                                                                                                                                                           
      ...new Set(                                                                                                                                                                                        
        data.items                                                                                                                                                                                       
          .map((i) => i.collectionId)                                                                                                                                                                    
          .filter((id): id is number => id !== null && id !== undefined)                                                                                                                                 
      ),                                                                                                                                                                                                 
    ]                                                                                                                                                                                                    
                                                                                                                                                                                                         
    const collections = allCollectionIds.length > 0                                                                                                                                                      
      ? await prisma.collection.findMany({                                                                                                                                                               
          where: { id: { in: allCollectionIds } },                                                                                                                                                       
          select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                                  
        })                                                                                                                                                                                               
      : []                                                                                                                                                                                               
                                                                                                                                                                                                         
    const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                                     
                                                                                                                                                                                                         
    // Validate each group against its collection window                                                                                                                                                 
    for (const [, groupItems] of itemGroups) {                                                                                                                                                           
      const groupCollectionIds = [                                                                                                                                                                       
        ...new Set(                                                                                                                                                                                      
          groupItems                                                                                                                                                                                     
            .map((i) => i.collectionId)                                                                                                                                                                  
            .filter((id): id is number => id !== null && id !== undefined)                                                                                                                               
        ),                                                                                                                                                                                               
      ]                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // ATS / uncategorized: no validation                                                                                                                                                              
      if (groupCollectionIds.length === 0) continue                                                                                                                                                      
                                                                                                                                                                                                         
      const groupCollections = groupCollectionIds                                                                                                                                                        
        .map((id) => collectionMap.get(id))                                                                                                                                                              
        .filter(                                                                                                                                                                                         
          (c): c is NonNullable<typeof c> =>                                                                                                                                                             
            c !== undefined                                                                                                                                                                              
        )                                                                                                                                                                                                
                                                                                                                                                                                                         
      // Block if any collection lacks windows                                                                                                                                                           
      const missingWindows = groupCollections.filter(                                                                                                                                                    
        (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                                    
      )                                                                                                                                                                                                  
      if (missingWindows.length > 0) {                                                                                                                                                                   
        const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                          
        return {                                                                                                                                                                                         
          success: false,                                                                                                                                                                                
          error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                      
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // Use the same ship dates that will be written to the order header                                                                                                                                
      const firstItem = groupItems[0]                                                                                                                                                                    
      const shipStart = (firstItem.shipWindowStart ?? data.shipStartDate).split('T')[0]                                                                                                                  
      const shipEnd = (firstItem.shipWindowEnd ?? data.shipEndDate).split('T')[0]                                                                                                                        
                                                                                                                                                                                                         
      const result = validateShipDates(                                                                                                                                                                  
        shipStart,                                                                                                                                                                                       
        shipEnd,                                                                                                                                                                                         
        groupCollections.map((c) => ({                                                                                                                                                                   
          id: c.id,                                                                                                                                                                                      
          name: c.name ?? '',                                                                                                                                                                            
          shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                               
          shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                                   
        }))                                                                                                                                                                                              
      )                                                                                                                                                                                                  
                                                                                                                                                                                                         
      if (!result.valid) {                                                                                                                                                                               
        const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                        
        return {                                                                                                                                                                                         
          success: false,                                                                                                                                                                                
          error: `Invalid dates for ${names}: ${result.errors[0]?.message}`,                                                                                                                             
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    2) src/app/api/drafts/[id]/submit/route.ts — draft submit                                                                                                                                            
    Insert this after the itemGroups block and before const currency = ....                                                                                                                              
                                                                                                                                                                                                         
    Insert here (anchor):                                                                                                                                                                                
                                                                                                                                                                                                         
    // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                         
    const itemGroups = new Map<string, typeof items>()                                                                                                                                                   
    for (const item of items) {                                                                                                                                                                          
      const key = getOrderGroupKey(                                                                                                                                                                      
        { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                            
        skuPreOrderMap                                                                                                                                                                                   
      )                                                                                                                                                                                                  
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    // INSERT VALIDATION BLOCK HERE                                                                                                                                                                      
                                                                                                                                                                                                         
    const currency = formData.currency || 'CAD'                                                                                                                                                          
                                                                                                                                                                                                         
    Validation block to insert (Collection windows, per group):                                                                                                                                          
                                                                                                                                                                                                         
    // Fetch collection windows once for validation                                                                                                                                                      
    const allCollectionIds = [                                                                                                                                                                           
      ...new Set(                                                                                                                                                                                        
        items                                                                                                                                                                                            
          .map((i) => i.collectionId)                                                                                                                                                                    
          .filter((id): id is number => id !== null && id !== undefined)                                                                                                                                 
      ),                                                                                                                                                                                                 
    ]                                                                                                                                                                                                    
                                                                                                                                                                                                         
    const collections = allCollectionIds.length > 0                                                                                                                                                      
      ? await prisma.collection.findMany({                                                                                                                                                               
          where: { id: { in: allCollectionIds } },                                                                                                                                                       
          select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                                  
        })                                                                                                                                                                                               
      : []                                                                                                                                                                                               
                                                                                                                                                                                                         
    const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                                     
                                                                                                                                                                                                         
    // Validate each group against its collection window                                                                                                                                                 
    for (const [, groupItems] of itemGroups) {                                                                                                                                                           
      const groupCollectionIds = [                                                                                                                                                                       
        ...new Set(                                                                                                                                                                                      
          groupItems                                                                                                                                                                                     
            .map((i) => i.collectionId)                                                                                                                                                                  
            .filter((id): id is number => id !== null && id !== undefined)                                                                                                                               
        ),                                                                                                                                                                                               
      ]                                                                                                                                                                                                  
                                                                                                                                                                                                         
      if (groupCollectionIds.length === 0) continue                                                                                                                                                      
                                                                                                                                                                                                         
      const groupCollections = groupCollectionIds                                                                                                                                                        
        .map((id) => collectionMap.get(id))                                                                                                                                                              
        .filter(                                                                                                                                                                                         
          (c): c is NonNullable<typeof c> =>                                                                                                                                                             
            c !== undefined                                                                                                                                                                              
        )                                                                                                                                                                                                
                                                                                                                                                                                                         
      const missingWindows = groupCollections.filter(                                                                                                                                                    
        (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                                    
      )                                                                                                                                                                                                  
      if (missingWindows.length > 0) {                                                                                                                                                                   
        const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                          
        return NextResponse.json(                                                                                                                                                                        
          { error: `Cannot validate ship dates: ${names} missing ship window dates.` },                                                                                                                  
          { status: 400 }                                                                                                                                                                                
        )                                                                                                                                                                                                
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      const firstItem = groupItems[0]                                                                                                                                                                    
      const shipStart = (firstItem.shipWindowStart ?? formData.shipStartDate).split('T')[0]                                                                                                              
      const shipEnd = (firstItem.shipWindowEnd ?? formData.shipEndDate).split('T')[0]                                                                                                                    
                                                                                                                                                                                                         
      const result = validateShipDates(                                                                                                                                                                  
        shipStart,                                                                                                                                                                                       
        shipEnd,                                                                                                                                                                                         
        groupCollections.map((c) => ({                                                                                                                                                                   
          id: c.id,                                                                                                                                                                                      
          name: c.name ?? '',                                                                                                                                                                            
          shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                               
          shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                                   
        }))                                                                                                                                                                                              
      )                                                                                                                                                                                                  
                                                                                                                                                                                                         
      if (!result.valid) {                                                                                                                                                                               
        const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                        
        return NextResponse.json(                                                                                                                                                                        
          { error: `Invalid dates for ${names}: ${result.errors[0]?.message}` },                                                                                                                         
          { status: 400 }                                                                                                                                                                                
        )                                                                                                                                                                                                
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    If you want me to include the exact updated getOrderGroupKey helper for draft submit and the matching CreateOrderResult typing updates at the same time, say the word                                
    and I’ll append those.                                                                                                                                                                               
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › include the exact updated getOrderGroupKey helper for draft submit and the matching CreateOrderResult typing updates at the same time                                                                
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • Below are the two additions you asked for.                                                                                                                                                           
                                                                                                                                                                                                         
    A) Draft submit: updated getOrderGroupKey helper (collection‑based)                                                                                                                                  
    Place this near the top of src/app/api/drafts/[id]/submit/route.ts (where the old helper used to live).                                                                                              
                                                                                                                                                                                                         
    function getOrderGroupKey(                                                                                                                                                                           
      item: { collectionId?: number | null; skuVariantId: bigint },                                                                                                                                      
      skuPreOrderMap: Map<string, boolean>                                                                                                                                                               
    ): string {                                                                                                                                                                                          
      const isPreOrder = skuPreOrderMap.get(String(item.skuVariantId)) ?? false                                                                                                                          
      const typePrefix = isPreOrder ? 'preorder' : 'ats'                                                                                                                                                 
      if (item.collectionId) return `${typePrefix}-collection-${item.collectionId}`                                                                                                                      
      return `${typePrefix}-default`                                                                                                                                                                     
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    B) CreateOrderResult typing updates (collection‑based, split orders)                                                                                                                                 
    Replace the CreateOrderResult interface in src/lib/types/order.ts with:                                                                                                                              
                                                                                                                                                                                                         
    export interface CreateOrderResult {                                                                                                                                                                 
      success: boolean                                                                                                                                                                                   
      // Single order (backwards compat - primary order when split)                                                                                                                                      
      orderId?: string                                                                                                                                                                                   
      orderNumber?: string                                                                                                                                                                               
      // Multiple orders (when split by collection)                                                                                                                                                      
      orders?: Array<{                                                                                                                                                                                   
        orderId: string                                                                                                                                                                                  
        orderNumber: string                                                                                                                                                                              
        collectionName: string | null                                                                                                                                                                    
        shipWindowStart: string | null                                                                                                                                                                   
        shipWindowEnd: string | null                                                                                                                                                                     
        orderAmount?: number // keep optional if UI expects it                                                                                                                                           
      }>                                                                                                                                                                                                 
      error?: string                                                                                                                                                                                     
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    If you want, I can also include the companion update to CreateOrderResult usage in src/components/buyer/order-form.tsx (still read‑only) to align with the orders[]                                  
    array.                                                                                                                                                                                               
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › Yes, lso include the companion update to CreateOrderResult usage in src/components/buyer/order-form.tsx to align with the orders[]                                                                   
      array. + elow are the same Phase 1 “replace this block with that block” snippets, but rewritten to use Collection-based fields (collectionId/collectionName/shipWindowStart/                       
    shipWindowEnd) and the existing _getOrderGroupKey helper. These follow the legacy split‑order flow.                                                                                                  
                                                                                                                                                                                                         
    1) src/lib/data/actions/orders.ts — createOrder() block                                                                                                                                              
    Replace everything inside createOrder() starting at:                                                                                                                                                 
    // Derive order type from SKU data (master source: Collection.type)                                                                                                                                  
    down through the return { success: true, ... } for that function.                                                                                                                                    
                                                                                                                                                                                                         
    Replace with:                                                                                                                                                                                        
                                                                                                                                                                                                         
    // Derive order type from SKU data (master source: Collection.type)                                                                                                                                  
    const skuVariantIds = data.items.map((item) => BigInt(item.skuVariantId))                                                                                                                            
    const skuPreOrderMap = await deriveIsPreOrderFromSkus(skuVariantIds)                                                                                                                                 
                                                                                                                                                                                                         
    // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                         
    const itemGroups = new Map<string, typeof data.items>()                                                                                                                                              
    for (const item of data.items) {                                                                                                                                                                     
      const key = _getOrderGroupKey(                                                                                                                                                                     
        { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                            
        skuPreOrderMap                                                                                                                                                                                   
      )                                                                                                                                                                                                  
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    // Track created orders                                                                                                                                                                              
    const createdOrders: Array<{                                                                                                                                                                         
      orderId: string                                                                                                                                                                                    
      orderNumber: string                                                                                                                                                                                
      collectionName: string | null                                                                                                                                                                      
      shipWindowStart: string | null                                                                                                                                                                     
      shipWindowEnd: string | null                                                                                                                                                                       
      orderAmount: number                                                                                                                                                                                
      items: typeof data.items                                                                                                                                                                           
    }> = []                                                                                                                                                                                              
                                                                                                                                                                                                         
    // Create orders in a single transaction for atomicity                                                                                                                                               
    await prisma.$transaction(async (tx) => {                                                                                                                                                            
      // Look up rep by ID - fail if not found                                                                                                                                                           
      const rep = await tx.reps.findUnique({                                                                                                                                                             
        where: { ID: parseInt(data.salesRepId) },                                                                                                                                                        
        select: { Name: true, Code: true },                                                                                                                                                              
      })                                                                                                                                                                                                 
      if (!rep) {                                                                                                                                                                                        
        throw new Error('Invalid sales rep')                                                                                                                                                             
      }                                                                                                                                                                                                  
      const salesRepName = rep.Name ?? ''                                                                                                                                                                
      const salesRepCode = rep.Code?.trim() || rep.Name || ''                                                                                                                                            
                                                                                                                                                                                                         
      // Determine customerId for strong ownership                                                                                                                                                       
      let customerId: number | null = data.customerId ?? null                                                                                                                                            
      if (!customerId) {                                                                                                                                                                                 
        const existingByName = await tx.customers.findFirst({                                                                                                                                            
          where: { StoreName: data.storeName },                                                                                                                                                          
          select: { ID: true },                                                                                                                                                                          
        })                                                                                                                                                                                               
        if (existingByName) {                                                                                                                                                                            
          customerId = existingByName.ID                                                                                                                                                                 
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // Create one order per collection group (and order type)                                                                                                                                          
      for (const [, groupItems] of itemGroups) {                                                                                                                                                         
        // Determine order type from first item's SKU (all items in group have same type)                                                                                                                
        const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                                    
        const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                               
                                                                                                                                                                                                         
        // Generate order number with appropriate prefix                                                                                                                                                 
        const orderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                         
                                                                                                                                                                                                         
        // Calculate group total                                                                                                                                                                         
        const orderAmount = groupItems.reduce(                                                                                                                                                           
          (sum, item) => sum + item.price * item.quantity,                                                                                                                                               
          0                                                                                                                                                                                              
        )                                                                                                                                                                                                
                                                                                                                                                                                                         
        // Use item's ship window if available, else form dates                                                                                                                                          
        const firstItem = groupItems[0]                                                                                                                                                                  
        const shipStart = firstItem.shipWindowStart                                                                                                                                                      
          ? new Date(firstItem.shipWindowStart)                                                                                                                                                          
          : new Date(data.shipStartDate)                                                                                                                                                                 
        const shipEnd = firstItem.shipWindowEnd                                                                                                                                                          
          ? new Date(firstItem.shipWindowEnd)                                                                                                                                                            
          : new Date(data.shipEndDate)                                                                                                                                                                   
                                                                                                                                                                                                         
        // Create order header                                                                                                                                                                           
        const newOrder = await tx.customerOrders.create({                                                                                                                                                
          data: {                                                                                                                                                                                        
            OrderNumber: orderNumber,                                                                                                                                                                    
            BuyerName: data.buyerName,                                                                                                                                                                   
            StoreName: data.storeName,                                                                                                                                                                   
            SalesRep: salesRepName,                                                                                                                                                                      
            CustomerEmail: data.customerEmail,                                                                                                                                                           
            CustomerPhone: data.customerPhone,                                                                                                                                                           
            Country: data.currency, // Legacy: stores currency, not country                                                                                                                              
            OrderAmount: orderAmount,                                                                                                                                                                    
            OrderNotes: data.orderNotes ?? '',                                                                                                                                                           
            CustomerPO: data.customerPO ?? '',                                                                                                                                                           
            ShipStartDate: shipStart,                                                                                                                                                                    
            ShipEndDate: shipEnd,                                                                                                                                                                        
            OrderDate: new Date(),                                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            IsShipped: false,                                                                                                                                                                            
            OrderStatus: 'Pending',                                                                                                                                                                      
            IsTransferredToShopify: false,                                                                                                                                                               
            IsPreOrder: isPreOrder, // Derived from Collection.type                                                                                                                                      
            RepID: parseInt(data.salesRepId),                                                                                                                                                            
            CustomerID: customerId,                                                                                                                                                                      
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        // Create line items for this group                                                                                                                                                              
        await tx.customerOrdersItems.createMany({                                                                                                                                                        
          data: groupItems.map((item) => ({                                                                                                                                                              
            CustomerOrderID: newOrder.ID,                                                                                                                                                                
            OrderNumber: orderNumber,                                                                                                                                                                    
            SKU: item.sku,                                                                                                                                                                               
            SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                                     
            Quantity: item.quantity,                                                                                                                                                                     
            Price: item.price,                                                                                                                                                                           
            PriceCurrency: data.currency,                                                                                                                                                                
            Notes: '',                                                                                                                                                                                   
          })),                                                                                                                                                                                           
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        createdOrders.push({                                                                                                                                                                             
          orderId: newOrder.ID.toString(),                                                                                                                                                               
          orderNumber,                                                                                                                                                                                   
          collectionName: firstItem.collectionName ?? null,                                                                                                                                              
          shipWindowStart: firstItem.shipWindowStart ?? null,                                                                                                                                            
          shipWindowEnd: firstItem.shipWindowEnd ?? null,                                                                                                                                                
          orderAmount,                                                                                                                                                                                   
          items: groupItems,                                                                                                                                                                             
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
                                                                                                                                                                                                         
      // Find or create customer (only once, not per order)                                                                                                                                              
      const existingCustomer = await tx.customers.findFirst({                                                                                                                                            
        where: { StoreName: data.storeName },                                                                                                                                                            
        select: { ID: true, OrderCount: true },                                                                                                                                                          
      })                                                                                                                                                                                                 
                                                                                                                                                                                                         
      if (existingCustomer) {                                                                                                                                                                            
        await tx.customers.update({                                                                                                                                                                      
          where: { ID: existingCustomer.ID },                                                                                                                                                            
          data: {                                                                                                                                                                                        
            CustomerName: data.buyerName,                                                                                                                                                                
            Email: data.customerEmail,                                                                                                                                                                   
            Phone: data.customerPhone,                                                                                                                                                                   
            Rep: salesRepCode,                                                                                                                                                                           
            Street1: data.street1,                                                                                                                                                                       
            Street2: data.street2 ?? '',                                                                                                                                                                 
            City: data.city,                                                                                                                                                                             
            StateProvince: data.stateProvince,                                                                                                                                                           
            ZipPostal: data.zipPostal,                                                                                                                                                                   
            Country: data.country,                                                                                                                                                                       
            ShippingStreet1: data.shippingStreet1,                                                                                                                                                       
            ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                                 
            ShippingCity: data.shippingCity,                                                                                                                                                             
            ShippingStateProvince: data.shippingStateProvince,                                                                                                                                           
            ShippingZipPostal: data.shippingZipPostal,                                                                                                                                                   
            ShippingCountry: data.shippingCountry,                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            LastOrderDate: new Date(),                                                                                                                                                                   
            OrderCount: (existingCustomer.OrderCount ?? 0) + createdOrders.length,                                                                                                                       
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
      } else {                                                                                                                                                                                           
        // Create new customer and update all orders with CustomerID                                                                                                                                     
        const newCustomer = await tx.customers.create({                                                                                                                                                  
          data: {                                                                                                                                                                                        
            StoreName: data.storeName,                                                                                                                                                                   
            CustomerName: data.buyerName,                                                                                                                                                                
            Email: data.customerEmail,                                                                                                                                                                   
            Phone: data.customerPhone,                                                                                                                                                                   
            Rep: salesRepCode,                                                                                                                                                                           
            Street1: data.street1,                                                                                                                                                                       
            Street2: data.street2 ?? '',                                                                                                                                                                 
            City: data.city,                                                                                                                                                                             
            StateProvince: data.stateProvince,                                                                                                                                                           
            ZipPostal: data.zipPostal,                                                                                                                                                                   
            Country: data.country,                                                                                                                                                                       
            ShippingStreet1: data.shippingStreet1,                                                                                                                                                       
            ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                                 
            ShippingCity: data.shippingCity,                                                                                                                                                             
            ShippingStateProvince: data.shippingStateProvince,                                                                                                                                           
            ShippingZipPostal: data.shippingZipPostal,                                                                                                                                                   
            ShippingCountry: data.shippingCountry,                                                                                                                                                       
            Website: data.website ?? '',                                                                                                                                                                 
            FirstOrderDate: new Date(),                                                                                                                                                                  
            LastOrderDate: new Date(),                                                                                                                                                                   
            OrderCount: createdOrders.length,                                                                                                                                                            
          },                                                                                                                                                                                             
          select: { ID: true },                                                                                                                                                                          
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        // Update all created orders with new customer's ID                                                                                                                                              
        for (const order of createdOrders) {                                                                                                                                                             
          await tx.customerOrders.update({                                                                                                                                                               
            where: { ID: BigInt(order.orderId) },                                                                                                                                                        
            data: { CustomerID: newCustomer.ID },                                                                                                                                                        
          })                                                                                                                                                                                             
        }                                                                                                                                                                                                
      }                                                                                                                                                                                                  
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    // Send order confirmation emails (non-blocking) unless skipEmail is set                                                                                                                             
    if (!data.skipEmail) {                                                                                                                                                                               
      for (const order of createdOrders) {                                                                                                                                                               
        sendOrderEmails({                                                                                                                                                                                
          orderId: order.orderId,                                                                                                                                                                        
          orderNumber: order.orderNumber,                                                                                                                                                                
          storeName: data.storeName,                                                                                                                                                                     
          buyerName: data.buyerName,                                                                                                                                                                     
          customerEmail: data.customerEmail,                                                                                                                                                             
          customerPhone: data.customerPhone,                                                                                                                                                             
          salesRep: data.storeName, // looked up by email service                                                                                                                                        
          orderAmount: order.orderAmount,                                                                                                                                                                
          currency: data.currency,                                                                                                                                                                       
          shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(data.shipStartDate),                                                                                         
          shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(data.shipEndDate),                                                                                                 
          orderDate: new Date(),                                                                                                                                                                         
          orderNotes: data.orderNotes,                                                                                                                                                                   
          customerPO: data.customerPO,                                                                                                                                                                   
          items: order.items.map((item) => ({                                                                                                                                                            
            sku: item.sku,                                                                                                                                                                               
            quantity: item.quantity,                                                                                                                                                                     
            price: item.price,                                                                                                                                                                           
            lineTotal: item.price * item.quantity,                                                                                                                                                       
          })),                                                                                                                                                                                           
        }).catch((err) => {                                                                                                                                                                              
          console.error(`Order email error for ${order.orderNumber}:`, err)                                                                                                                              
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    revalidatePath('/admin/orders')                                                                                                                                                                      
                                                                                                                                                                                                         
    // Return first order for backwards compatibility, plus full orders array                                                                                                                            
    const primaryOrder = createdOrders[0]                                                                                                                                                                
    return {                                                                                                                                                                                             
      success: true,                                                                                                                                                                                     
      orderId: primaryOrder?.orderId,                                                                                                                                                                    
      orderNumber: primaryOrder?.orderNumber,                                                                                                                                                            
      orders: createdOrders.map((o) => ({                                                                                                                                                                
        orderId: o.orderId,                                                                                                                                                                              
        orderNumber: o.orderNumber,                                                                                                                                                                      
        collectionName: o.collectionName,                                                                                                                                                                
        shipWindowStart: o.shipWindowStart,                                                                                                                                                              
        shipWindowEnd: o.shipWindowEnd,                                                                                                                                                                  
        orderAmount: o.orderAmount, // keep if UI expects it                                                                                                                                             
      })),                                                                                                                                                                                               
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    2) src/app/api/drafts/[id]/submit/route.ts — grouping + split creation                                                                                                                               
    Replace the block starting at:                                                                                                                                                                       
    // Phase 9: Use planned shipments instead of splitting orders                                                                                                                                        
    through the JSON response.                                                                                                                                                                           
                                                                                                                                                                                                         
    Replace with:                                                                                                                                                                                        
                                                                                                                                                                                                         
    // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                         
    const itemGroups = new Map<string, typeof items>()                                                                                                                                                   
    for (const item of items) {                                                                                                                                                                          
      const key = getOrderGroupKey(                                                                                                                                                                      
        { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                            
        skuPreOrderMap                                                                                                                                                                                   
      )                                                                                                                                                                                                  
      if (!itemGroups.has(key)) {                                                                                                                                                                        
        itemGroups.set(key, [])                                                                                                                                                                          
      }                                                                                                                                                                                                  
      itemGroups.get(key)!.push(item)                                                                                                                                                                    
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    const currency = formData.currency || 'CAD'                                                                                                                                                          
                                                                                                                                                                                                         
    // Track created orders                                                                                                                                                                              
    const createdOrders: Array<{                                                                                                                                                                         
      orderId: string                                                                                                                                                                                    
      orderNumber: string                                                                                                                                                                                
      collectionName: string | null                                                                                                                                                                      
      shipWindowStart: string | null                                                                                                                                                                     
      shipWindowEnd: string | null                                                                                                                                                                       
      orderAmount: number                                                                                                                                                                                
      items: typeof items                                                                                                                                                                                
    }> = []                                                                                                                                                                                              
                                                                                                                                                                                                         
    await prisma.$transaction(async (tx) => {                                                                                                                                                            
      // Delete the draft first (we'll create new orders)                                                                                                                                                
      await tx.customerOrdersItems.deleteMany({                                                                                                                                                          
        where: { CustomerOrderID: draft.ID },                                                                                                                                                            
      })                                                                                                                                                                                                 
      await tx.customerOrders.delete({                                                                                                                                                                   
        where: { ID: draft.ID },                                                                                                                                                                         
      })                                                                                                                                                                                                 
                                                                                                                                                                                                         
      // Create one order per collection group (and order type)                                                                                                                                          
      for (const [, groupItems] of itemGroups) {                                                                                                                                                         
        const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                                    
        const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                               
        const groupOrderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                    
        const groupAmount = groupItems.reduce((sum, item) => sum + item.price * item.quantity, 0)                                                                                                        
                                                                                                                                                                                                         
        const firstItem = groupItems[0]                                                                                                                                                                  
        const shipStart = firstItem.shipWindowStart                                                                                                                                                      
          ? new Date(firstItem.shipWindowStart)                                                                                                                                                          
          : new Date(formData.shipStartDate)                                                                                                                                                             
        const shipEnd = firstItem.shipWindowEnd                                                                                                                                                          
          ? new Date(firstItem.shipWindowEnd)                                                                                                                                                            
          : new Date(formData.shipEndDate)                                                                                                                                                               
                                                                                                                                                                                                         
        const newOrder = await tx.customerOrders.create({                                                                                                                                                
          data: {                                                                                                                                                                                        
            OrderNumber: groupOrderNumber,                                                                                                                                                               
            OrderStatus: 'Pending',                                                                                                                                                                      
            BuyerName: formData.buyerName,                                                                                                                                                               
            StoreName: formData.storeName,                                                                                                                                                               
            SalesRep: salesRepName,                                                                                                                                                                      
            CustomerEmail: formData.customerEmail,                                                                                                                                                       
            CustomerPhone: formData.customerPhone,                                                                                                                                                       
            Country: currency,                                                                                                                                                                           
            OrderAmount: groupAmount,                                                                                                                                                                    
            OrderNotes: formData.orderNotes || '',                                                                                                                                                       
            CustomerPO: formData.customerPO || '',                                                                                                                                                       
            ShipStartDate: shipStart,                                                                                                                                                                    
            ShipEndDate: shipEnd,                                                                                                                                                                        
            OrderDate: new Date(),                                                                                                                                                                       
            Website: formData.website || '',                                                                                                                                                             
            IsShipped: false,                                                                                                                                                                            
            IsTransferredToShopify: false,                                                                                                                                                               
            IsPreOrder: isPreOrder,                                                                                                                                                                      
            RepID: parseInt(formData.salesRepId),                                                                                                                                                        
            CustomerID: customerId,                                                                                                                                                                      
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        await tx.customerOrdersItems.createMany({                                                                                                                                                        
          data: groupItems.map(item => ({                                                                                                                                                                
            CustomerOrderID: newOrder.ID,                                                                                                                                                                
            OrderNumber: groupOrderNumber,                                                                                                                                                               
            SKU: item.sku,                                                                                                                                                                               
            SKUVariantID: item.skuVariantId,                                                                                                                                                             
            Quantity: item.quantity,                                                                                                                                                                     
            Price: item.price,                                                                                                                                                                           
            PriceCurrency: currency,                                                                                                                                                                     
            Notes: '',                                                                                                                                                                                   
          })),                                                                                                                                                                                           
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        createdOrders.push({                                                                                                                                                                             
          orderId: String(newOrder.ID),                                                                                                                                                                  
          orderNumber: groupOrderNumber,                                                                                                                                                                 
          collectionName: firstItem.collectionName,                                                                                                                                                      
          shipWindowStart: firstItem.shipWindowStart,                                                                                                                                                    
          shipWindowEnd: firstItem.shipWindowEnd,                                                                                                                                                        
          orderAmount: groupAmount,                                                                                                                                                                      
          items: groupItems,                                                                                                                                                                             
        })                                                                                                                                                                                               
      }                                                                                                                                                                                                  
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    // Send confirmation emails for each created order (non-blocking)                                                                                                                                    
    for (const order of createdOrders) {                                                                                                                                                                 
      sendOrderEmails({                                                                                                                                                                                  
        orderId: order.orderId,                                                                                                                                                                          
        orderNumber: order.orderNumber,                                                                                                                                                                  
        storeName: formData.storeName,                                                                                                                                                                   
        buyerName: formData.buyerName,                                                                                                                                                                   
        salesRep: salesRepName,                                                                                                                                                                          
        customerEmail: formData.customerEmail,                                                                                                                                                           
        customerPhone: formData.customerPhone,                                                                                                                                                           
        shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(formData.shipStartDate),                                                                                       
        shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(formData.shipEndDate),                                                                                               
        orderDate: new Date(),                                                                                                                                                                           
        orderNotes: formData.orderNotes,                                                                                                                                                                 
        customerPO: formData.customerPO,                                                                                                                                                                 
        items: order.items.map(i => ({                                                                                                                                                                   
          sku: i.sku,                                                                                                                                                                                    
          quantity: i.quantity,                                                                                                                                                                          
          price: i.price,                                                                                                                                                                                
          lineTotal: i.price * i.quantity,                                                                                                                                                               
        })),                                                                                                                                                                                             
        currency,                                                                                                                                                                                        
        orderAmount: order.orderAmount,                                                                                                                                                                  
      }).catch(err => {                                                                                                                                                                                  
        console.error(`Failed to send order emails for ${order.orderNumber}:`, err)                                                                                                                      
      })                                                                                                                                                                                                 
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    const primaryOrder = createdOrders[0]                                                                                                                                                                
    return NextResponse.json({                                                                                                                                                                           
      success: true,                                                                                                                                                                                     
      orderId: primaryOrder?.orderId,                                                                                                                                                                    
      orderNumber: primaryOrder?.orderNumber,                                                                                                                                                            
      orders: createdOrders.map(o => ({                                                                                                                                                                  
        orderId: o.orderId,                                                                                                                                                                              
        orderNumber: o.orderNumber,                                                                                                                                                                      
        collectionName: o.collectionName,                                                                                                                                                                
        shipWindowStart: o.shipWindowStart,                                                                                                                                                              
        shipWindowEnd: o.shipWindowEnd,                                                                                                                                                                  
        orderAmount: o.orderAmount, // keep if UI expects it                                                                                                                                             
      })),                                                                                                                                                                                               
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    Also ensure this helper exists in the file (collection-based):                                                                                                                                       
                                                                                                                                                                                                         
    function getOrderGroupKey(                                                                                                                                                                           
      item: { collectionId?: number | null; skuVariantId: bigint },                                                                                                                                      
      skuPreOrderMap: Map<string, boolean>                                                                                                                                                               
    ): string {                                                                                                                                                                                          
      const isPreOrder = skuPreOrderMap.get(String(item.skuVariantId)) ?? false                                                                                                                          
      const typePrefix = isPreOrder ? 'preorder' : 'ats'                                                                                                                                                 
      if (item.collectionId) return `${typePrefix}-collection-${item.collectionId}`                                                                                                                      
      return `${typePrefix}-default`                                                                                                                                                                     
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    3) src/lib/schemas/order.ts — collection-based item schema, no plannedShipments                                                                                                                      
    Replace the orderItemSchema + createOrderInputSchema blocks with:                                                                                                                                    
                                                                                                                                                                                                         
    export const orderItemSchema = z.object({                                                                                                                                                            
      sku: z.string().min(1),                                                                                                                                                                            
      skuVariantId: z.union([z.bigint(), z.number()]),                                                                                                                                                   
      quantity: z.number().int().positive(),                                                                                                                                                             
      price: z.number().nonnegative(),                                                                                                                                                                   
      // Collection is the source for order splitting and pre-order detection                                                                                                                            
      collectionId: z.number().nullable().optional(),                                                                                                                                                    
      collectionName: z.string().nullable().optional(),                                                                                                                                                  
      // Ship window dates from Collection                                                                                                                                                               
      shipWindowStart: z.string().nullable().optional(),                                                                                                                                                 
      shipWindowEnd: z.string().nullable().optional(),                                                                                                                                                   
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    export type OrderItem = z.infer<typeof orderItemSchema)                                                                                                                                              
                                                                                                                                                                                                         
    export const createOrderInputSchema = orderFormSchema.extend({                                                                                                                                       
      currency: z.enum(['USD', 'CAD']),                                                                                                                                                                  
      items: z.array(orderItemSchema).min(1, 'Order must have at least one item'),                                                                                                                       
      isPreOrder: z.boolean().optional(),                                                                                                                                                                
      customerId: z.number().int().positive().nullable().optional(),                                                                                                                                     
      skipEmail: z.boolean().optional(),                                                                                                                                                                 
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    4) src/lib/types/order.ts — CreateOrderResult + UpdateOrderInput                                                                                                                                     
    Replace those blocks with:                                                                                                                                                                           
                                                                                                                                                                                                         
    export interface CreateOrderResult {                                                                                                                                                                 
      success: boolean                                                                                                                                                                                   
      orderId?: string                                                                                                                                                                                   
      orderNumber?: string                                                                                                                                                                               
      orders?: Array<{                                                                                                                                                                                   
        orderId: string                                                                                                                                                                                  
        orderNumber: string                                                                                                                                                                              
        collectionName: string | null                                                                                                                                                                    
        shipWindowStart: string | null                                                                                                                                                                   
        shipWindowEnd: string | null                                                                                                                                                                     
        orderAmount?: number // keep optional if UI expects it                                                                                                                                           
      }>                                                                                                                                                                                                 
      error?: string                                                                                                                                                                                     
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    export interface UpdateOrderInput {                                                                                                                                                                  
      orderId: string                                                                                                                                                                                    
      storeName: string                                                                                                                                                                                  
      buyerName: string                                                                                                                                                                                  
      salesRepId: string                                                                                                                                                                                 
      customerEmail: string                                                                                                                                                                              
      customerPhone: string                                                                                                                                                                              
      currency: 'USD' | 'CAD'                                                                                                                                                                            
      shipStartDate: string                                                                                                                                                                              
      shipEndDate: string                                                                                                                                                                                
      orderNotes?: string                                                                                                                                                                                
      customerPO?: string                                                                                                                                                                                
      website?: string                                                                                                                                                                                   
      items: Array<{                                                                                                                                                                                     
        sku: string                                                                                                                                                                                      
        skuVariantId: number                                                                                                                                                                             
        quantity: number                                                                                                                                                                                 
        price: number                                                                                                                                                                                    
      }>                                                                                                                                                                                                 
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    5) src/components/buyer/order-form.tsx — remove shipment validation gate + payload                                                                                                                   
    A) Replace the top of onSubmit with:                                                                                                                                                                 
                                                                                                                                                                                                         
    const onSubmit = async (data: OrderFormData) => {                                                                                                                                                    
      if (isSubmitting) return // Prevent double-click                                                                                                                                                   
      setIsSubmitting(true)                                                                                                                                                                              
                                                                                                                                                                                                         
    B) Replace the createOrder call block with this (collection-based, no plannedShipments):                                                                                                             
                                                                                                                                                                                                         
    const result = await createOrder({                                                                                                                                                                   
      ...data,                                                                                                                                                                                           
      currency,                                                                                                                                                                                          
      items: cartItems.map((item) => ({                                                                                                                                                                  
        sku: item.sku,                                                                                                                                                                                   
        skuVariantId: item.skuVariantId,                                                                                                                                                                 
        quantity: item.quantity,                                                                                                                                                                         
        price: item.price,                                                                                                                                                                               
        collectionId: item.collectionId,                                                                                                                                                                 
        collectionName: item.collectionName,                                                                                                                                                             
        shipWindowStart: item.shipWindowStart,                                                                                                                                                           
        shipWindowEnd: item.shipWindowEnd,                                                                                                                                                               
      })),                                                                                                                                                                                               
      isPreOrder,                                                                                                                                                                                        
      customerId: selectedCustomerId,                                                                                                                                                                    
      skipEmail: true,                                                                                                                                                                                   
    })                                                                                                                                                                                                   
                                                                                                                                                                                                         
    If you want, I can now generate the same set with per-group ship-window validation inserted (using Collection windows) and show exactly where it goes in                                             
    createOrder() and the draft submit route.                                                                                                                                                            
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › Yes, generate the same set with per-group ship-window validation inserted (using Collection windows) and show exactly where it goes in                                                               
      createOrder() and the draft submit route                                                                                                                                                           
                                                                                                                                                                                                         
⏺ Let me create the comprehensive Phase 1 plan with all the Collection-based snippets and validation blocks consolidated.                                                                                
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ I've created a comprehensive Phase 1 plan at /Users/danielplant/.claude/plans/curious-baking-melody.md that includes:                                                                                  
                                                                                                                                                                                                         
  All 5 files with exact replacement blocks:                                                                                                                                                             
  1. orders.ts - Full createOrder() replacement with grouping loop + validation                                                                                                                          
  2. drafts/[id]/submit/route.ts - Same logic + getOrderGroupKey helper                                                                                                                                  
  3. order.ts (schemas) - Removed plannedShipments, uses collection* fields                                                                                                                              
  4. order.ts (types) - CreateOrderResult with orders[] array                                                                                                                                            
  5. order-form.tsx - Removes shipment validation, handles orders[] response                                                                                                                             
                                                                                                                                                                                                         
  Key features:                                                                                                                                                                                          
  - Uses Collection-based fields (not category) throughout                                                                                                                                               
  - Includes per-group ship window validation using validateShipDates()                                                                                                                                  
  - Increments Customer.OrderCount by createdOrders.length                                                                                                                                               
  - Does NOT populate PlannedShipmentID (column stays, unused)                                                                                                                                           
  - Sends email per created order                                                                                                                                                                        
  ⎿  User rejected Claude's plan:                                                                                                                                                                        
     ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮  
     │ Phase 1: Revert to Order Splitting (Collection-Based)                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Context                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ The PlannedShipment feature was built based on a misinterpretation of CEO feedback. The original order splitting behavior (one cart → multiple orders by collection) was actually correct and  │  
     │ preferred. This plan reverts to that behavior while keeping Collection as the canonical source for ship windows and PreOrder detection.                                                        │  
     │                                                                                                                                                                                                │  
     │ Pre-Implementation Decisions (Confirmed)                                                                                                                                                       │  
     │ ┌───────────────────────────┬────────────────────────────────────────────┬────────────────────────────────────┐                                                                                │  
     │ │         Decision          │                   Choice                   │             Rationale              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Ship window source        │ Collection (shipWindowStart/shipWindowEnd) │ Now canonical in prod              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PreOrder detection        │ Collection.type                            │ Consistent with current data model │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Missing collection window │ Block with error                           │ Enforce data quality               │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PlannedShipment table     │ Leave in place, don't populate             │ Avoid migration risk               │                                                                                │  
     │ └───────────────────────────┴────────────────────────────────────────────┴────────────────────────────────────┘                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Files to Change (5 files)                                                                                                                                                                      │  
     │ ┌─────┬─────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────┐                                                              │  
     │ │  #  │                  File                   │                                    Summary                                    │                                                              │  
     │ ├─────┼─────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                              │  
     │ │ 1   │ src/lib/data/actions/orders.ts          │ Restore grouping loop + per-group validation, remove PlannedShipment creation │                                                              │  
     │ ├─────┼─────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                              │  
     │ │ 2   │ src/app/api/drafts/[id]/submit/route.ts │ Same - restore grouping + validation, add helper                              │                                                              │  
     │ ├─────┼─────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                              │  
     │ │ 3   │ src/lib/schemas/order.ts                │ Remove plannedShipments, use collection* fields                               │                                                              │  
     │ ├─────┼─────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                              │  
     │ │ 4   │ src/lib/types/order.ts                  │ Restore orders[] return type                                                  │                                                              │  
     │ ├─────┼─────────────────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤                                                              │  
     │ │ 5   │ src/components/buyer/order-form.tsx     │ Remove shipment validation block, handle orders[] response                    │                                                              │  
     │ └─────┴─────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┘                                                              │  
     │ ---                                                                                                                                                                                            │  
     │ File 1: src/lib/data/actions/orders.ts                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ Change: Replace createOrder() core logic                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Derive order type from SKU data (master source: Collection.type)                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the return { success: true, ... } with:                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Derive order type from SKU data (master source: Collection.type)                                                                                                                            │  
     │ const skuVariantIds = data.items.map((item) => BigInt(item.skuVariantId))                                                                                                                      │  
     │ const skuPreOrderMap = await deriveIsPreOrderFromSkus(skuVariantIds)                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof data.items>()                                                                                                                                        │  
     │ for (const item of data.items) {                                                                                                                                                               │  
     │   const key = _getOrderGroupKey(                                                                                                                                                               │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     data.items                                                                                                                                                                                 │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // ATS / uncategorized: no validation                                                                                                                                                        │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   // Block if any collection lacks windows                                                                                                                                                     │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Use the same ship dates that will be written to the order header                                                                                                                          │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? data.shipStartDate).split('T')[0]                                                                                                            │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? data.shipEndDate).split('T')[0]                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Invalid dates for ${names}: ${result.errors[0]?.message}`,                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof data.items                                                                                                                                                                     │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ // Create orders in a single transaction for atomicity                                                                                                                                         │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Look up rep by ID - fail if not found                                                                                                                                                     │  
     │   const rep = await tx.reps.findUnique({                                                                                                                                                       │  
     │     where: { ID: parseInt(data.salesRepId) },                                                                                                                                                  │  
     │     select: { Name: true, Code: true },                                                                                                                                                        │  
     │   })                                                                                                                                                                                           │  
     │   if (!rep) {                                                                                                                                                                                  │  
     │     throw new Error('Invalid sales rep')                                                                                                                                                       │  
     │   }                                                                                                                                                                                            │  
     │   const salesRepName = rep.Name ?? ''                                                                                                                                                          │  
     │   const salesRepCode = rep.Code?.trim() || rep.Name || ''                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │   // Determine customerId for strong ownership                                                                                                                                                 │  
     │   let customerId: number | null = data.customerId ?? null                                                                                                                                      │  
     │   if (!customerId) {                                                                                                                                                                           │  
     │     const existingByName = await tx.customers.findFirst({                                                                                                                                      │  
     │       where: { StoreName: data.storeName },                                                                                                                                                    │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │     if (existingByName) {                                                                                                                                                                      │  
     │       customerId = existingByName.ID                                                                                                                                                           │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     // Determine order type from first item's SKU (all items in group have same type)                                                                                                          │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Generate order number with appropriate prefix                                                                                                                                           │  
     │     const orderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │     // Calculate group total                                                                                                                                                                   │  
     │     const orderAmount = groupItems.reduce(                                                                                                                                                     │  
     │       (sum, item) => sum + item.price * item.quantity,                                                                                                                                         │  
     │       0                                                                                                                                                                                        │  
     │     )                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Use item's ship window if available, else form dates                                                                                                                                    │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(data.shipStartDate)                                                                                                                                                           │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(data.shipEndDate)                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │     // Create order header                                                                                                                                                                     │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         BuyerName: data.buyerName,                                                                                                                                                             │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: data.customerEmail,                                                                                                                                                     │  
     │         CustomerPhone: data.customerPhone,                                                                                                                                                     │  
     │         Country: data.currency, // Legacy: stores currency, not country                                                                                                                        │  
     │         OrderAmount: orderAmount,                                                                                                                                                              │  
     │         OrderNotes: data.orderNotes ?? '',                                                                                                                                                     │  
     │         CustomerPO: data.customerPO ?? '',                                                                                                                                                     │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder, // Derived from Collection.type                                                                                                                                │  
     │         RepID: parseInt(data.salesRepId),                                                                                                                                                      │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Create line items for this group (NO PlannedShipmentID)                                                                                                                                 │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map((item) => ({                                                                                                                                                        │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                               │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: data.currency,                                                                                                                                                          │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: newOrder.ID.toString(),                                                                                                                                                         │  
     │       orderNumber,                                                                                                                                                                             │  
     │       collectionName: firstItem.collectionName ?? null,                                                                                                                                        │  
     │       shipWindowStart: firstItem.shipWindowStart ?? null,                                                                                                                                      │  
     │       shipWindowEnd: firstItem.shipWindowEnd ?? null,                                                                                                                                          │  
     │       orderAmount,                                                                                                                                                                             │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Find or create customer (only once, not per order)                                                                                                                                        │  
     │   const existingCustomer = await tx.customers.findFirst({                                                                                                                                      │  
     │     where: { StoreName: data.storeName },                                                                                                                                                      │  
     │     select: { ID: true, OrderCount: true },                                                                                                                                                    │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   if (existingCustomer) {                                                                                                                                                                      │  
     │     await tx.customers.update({                                                                                                                                                                │  
     │       where: { ID: existingCustomer.ID },                                                                                                                                                      │  
     │       data: {                                                                                                                                                                                  │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: (existingCustomer.OrderCount ?? 0) + createdOrders.length,                                                                                                                 │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   } else {                                                                                                                                                                                     │  
     │     // Create new customer and update all orders with CustomerID                                                                                                                               │  
     │     const newCustomer = await tx.customers.create({                                                                                                                                            │  
     │       data: {                                                                                                                                                                                  │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         FirstOrderDate: new Date(),                                                                                                                                                            │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: createdOrders.length,                                                                                                                                                      │  
     │       },                                                                                                                                                                                       │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Update all created orders with new customer's ID                                                                                                                                        │  
     │     for (const order of createdOrders) {                                                                                                                                                       │  
     │       await tx.customerOrders.update({                                                                                                                                                         │  
     │         where: { ID: BigInt(order.orderId) },                                                                                                                                                  │  
     │         data: { CustomerID: newCustomer.ID },                                                                                                                                                  │  
     │       })                                                                                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send order confirmation emails (non-blocking) unless skipEmail is set                                                                                                                       │  
     │ if (!data.skipEmail) {                                                                                                                                                                         │  
     │   for (const order of createdOrders) {                                                                                                                                                         │  
     │     sendOrderEmails({                                                                                                                                                                          │  
     │       orderId: order.orderId,                                                                                                                                                                  │  
     │       orderNumber: order.orderNumber,                                                                                                                                                          │  
     │       storeName: data.storeName,                                                                                                                                                               │  
     │       buyerName: data.buyerName,                                                                                                                                                               │  
     │       customerEmail: data.customerEmail,                                                                                                                                                       │  
     │       customerPhone: data.customerPhone,                                                                                                                                                       │  
     │       salesRep: data.storeName,                                                                                                                                                                │  
     │       orderAmount: order.orderAmount,                                                                                                                                                          │  
     │       currency: data.currency,                                                                                                                                                                 │  
     │       shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(data.shipStartDate),                                                                                   │  
     │       shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(data.shipEndDate),                                                                                           │  
     │       orderDate: new Date(),                                                                                                                                                                   │  
     │       orderNotes: data.orderNotes,                                                                                                                                                             │  
     │       customerPO: data.customerPO,                                                                                                                                                             │  
     │       items: order.items.map((item) => ({                                                                                                                                                      │  
     │         sku: item.sku,                                                                                                                                                                         │  
     │         quantity: item.quantity,                                                                                                                                                               │  
     │         price: item.price,                                                                                                                                                                     │  
     │         lineTotal: item.price * item.quantity,                                                                                                                                                 │  
     │       })),                                                                                                                                                                                     │  
     │     }).catch((err) => {                                                                                                                                                                        │  
     │       console.error(`Order email error for ${order.orderNumber}:`, err)                                                                                                                        │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ revalidatePath('/admin/orders')                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ // Return first order for backwards compatibility, plus full orders array                                                                                                                      │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return {                                                                                                                                                                                       │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map((o) => ({                                                                                                                                                          │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 2: src/app/api/drafts/[id]/submit/route.ts                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change A: Add getOrderGroupKey helper near top of file                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ function getOrderGroupKey(                                                                                                                                                                     │  
     │   item: { collectionId?: number | null; skuVariantId: bigint },                                                                                                                                │  
     │   skuPreOrderMap: Map<string, boolean>                                                                                                                                                         │  
     │ ): string {                                                                                                                                                                                    │  
     │   const isPreOrder = skuPreOrderMap.get(String(item.skuVariantId)) ?? false                                                                                                                    │  
     │   const typePrefix = isPreOrder ? 'preorder' : 'ats'                                                                                                                                           │  
     │   if (item.collectionId) return `${typePrefix}-collection-${item.collectionId}`                                                                                                                │  
     │   return `${typePrefix}-default`                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace submission logic                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Phase 9: Use planned shipments instead of splitting orders                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the JSON response with:                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof items>()                                                                                                                                             │  
     │ for (const item of items) {                                                                                                                                                                    │  
     │   const key = getOrderGroupKey(                                                                                                                                                                │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     items                                                                                                                                                                                      │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Cannot validate ship dates: ${names} missing ship window dates.` },                                                                                                            │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? formData.shipStartDate).split('T')[0]                                                                                                        │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? formData.shipEndDate).split('T')[0]                                                                                                              │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Invalid dates for ${names}: ${result.errors[0]?.message}` },                                                                                                                   │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const currency = formData.currency || 'CAD'                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof items                                                                                                                                                                          │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Delete the draft first (we'll create new orders)                                                                                                                                          │  
     │   await tx.customerOrdersItems.deleteMany({                                                                                                                                                    │  
     │     where: { CustomerOrderID: draft.ID },                                                                                                                                                      │  
     │   })                                                                                                                                                                                           │  
     │   await tx.customerOrders.delete({                                                                                                                                                             │  
     │     where: { ID: draft.ID },                                                                                                                                                                   │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │     const groupOrderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                              │  
     │     const groupAmount = groupItems.reduce((sum, item) => sum + item.price * item.quantity, 0)                                                                                                  │  
     │                                                                                                                                                                                                │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(formData.shipStartDate)                                                                                                                                                       │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(formData.shipEndDate)                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         BuyerName: formData.buyerName,                                                                                                                                                         │  
     │         StoreName: formData.storeName,                                                                                                                                                         │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: formData.customerEmail,                                                                                                                                                 │  
     │         CustomerPhone: formData.customerPhone,                                                                                                                                                 │  
     │         Country: currency,                                                                                                                                                                     │  
     │         OrderAmount: groupAmount,                                                                                                                                                              │  
     │         OrderNotes: formData.orderNotes || '',                                                                                                                                                 │  
     │         CustomerPO: formData.customerPO || '',                                                                                                                                                 │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: formData.website || '',                                                                                                                                                       │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder,                                                                                                                                                                │  
     │         RepID: parseInt(formData.salesRepId),                                                                                                                                                  │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map(item => ({                                                                                                                                                          │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: item.skuVariantId,                                                                                                                                                       │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: currency,                                                                                                                                                               │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: String(newOrder.ID),                                                                                                                                                            │  
     │       orderNumber: groupOrderNumber,                                                                                                                                                           │  
     │       collectionName: firstItem.collectionName,                                                                                                                                                │  
     │       shipWindowStart: firstItem.shipWindowStart,                                                                                                                                              │  
     │       shipWindowEnd: firstItem.shipWindowEnd,                                                                                                                                                  │  
     │       orderAmount: groupAmount,                                                                                                                                                                │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send confirmation emails for each created order (non-blocking)                                                                                                                              │  
     │ for (const order of createdOrders) {                                                                                                                                                           │  
     │   sendOrderEmails({                                                                                                                                                                            │  
     │     orderId: order.orderId,                                                                                                                                                                    │  
     │     orderNumber: order.orderNumber,                                                                                                                                                            │  
     │     storeName: formData.storeName,                                                                                                                                                             │  
     │     buyerName: formData.buyerName,                                                                                                                                                             │  
     │     salesRep: salesRepName,                                                                                                                                                                    │  
     │     customerEmail: formData.customerEmail,                                                                                                                                                     │  
     │     customerPhone: formData.customerPhone,                                                                                                                                                     │  
     │     shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(formData.shipStartDate),                                                                                 │  
     │     shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(formData.shipEndDate),                                                                                         │  
     │     orderDate: new Date(),                                                                                                                                                                     │  
     │     orderNotes: formData.orderNotes,                                                                                                                                                           │  
     │     customerPO: formData.customerPO,                                                                                                                                                           │  
     │     items: order.items.map(i => ({                                                                                                                                                             │  
     │       sku: i.sku,                                                                                                                                                                              │  
     │       quantity: i.quantity,                                                                                                                                                                    │  
     │       price: i.price,                                                                                                                                                                          │  
     │       lineTotal: i.price * i.quantity,                                                                                                                                                         │  
     │     })),                                                                                                                                                                                       │  
     │     currency,                                                                                                                                                                                  │  
     │     orderAmount: order.orderAmount,                                                                                                                                                            │  
     │   }).catch(err => {                                                                                                                                                                            │  
     │     console.error(`Failed to send order emails for ${order.orderNumber}:`, err)                                                                                                                │  
     │   })                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return NextResponse.json({                                                                                                                                                                     │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map(o => ({                                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 3: src/lib/schemas/order.ts                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Change: Replace orderItemSchema and createOrderInputSchema                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Remove the plannedShipmentSchema definition entirely.                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Replace orderItemSchema with:                                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ export const orderItemSchema = z.object({                                                                                                                                                      │  
     │   sku: z.string().min(1),                                                                                                                                                                      │  
     │   skuVariantId: z.union([z.bigint(), z.number()]),                                                                                                                                             │  
     │   quantity: z.number().int().positive(),                                                                                                                                                       │  
     │   price: z.number().nonnegative(),                                                                                                                                                             │  
     │   // Collection is the source for order splitting and pre-order detection                                                                                                                      │  
     │   collectionId: z.number().nullable().optional(),                                                                                                                                              │  
     │   collectionName: z.string().nullable().optional(),                                                                                                                                            │  
     │   // Ship window dates from Collection                                                                                                                                                         │  
     │   shipWindowStart: z.string().nullable().optional(),                                                                                                                                           │  
     │   shipWindowEnd: z.string().nullable().optional(),                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ export type OrderItem = z.infer<typeof orderItemSchema>                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Replace createOrderInputSchema with:                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ export const createOrderInputSchema = orderFormSchema.extend({                                                                                                                                 │  
     │   currency: z.enum(['USD', 'CAD']),                                                                                                                                                            │  
     │   items: z.array(orderItemSchema).min(1, 'Order must have at least one item'),                                                                                                                 │  
     │   isPreOrder: z.boolean().optional(),                                                                                                                                                          │  
     │   customerId: z.number().int().positive().nullable().optional(),                                                                                                                               │  
     │   skipEmail: z.boolean().optional(),                                                                                                                                                           │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 4: src/lib/types/order.ts                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ Change: Replace CreateOrderResult and UpdateOrderInput                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ export interface CreateOrderResult {                                                                                                                                                           │  
     │   success: boolean                                                                                                                                                                             │  
     │   orderId?: string                                                                                                                                                                             │  
     │   orderNumber?: string                                                                                                                                                                         │  
     │   orders?: Array<{                                                                                                                                                                             │  
     │     orderId: string                                                                                                                                                                            │  
     │     orderNumber: string                                                                                                                                                                        │  
     │     collectionName: string | null                                                                                                                                                              │  
     │     shipWindowStart: string | null                                                                                                                                                             │  
     │     shipWindowEnd: string | null                                                                                                                                                               │  
     │     orderAmount?: number                                                                                                                                                                       │  
     │   }>                                                                                                                                                                                           │  
     │   error?: string                                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ export interface UpdateOrderInput {                                                                                                                                                            │  
     │   orderId: string                                                                                                                                                                              │  
     │   storeName: string                                                                                                                                                                            │  
     │   buyerName: string                                                                                                                                                                            │  
     │   salesRepId: string                                                                                                                                                                           │  
     │   customerEmail: string                                                                                                                                                                        │  
     │   customerPhone: string                                                                                                                                                                        │  
     │   currency: 'USD' | 'CAD'                                                                                                                                                                      │  
     │   shipStartDate: string                                                                                                                                                                        │  
     │   shipEndDate: string                                                                                                                                                                          │  
     │   orderNotes?: string                                                                                                                                                                          │  
     │   customerPO?: string                                                                                                                                                                          │  
     │   website?: string                                                                                                                                                                             │  
     │   items: Array<{                                                                                                                                                                               │  
     │     sku: string                                                                                                                                                                                │  
     │     skuVariantId: number                                                                                                                                                                       │  
     │     quantity: number                                                                                                                                                                           │  
     │     price: number                                                                                                                                                                              │  
     │   }>                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 5: src/components/buyer/order-form.tsx                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ Change A: Remove shipment validation guard at top of onSubmit                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ Replace the start of onSubmit with:                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ const onSubmit = async (data: OrderFormData) => {                                                                                                                                              │  
     │   if (isSubmitting) return // Prevent double-click                                                                                                                                             │  
     │   setIsSubmitting(true)                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ (Remove the hasShipmentValidationErrors && !overrideConfirmed check if present)                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace createOrder payload                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Find the createOrder({ call and replace the payload with:                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ const result = await createOrder({                                                                                                                                                             │  
     │   ...data,                                                                                                                                                                                     │  
     │   currency,                                                                                                                                                                                    │  
     │   items: cartItems.map((item) => ({                                                                                                                                                            │  
     │     sku: item.sku,                                                                                                                                                                             │  
     │     skuVariantId: item.skuVariantId,                                                                                                                                                           │  
     │     quantity: item.quantity,                                                                                                                                                                   │  
     │     price: item.price,                                                                                                                                                                         │  
     │     collectionId: item.collectionId,                                                                                                                                                           │  
     │     collectionName: item.collectionName,                                                                                                                                                       │  
     │     shipWindowStart: item.shipWindowStart,                                                                                                                                                     │  
     │     shipWindowEnd: item.shipWindowEnd,                                                                                                                                                         │  
     │   })),                                                                                                                                                                                         │  
     │   isPreOrder,                                                                                                                                                                                  │  
     │   customerId: selectedCustomerId,                                                                                                                                                              │  
     │   skipEmail: true,                                                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Change C: Handle orders[] response                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Replace the success handling block with:                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ if (result.success && result.orders?.length) {                                                                                                                                                 │  
     │   // Store order summaries for the modal (orders[] is the canonical return)                                                                                                                    │  
     │   setSubmittedShipments(result.orders.map((o) => ({                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount ?? orderTotal,                                                                                                                                                  │  
     │   })))                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else if (result.success && result.orderId) {                                                                                                                                                 │  
     │   // Backwards compatibility: single order without orders array                                                                                                                                │  
     │   setSubmittedShipments([{                                                                                                                                                                     │  
     │     orderId: result.orderId,                                                                                                                                                                   │  
     │     orderNumber: result.orderNumber || '',                                                                                                                                                     │  
     │     collectionName: null,                                                                                                                                                                      │  
     │     shipWindowStart: null,                                                                                                                                                                     │  
     │     shipWindowEnd: null,                                                                                                                                                                       │  
     │     orderAmount: orderTotal,                                                                                                                                                                   │  
     │   }])                                                                                                                                                                                          │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else {                                                                                                                                                                                       │  
     │   toast.error(result.error || 'Failed to create order')                                                                                                                                        │  
     │   setIsSubmitting(false)                                                                                                                                                                       │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Verification                                                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ Automated Checks                                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ npm run type-check   # No type errors                                                                                                                                                          │  
     │ npm run lint         # No lint errors                                                                                                                                                          │  
     │ npm run build        # Builds successfully                                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Manual Testing                                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ 1. Single collection order:                                                                                                                                                                    │  
     │   - Add items from 1 collection to cart                                                                                                                                                        │  
     │   - Submit → 1 order created                                                                                                                                                                   │  
     │   - Verify order has correct ship dates from collection                                                                                                                                        │  
     │ 2. Multi-collection order (split test):                                                                                                                                                        │  
     │   - Add items from 2 different collections to cart                                                                                                                                             │  
     │   - Submit → 2 separate orders created (different order numbers)                                                                                                                               │  
     │   - Each order has ship dates from its respective collection                                                                                                                                   │  
     │ 3. Ship date validation:                                                                                                                                                                       │  
     │   - Try to submit with dates earlier than collection window                                                                                                                                    │  
     │   - Should receive validation error                                                                                                                                                            │  
     │ 4. Draft submission:                                                                                                                                                                           │  
     │   - Save as draft with items from 2 collections                                                                                                                                                │  
     │   - Submit draft → 2 separate orders created                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Branch Strategy                                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Create new branch from current HEAD:                                                                                                                                                           │  
     │ git checkout -b fix/revert-planned-shipments                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Post-Phase 1 Status                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ Working:                                                                                                                                                                                       │  
     │ - Orders split by collection ✓                                                                                                                                                                 │  
     │ - Each order has correct ship dates ✓                                                                                                                                                          │  
     │ - Ship window validation enforced ✓                                                                                                                                                            │  
     │ - Emails sent per order ✓                                                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ Still inconsistent (Phase 2):                                                                                                                                                                  │  
     │ - Modal language says "shipments" instead of "orders"                                                                                                                                          │  
     │ - Multi-shipment UI cards still visible (but ignored)                                                                                                                                          │  
     │ - Admin/rep tables show shipment counts                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Orphaned (Phase 3 cleanup):                                                                                                                                                                    │  
     │ - PlannedShipment table (unused)                                                                                                                                                               │  
     │ - Admin planned shipments UI components                                                                                                                                                        │  
     │ - Item movement feature                                                                                                                                                                        │  
     ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯  
                                                                                                                                                                                                         
❯ Careful review from Codex: I read the plan carefully. It’s solid and aligns with the canonical‑Collection decision, but there are two critical gaps and a couple of minor fixes you should add         
    to Phase 1 to avoid compile/runtime issues.                                                                                                                                                          
                                                                                                                                                                                                         
    Critical gaps to add to Phase 1                                                                                                                                                                      
                                                                                                                                                                                                         
    - Update updateOrder() in src/lib/data/actions/orders.ts.                                                                                                                                            
      You’re removing plannedShipments from UpdateOrderInput, but updateOrder() still references input.plannedShipments and planned‑shipment sync logic. That will fail                                  
      TypeScript (and is dead logic once planned shipments are removed).                                                                                                                                 
      Fix: Revert updateOrder() to the pre‑Phase‑5 block (the simple “update header + delete/insert items” version), or keep plannedShipments in the type for now. This                                  
      needs to be in Phase 1.                                                                                                                                                                            
    - Remove planned‑shipment imports in orders.ts.                                                                                                                                                      
      After swapping createOrder(), these imports become unused and may cause lint/type issues:                                                                                                          
      PlannedShipmentData, findShipmentIdForSku, deriveShipmentsFromItems, getMultiCollectionOverlap, logShipmentDatesOverride.                                                                          
      Fix: Remove those imports (and any now‑unused helper functions like getLegacyDatesFromShipments if you don’t want dead code).                                                                      
                                                                                                                                                                                                         
    Minor fixes / clarifications                                                                                                                                                                         
                                                                                                                                                                                                         
    - Email “salesRep” field in createOrder.                                                                                                                                                             
      The legacy snippet uses salesRep: data.storeName (from 8d9f99a). Current code uses actual rep data. Consider keeping the current behavior to avoid regression, even                                
      though it’s not required for Phase 1 correctness.                                                                                                                                                  
    - Validation logic vs. “later allowed.”                                                                                                                                                              
      Your per‑group validation is correct, but because ship dates are taken from firstItem.shipWindowStart/End when present, user‑entered later dates won’t be used. If                                 
      you want “later allowed” to actually take effect in Phase 1, ship dates should come from the form (and just be validated against collection windows).                                              
      If you want legacy behavior, keep your current approach—just be aware this means “later allowed” won’t happen until Phase 2.                                                                       
                                                                                                                                                                                                         
    Suggested plan tweak (minimal)                                                                                                                                                                       
                                                                                                                                                                                                         
    - Add File 1b: src/lib/data/actions/orders.ts — revert updateOrder() to pre‑planned‑shipment logic.                                                                                                  
    - Add cleanup line in File 1: remove unused planned‑shipment imports/functions.                                                                                                                      
                                                                                                                                                                                                         
    Everything else in your plan is coherent and implementable. If you want, I can append an exact pre‑Phase‑5 updateOrder() block for the plan (still read‑only).                                       
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › append an exact pre‑Phase‑5 updateOrder() block for the plan                                                                                                                                         
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • Ran git show 8d9f99a:src/lib/data/actions/orders.ts | sed -n '600,760p'                                                                                                                              
    └         orderId: o.orderId,                                                                                                                                                                        
              orderNumber: o.orderNumber,                                                                                                                                                                
      … +161 lines                                                                                                                                                                                       
      git: warning: confstr() failed with code 5: couldn't get path of DARWIN_USER_TEMP_DIR; using /tmp instead                                                                                          
      git: error: couldn't create cache file '/tmp/xcrun_db-bhZl13Wx' (errno=Operation not permitted)                                                                                                    
                                                                                                                                                                                                         
  • Ran git show 8d9f99a:src/lib/data/actions/orders.ts | sed -n '760,900p'                                                                                                                              
    └       success: true,                                                                                                                                                                               
            orderNumber: existingOrder.OrderNumber,                                                                                                                                                      
      … +141 lines                                                                                                                                                                                       
      git: warning: confstr() failed with code 5: couldn't get path of DARWIN_USER_TEMP_DIR; using /tmp instead                                                                                          
      git: error: couldn't create cache file '/tmp/xcrun_db-CqTKD7EC' (errno=Operation not permitted)                                                                                                    
                                                                                                                                                                                                         
  ─ Worked for 11s ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────                                
                                                                                                                                                                                                         
  • Here is the exact pre‑Phase‑5 updateOrder() block from 8d9f99a to append to your plan. It fully removes planned‑shipment syncing and restores the classic “update                                    
    header + replace items” behavior.                                                                                                                                                                    
                                                                                                                                                                                                         
    Where to use it:                                                                                                                                                                                     
    Replace the current updateOrder() implementation in src/lib/data/actions/orders.ts with the block below.                                                                                             
                                                                                                                                                                                                         
    // ============================================================================                                                                                                                      
    // Order Update (Edit Items)                                                                                                                                                                         
    // ============================================================================                                                                                                                      
                                                                                                                                                                                                         
    /**                                                                                                                                                                                                  
     * Update an existing order.                                                                                                                                                                         
     * Matches .NET MyOrder.aspx.cs behavior for edit mode:                                                                                                                                              
     * - Updates CustomerOrders header                                                                                                                                                                   
     * - Deletes old items, inserts new items                                                                                                                                                            
     * - Recalculates order amount                                                                                                                                                                       
     *                                                                                                                                                                                                   
     * @param input - Order update data                                                                                                                                                                  
     * @returns Success status with order number                                                                                                                                                         
     */                                                                                                                                                                                                  
    export async function updateOrder(                                                                                                                                                                   
      input: UpdateOrderInput                                                                                                                                                                            
    ): Promise<UpdateOrderResult> {                                                                                                                                                                      
      try {                                                                                                                                                                                              
        const { orderId, items, ...headerData } = input                                                                                                                                                  
                                                                                                                                                                                                         
        // Verify order exists and is editable                                                                                                                                                           
        const existingOrder = await prisma.customerOrders.findUnique({                                                                                                                                   
          where: { ID: BigInt(orderId) },                                                                                                                                                                
          select: {                                                                                                                                                                                      
            ID: true,                                                                                                                                                                                    
            OrderNumber: true,                                                                                                                                                                           
            OrderStatus: true,                                                                                                                                                                           
            IsTransferredToShopify: true,                                                                                                                                                                
          },                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        if (!existingOrder) {                                                                                                                                                                            
          return { success: false, error: 'Order not found' }                                                                                                                                            
        }                                                                                                                                                                                                
                                                                                                                                                                                                         
        // Check edit conditions: Pending AND NOT in Shopify                                                                                                                                             
        if (existingOrder.OrderStatus !== 'Pending') {                                                                                                                                                   
          return { success: false, error: 'Only Pending orders can be edited' }                                                                                                                          
        }                                                                                                                                                                                                
                                                                                                                                                                                                         
        if (existingOrder.IsTransferredToShopify) {                                                                                                                                                      
          return {                                                                                                                                                                                       
            success: false,                                                                                                                                                                              
            error: 'Orders transferred to Shopify cannot be edited',                                                                                                                                     
          }                                                                                                                                                                                              
        }                                                                                                                                                                                                
                                                                                                                                                                                                         
        // Calculate new total                                                                                                                                                                           
        const orderAmount = items.reduce(                                                                                                                                                                
          (sum, item) => sum + item.price * item.quantity,                                                                                                                                               
          0                                                                                                                                                                                              
        )                                                                                                                                                                                                
                                                                                                                                                                                                         
        // Update order in transaction                                                                                                                                                                   
        await prisma.$transaction(async (tx) => {                                                                                                                                                        
          // Look up rep by ID                                                                                                                                                                           
          const rep = await tx.reps.findUnique({                                                                                                                                                         
            where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                              
            select: { Name: true },                                                                                                                                                                      
          })                                                                                                                                                                                             
          if (!rep) {                                                                                                                                                                                    
            throw new Error('Invalid sales rep')                                                                                                                                                         
          }                                                                                                                                                                                              
          const salesRepName = rep.Name ?? ''                                                                                                                                                            
                                                                                                                                                                                                         
          // Update order header                                                                                                                                                                         
          await tx.customerOrders.update({                                                                                                                                                               
            where: { ID: BigInt(orderId) },                                                                                                                                                              
            data: {                                                                                                                                                                                      
              StoreName: headerData.storeName,                                                                                                                                                           
              BuyerName: headerData.buyerName,                                                                                                                                                           
              SalesRep: salesRepName,                                                                                                                                                                    
              CustomerEmail: headerData.customerEmail,                                                                                                                                                   
              CustomerPhone: headerData.customerPhone,                                                                                                                                                   
              Country: headerData.currency, // Legacy: stores currency                                                                                                                                   
              OrderAmount: orderAmount,                                                                                                                                                                  
              OrderNotes: headerData.orderNotes ?? '',                                                                                                                                                   
              CustomerPO: headerData.customerPO ?? '',                                                                                                                                                   
              ShipStartDate: new Date(headerData.shipStartDate),                                                                                                                                         
              ShipEndDate: new Date(headerData.shipEndDate),                                                                                                                                             
              Website: headerData.website ?? '',                                                                                                                                                         
            },                                                                                                                                                                                           
          })                                                                                                                                                                                             
                                                                                                                                                                                                         
          // Delete old items                                                                                                                                                                            
          await tx.customerOrdersItems.deleteMany({                                                                                                                                                      
            where: { CustomerOrderID: BigInt(orderId) },                                                                                                                                                 
          })                                                                                                                                                                                             
                                                                                                                                                                                                         
          // Insert new items                                                                                                                                                                            
          await tx.customerOrdersItems.createMany({                                                                                                                                                      
            data: items.map((item) => ({                                                                                                                                                                 
              CustomerOrderID: BigInt(orderId),                                                                                                                                                          
              OrderNumber: existingOrder.OrderNumber,                                                                                                                                                    
              SKU: item.sku,                                                                                                                                                                             
              SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                                   
              Quantity: item.quantity,                                                                                                                                                                   
              Price: item.price,                                                                                                                                                                         
              PriceCurrency: headerData.currency,                                                                                                                                                        
              Notes: '',                                                                                                                                                                                 
            })),                                                                                                                                                                                         
          })                                                                                                                                                                                             
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        revalidatePath('/admin/orders')                                                                                                                                                                  
        revalidatePath('/rep/orders')                                                                                                                                                                    
                                                                                                                                                                                                         
        // Look up the rep name for email                                                                                                                                                                
        const repForEmail = await prisma.reps.findUnique({                                                                                                                                               
          where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                                
          select: { Name: true },                                                                                                                                                                        
        })                                                                                                                                                                                               
        const salesRepName = repForEmail?.Name ?? ''                                                                                                                                                     
                                                                                                                                                                                                         
        // Send update notification emails (async, non-blocking)                                                                                                                                         
        // Email settings control whether update notifications are actually sent                                                                                                                         
        const currency = headerData.currency.toUpperCase().includes('CAD') ? 'CAD' : 'USD' as 'CAD' | 'USD'                                                                                              
        sendOrderEmails(                                                                                                                                                                                 
          {                                                                                                                                                                                              
            orderId: orderId,                                                                                                                                                                            
            orderNumber: existingOrder.OrderNumber,                                                                                                                                                      
            storeName: headerData.storeName,                                                                                                                                                             
            buyerName: headerData.buyerName,                                                                                                                                                             
            customerEmail: headerData.customerEmail,                                                                                                                                                     
            customerPhone: headerData.customerPhone,                                                                                                                                                     
            salesRep: salesRepName,                                                                                                                                                                      
            orderAmount: orderAmount,                                                                                                                                                                    
            currency: currency,                                                                                                                                                                          
            shipStartDate: new Date(headerData.shipStartDate),                                                                                                                                           
            shipEndDate: new Date(headerData.shipEndDate),                                                                                                                                               
            orderDate: new Date(), // Use current date for updates                                                                                                                                       
            orderNotes: headerData.orderNotes ?? '',                                                                                                                                                     
            customerPO: headerData.customerPO ?? '',                                                                                                                                                     
            items: items.map((item) => ({                                                                                                                                                                
              sku: item.sku,                                                                                                                                                                             
              quantity: item.quantity,                                                                                                                                                                   
              price: item.price,                                                                                                                                                                         
              lineTotal: item.price * item.quantity,                                                                                                                                                     
            })),                                                                                                                                                                                         
          },                                                                                                                                                                                             
          true // isUpdate = true                                                                                                                                                                        
        ).catch((err) => {                                                                                                                                                                               
          console.error('Failed to send order update emails:', err)                                                                                                                                      
        })                                                                                                                                                                                               
                                                                                                                                                                                                         
        return {                                                                                                                                                                                         
          success: true,                                                                                                                                                                                 
          orderNumber: existingOrder.OrderNumber,                                                                                                                                                        
        }                                                                                                                                                                                                
      } catch (e) {                                                                                                                                                                                      
        console.error('updateOrder error:', e)                                                                                                                                                           
        const message = e instanceof Error ? e.message : 'Failed to update order'                                                                                                                        
        return { success: false, error: message }                                                                                                                                                        
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ Let me update the plan with the updateOrder() block and the additional fixes.                                                                                                                          
                                                                                                                                                                                                         
⏺ Read 1 file (ctrl+o to expand)                                                                                                                                                                         
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ I've updated the plan to include:                                                                                                                                                                      
                                                                                                                                                                                                         
  1. File 1b: updateOrder() revert - Full pre-Phase-5 block that removes planned-shipment sync logic                                                                                                     
  2. File 1c: Import cleanup - List of imports/functions to remove to avoid lint/type errors                                                                                                             
  3. Additional test case - Edit existing order verification                                                                                                                                             
                                                                                                                                                                                                         
  The plan now addresses both critical gaps identified by Codex:                                                                                                                                         
  - updateOrder() no longer references input.plannedShipments                                                                                                                                            
  - Unused planned-shipment imports are explicitly called out for removal                                                                                                                                
  ⎿  User rejected Claude's plan:                                                                                                                                                                        
     ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮  
     │ Phase 1: Revert to Order Splitting (Collection-Based)                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Context                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ The PlannedShipment feature was built based on a misinterpretation of CEO feedback. The original order splitting behavior (one cart → multiple orders by collection) was actually correct and  │  
     │ preferred. This plan reverts to that behavior while keeping Collection as the canonical source for ship windows and PreOrder detection.                                                        │  
     │                                                                                                                                                                                                │  
     │ Pre-Implementation Decisions (Confirmed)                                                                                                                                                       │  
     │ ┌───────────────────────────┬────────────────────────────────────────────┬────────────────────────────────────┐                                                                                │  
     │ │         Decision          │                   Choice                   │             Rationale              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Ship window source        │ Collection (shipWindowStart/shipWindowEnd) │ Now canonical in prod              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PreOrder detection        │ Collection.type                            │ Consistent with current data model │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Missing collection window │ Block with error                           │ Enforce data quality               │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PlannedShipment table     │ Leave in place, don't populate             │ Avoid migration risk               │                                                                                │  
     │ └───────────────────────────┴────────────────────────────────────────────┴────────────────────────────────────┘                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Files to Change (5 files, 6 major changes)                                                                                                                                                     │  
     │ ┌─────┬─────────────────────────────────────────┬────────────────────────────────────────────────────────────────────┐                                                                         │  
     │ │  #  │                  File                   │                              Summary                               │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1a  │ src/lib/data/actions/orders.ts          │ Restore createOrder() grouping loop + per-group validation         │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1b  │ src/lib/data/actions/orders.ts          │ Revert updateOrder() to pre-Phase-5 (remove planned-shipment sync) │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1c  │ src/lib/data/actions/orders.ts          │ Remove unused planned-shipment imports                             │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 2   │ src/app/api/drafts/[id]/submit/route.ts │ Restore grouping + validation, add helper                          │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 3   │ src/lib/schemas/order.ts                │ Remove plannedShipments, use collection* fields                    │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 4   │ src/lib/types/order.ts                  │ Restore orders[] return type, simplify UpdateOrderInput            │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 5   │ src/components/buyer/order-form.tsx     │ Remove shipment validation block, handle orders[] response         │                                                                         │  
     │ └─────┴─────────────────────────────────────────┴────────────────────────────────────────────────────────────────────┘                                                                         │  
     │ ---                                                                                                                                                                                            │  
     │ File 1: src/lib/data/actions/orders.ts                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ Change: Replace createOrder() core logic                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Derive order type from SKU data (master source: Collection.type)                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the return { success: true, ... } with:                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Derive order type from SKU data (master source: Collection.type)                                                                                                                            │  
     │ const skuVariantIds = data.items.map((item) => BigInt(item.skuVariantId))                                                                                                                      │  
     │ const skuPreOrderMap = await deriveIsPreOrderFromSkus(skuVariantIds)                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof data.items>()                                                                                                                                        │  
     │ for (const item of data.items) {                                                                                                                                                               │  
     │   const key = _getOrderGroupKey(                                                                                                                                                               │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     data.items                                                                                                                                                                                 │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // ATS / uncategorized: no validation                                                                                                                                                        │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   // Block if any collection lacks windows                                                                                                                                                     │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Use the same ship dates that will be written to the order header                                                                                                                          │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? data.shipStartDate).split('T')[0]                                                                                                            │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? data.shipEndDate).split('T')[0]                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Invalid dates for ${names}: ${result.errors[0]?.message}`,                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof data.items                                                                                                                                                                     │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ // Create orders in a single transaction for atomicity                                                                                                                                         │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Look up rep by ID - fail if not found                                                                                                                                                     │  
     │   const rep = await tx.reps.findUnique({                                                                                                                                                       │  
     │     where: { ID: parseInt(data.salesRepId) },                                                                                                                                                  │  
     │     select: { Name: true, Code: true },                                                                                                                                                        │  
     │   })                                                                                                                                                                                           │  
     │   if (!rep) {                                                                                                                                                                                  │  
     │     throw new Error('Invalid sales rep')                                                                                                                                                       │  
     │   }                                                                                                                                                                                            │  
     │   const salesRepName = rep.Name ?? ''                                                                                                                                                          │  
     │   const salesRepCode = rep.Code?.trim() || rep.Name || ''                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │   // Determine customerId for strong ownership                                                                                                                                                 │  
     │   let customerId: number | null = data.customerId ?? null                                                                                                                                      │  
     │   if (!customerId) {                                                                                                                                                                           │  
     │     const existingByName = await tx.customers.findFirst({                                                                                                                                      │  
     │       where: { StoreName: data.storeName },                                                                                                                                                    │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │     if (existingByName) {                                                                                                                                                                      │  
     │       customerId = existingByName.ID                                                                                                                                                           │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     // Determine order type from first item's SKU (all items in group have same type)                                                                                                          │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Generate order number with appropriate prefix                                                                                                                                           │  
     │     const orderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │     // Calculate group total                                                                                                                                                                   │  
     │     const orderAmount = groupItems.reduce(                                                                                                                                                     │  
     │       (sum, item) => sum + item.price * item.quantity,                                                                                                                                         │  
     │       0                                                                                                                                                                                        │  
     │     )                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Use item's ship window if available, else form dates                                                                                                                                    │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(data.shipStartDate)                                                                                                                                                           │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(data.shipEndDate)                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │     // Create order header                                                                                                                                                                     │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         BuyerName: data.buyerName,                                                                                                                                                             │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: data.customerEmail,                                                                                                                                                     │  
     │         CustomerPhone: data.customerPhone,                                                                                                                                                     │  
     │         Country: data.currency, // Legacy: stores currency, not country                                                                                                                        │  
     │         OrderAmount: orderAmount,                                                                                                                                                              │  
     │         OrderNotes: data.orderNotes ?? '',                                                                                                                                                     │  
     │         CustomerPO: data.customerPO ?? '',                                                                                                                                                     │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder, // Derived from Collection.type                                                                                                                                │  
     │         RepID: parseInt(data.salesRepId),                                                                                                                                                      │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Create line items for this group (NO PlannedShipmentID)                                                                                                                                 │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map((item) => ({                                                                                                                                                        │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                               │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: data.currency,                                                                                                                                                          │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: newOrder.ID.toString(),                                                                                                                                                         │  
     │       orderNumber,                                                                                                                                                                             │  
     │       collectionName: firstItem.collectionName ?? null,                                                                                                                                        │  
     │       shipWindowStart: firstItem.shipWindowStart ?? null,                                                                                                                                      │  
     │       shipWindowEnd: firstItem.shipWindowEnd ?? null,                                                                                                                                          │  
     │       orderAmount,                                                                                                                                                                             │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Find or create customer (only once, not per order)                                                                                                                                        │  
     │   const existingCustomer = await tx.customers.findFirst({                                                                                                                                      │  
     │     where: { StoreName: data.storeName },                                                                                                                                                      │  
     │     select: { ID: true, OrderCount: true },                                                                                                                                                    │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   if (existingCustomer) {                                                                                                                                                                      │  
     │     await tx.customers.update({                                                                                                                                                                │  
     │       where: { ID: existingCustomer.ID },                                                                                                                                                      │  
     │       data: {                                                                                                                                                                                  │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: (existingCustomer.OrderCount ?? 0) + createdOrders.length,                                                                                                                 │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   } else {                                                                                                                                                                                     │  
     │     // Create new customer and update all orders with CustomerID                                                                                                                               │  
     │     const newCustomer = await tx.customers.create({                                                                                                                                            │  
     │       data: {                                                                                                                                                                                  │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         FirstOrderDate: new Date(),                                                                                                                                                            │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: createdOrders.length,                                                                                                                                                      │  
     │       },                                                                                                                                                                                       │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Update all created orders with new customer's ID                                                                                                                                        │  
     │     for (const order of createdOrders) {                                                                                                                                                       │  
     │       await tx.customerOrders.update({                                                                                                                                                         │  
     │         where: { ID: BigInt(order.orderId) },                                                                                                                                                  │  
     │         data: { CustomerID: newCustomer.ID },                                                                                                                                                  │  
     │       })                                                                                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send order confirmation emails (non-blocking) unless skipEmail is set                                                                                                                       │  
     │ if (!data.skipEmail) {                                                                                                                                                                         │  
     │   for (const order of createdOrders) {                                                                                                                                                         │  
     │     sendOrderEmails({                                                                                                                                                                          │  
     │       orderId: order.orderId,                                                                                                                                                                  │  
     │       orderNumber: order.orderNumber,                                                                                                                                                          │  
     │       storeName: data.storeName,                                                                                                                                                               │  
     │       buyerName: data.buyerName,                                                                                                                                                               │  
     │       customerEmail: data.customerEmail,                                                                                                                                                       │  
     │       customerPhone: data.customerPhone,                                                                                                                                                       │  
     │       salesRep: data.storeName,                                                                                                                                                                │  
     │       orderAmount: order.orderAmount,                                                                                                                                                          │  
     │       currency: data.currency,                                                                                                                                                                 │  
     │       shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(data.shipStartDate),                                                                                   │  
     │       shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(data.shipEndDate),                                                                                           │  
     │       orderDate: new Date(),                                                                                                                                                                   │  
     │       orderNotes: data.orderNotes,                                                                                                                                                             │  
     │       customerPO: data.customerPO,                                                                                                                                                             │  
     │       items: order.items.map((item) => ({                                                                                                                                                      │  
     │         sku: item.sku,                                                                                                                                                                         │  
     │         quantity: item.quantity,                                                                                                                                                               │  
     │         price: item.price,                                                                                                                                                                     │  
     │         lineTotal: item.price * item.quantity,                                                                                                                                                 │  
     │       })),                                                                                                                                                                                     │  
     │     }).catch((err) => {                                                                                                                                                                        │  
     │       console.error(`Order email error for ${order.orderNumber}:`, err)                                                                                                                        │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ revalidatePath('/admin/orders')                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ // Return first order for backwards compatibility, plus full orders array                                                                                                                      │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return {                                                                                                                                                                                       │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map((o) => ({                                                                                                                                                          │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 1b: src/lib/data/actions/orders.ts - Revert updateOrder()                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ Change: Replace entire updateOrder() function with pre-Phase-5 version                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ The current updateOrder() references input.plannedShipments and has planned-shipment sync logic that will fail TypeScript once plannedShipments is removed from the type.                      │  
     │                                                                                                                                                                                                │  
     │ Replace the entire updateOrder() function with:                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ // ============================================================================                                                                                                                │  
     │ // Order Update (Edit Items)                                                                                                                                                                   │  
     │ // ============================================================================                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ /**                                                                                                                                                                                            │  
     │  * Update an existing order.                                                                                                                                                                   │  
     │  * Matches .NET MyOrder.aspx.cs behavior for edit mode:                                                                                                                                        │  
     │  * - Updates CustomerOrders header                                                                                                                                                             │  
     │  * - Deletes old items, inserts new items                                                                                                                                                      │  
     │  * - Recalculates order amount                                                                                                                                                                 │  
     │  *                                                                                                                                                                                             │  
     │  * @param input - Order update data                                                                                                                                                            │  
     │  * @returns Success status with order number                                                                                                                                                   │  
     │  */                                                                                                                                                                                            │  
     │ export async function updateOrder(                                                                                                                                                             │  
     │   input: UpdateOrderInput                                                                                                                                                                      │  
     │ ): Promise<UpdateOrderResult> {                                                                                                                                                                │  
     │   try {                                                                                                                                                                                        │  
     │     const { orderId, items, ...headerData } = input                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │     // Verify order exists and is editable                                                                                                                                                     │  
     │     const existingOrder = await prisma.customerOrders.findUnique({                                                                                                                             │  
     │       where: { ID: BigInt(orderId) },                                                                                                                                                          │  
     │       select: {                                                                                                                                                                                │  
     │         ID: true,                                                                                                                                                                              │  
     │         OrderNumber: true,                                                                                                                                                                     │  
     │         OrderStatus: true,                                                                                                                                                                     │  
     │         IsTransferredToShopify: true,                                                                                                                                                          │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     if (!existingOrder) {                                                                                                                                                                      │  
     │       return { success: false, error: 'Order not found' }                                                                                                                                      │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Check edit conditions: Pending AND NOT in Shopify                                                                                                                                       │  
     │     if (existingOrder.OrderStatus !== 'Pending') {                                                                                                                                             │  
     │       return { success: false, error: 'Only Pending orders can be edited' }                                                                                                                    │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     if (existingOrder.IsTransferredToShopify) {                                                                                                                                                │  
     │       return {                                                                                                                                                                                 │  
     │         success: false,                                                                                                                                                                        │  
     │         error: 'Orders transferred to Shopify cannot be edited',                                                                                                                               │  
     │       }                                                                                                                                                                                        │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Calculate new total                                                                                                                                                                     │  
     │     const orderAmount = items.reduce(                                                                                                                                                          │  
     │       (sum, item) => sum + item.price * item.quantity,                                                                                                                                         │  
     │       0                                                                                                                                                                                        │  
     │     )                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Update order in transaction                                                                                                                                                             │  
     │     await prisma.$transaction(async (tx) => {                                                                                                                                                  │  
     │       // Look up rep by ID                                                                                                                                                                     │  
     │       const rep = await tx.reps.findUnique({                                                                                                                                                   │  
     │         where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                        │  
     │         select: { Name: true },                                                                                                                                                                │  
     │       })                                                                                                                                                                                       │  
     │       if (!rep) {                                                                                                                                                                              │  
     │         throw new Error('Invalid sales rep')                                                                                                                                                   │  
     │       }                                                                                                                                                                                        │  
     │       const salesRepName = rep.Name ?? ''                                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │       // Update order header                                                                                                                                                                   │  
     │       await tx.customerOrders.update({                                                                                                                                                         │  
     │         where: { ID: BigInt(orderId) },                                                                                                                                                        │  
     │         data: {                                                                                                                                                                                │  
     │           StoreName: headerData.storeName,                                                                                                                                                     │  
     │           BuyerName: headerData.buyerName,                                                                                                                                                     │  
     │           SalesRep: salesRepName,                                                                                                                                                              │  
     │           CustomerEmail: headerData.customerEmail,                                                                                                                                             │  
     │           CustomerPhone: headerData.customerPhone,                                                                                                                                             │  
     │           Country: headerData.currency, // Legacy: stores currency                                                                                                                             │  
     │           OrderAmount: orderAmount,                                                                                                                                                            │  
     │           OrderNotes: headerData.orderNotes ?? '',                                                                                                                                             │  
     │           CustomerPO: headerData.customerPO ?? '',                                                                                                                                             │  
     │           ShipStartDate: new Date(headerData.shipStartDate),                                                                                                                                   │  
     │           ShipEndDate: new Date(headerData.shipEndDate),                                                                                                                                       │  
     │           Website: headerData.website ?? '',                                                                                                                                                   │  
     │         },                                                                                                                                                                                     │  
     │       })                                                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │       // Delete old items                                                                                                                                                                      │  
     │       await tx.customerOrdersItems.deleteMany({                                                                                                                                                │  
     │         where: { CustomerOrderID: BigInt(orderId) },                                                                                                                                           │  
     │       })                                                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │       // Insert new items (NO PlannedShipmentID)                                                                                                                                               │  
     │       await tx.customerOrdersItems.createMany({                                                                                                                                                │  
     │         data: items.map((item) => ({                                                                                                                                                           │  
     │           CustomerOrderID: BigInt(orderId),                                                                                                                                                    │  
     │           OrderNumber: existingOrder.OrderNumber,                                                                                                                                              │  
     │           SKU: item.sku,                                                                                                                                                                       │  
     │           SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                             │  
     │           Quantity: item.quantity,                                                                                                                                                             │  
     │           Price: item.price,                                                                                                                                                                   │  
     │           PriceCurrency: headerData.currency,                                                                                                                                                  │  
     │           Notes: '',                                                                                                                                                                           │  
     │         })),                                                                                                                                                                                   │  
     │       })                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     revalidatePath('/admin/orders')                                                                                                                                                            │  
     │     revalidatePath('/rep/orders')                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │     // Look up the rep name for email                                                                                                                                                          │  
     │     const repForEmail = await prisma.reps.findUnique({                                                                                                                                         │  
     │       where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                          │  
     │       select: { Name: true },                                                                                                                                                                  │  
     │     })                                                                                                                                                                                         │  
     │     const salesRepName = repForEmail?.Name ?? ''                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │     // Send update notification emails (async, non-blocking)                                                                                                                                   │  
     │     const currency = headerData.currency.toUpperCase().includes('CAD') ? 'CAD' : 'USD' as 'CAD' | 'USD'                                                                                        │  
     │     sendOrderEmails(                                                                                                                                                                           │  
     │       {                                                                                                                                                                                        │  
     │         orderId: orderId,                                                                                                                                                                      │  
     │         orderNumber: existingOrder.OrderNumber,                                                                                                                                                │  
     │         storeName: headerData.storeName,                                                                                                                                                       │  
     │         buyerName: headerData.buyerName,                                                                                                                                                       │  
     │         customerEmail: headerData.customerEmail,                                                                                                                                               │  
     │         customerPhone: headerData.customerPhone,                                                                                                                                               │  
     │         salesRep: salesRepName,                                                                                                                                                                │  
     │         orderAmount: orderAmount,                                                                                                                                                              │  
     │         currency: currency,                                                                                                                                                                    │  
     │         shipStartDate: new Date(headerData.shipStartDate),                                                                                                                                     │  
     │         shipEndDate: new Date(headerData.shipEndDate),                                                                                                                                         │  
     │         orderDate: new Date(),                                                                                                                                                                 │  
     │         orderNotes: headerData.orderNotes ?? '',                                                                                                                                               │  
     │         customerPO: headerData.customerPO ?? '',                                                                                                                                               │  
     │         items: items.map((item) => ({                                                                                                                                                          │  
     │           sku: item.sku,                                                                                                                                                                       │  
     │           quantity: item.quantity,                                                                                                                                                             │  
     │           price: item.price,                                                                                                                                                                   │  
     │           lineTotal: item.price * item.quantity,                                                                                                                                               │  
     │         })),                                                                                                                                                                                   │  
     │       },                                                                                                                                                                                       │  
     │       true // isUpdate = true                                                                                                                                                                  │  
     │     ).catch((err) => {                                                                                                                                                                         │  
     │       console.error('Failed to send order update emails:', err)                                                                                                                                │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     return {                                                                                                                                                                                   │  
     │       success: true,                                                                                                                                                                           │  
     │       orderNumber: existingOrder.OrderNumber,                                                                                                                                                  │  
     │     }                                                                                                                                                                                          │  
     │   } catch (e) {                                                                                                                                                                                │  
     │     console.error('updateOrder error:', e)                                                                                                                                                     │  
     │     const message = e instanceof Error ? e.message : 'Failed to update order'                                                                                                                  │  
     │     return { success: false, error: message }                                                                                                                                                  │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 1c: src/lib/data/actions/orders.ts - Remove Unused Imports                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change: Remove planned-shipment imports that become unused                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ After reverting createOrder() and updateOrder(), these imports/functions are no longer used and should be removed to avoid lint/type errors:                                                   │  
     │                                                                                                                                                                                                │  
     │ Remove these imports (if present):                                                                                                                                                             │  
     │ // Remove these - no longer used after revert:                                                                                                                                                 │  
     │ // import { PlannedShipmentData } from ...                                                                                                                                                     │  
     │ // import { findShipmentIdForSku } from ...                                                                                                                                                    │  
     │ // import { deriveShipmentsFromItems } from ...                                                                                                                                                │  
     │ // import { getMultiCollectionOverlap } from ...                                                                                                                                               │  
     │ // import { logShipmentDatesOverride } from ...                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Also remove these helper functions if they exist in the file and are now unused:                                                                                                               │  
     │ - getLegacyDatesFromShipments()                                                                                                                                                                │  
     │ - deriveShipmentsFromItems()                                                                                                                                                                   │  
     │ - Any other planned-shipment-specific helpers                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ Keep these (still used):                                                                                                                                                                       │  
     │ - _getOrderGroupKey() - used for grouping                                                                                                                                                      │  
     │ - deriveIsPreOrderFromSkus() - used for PreOrder detection                                                                                                                                     │  
     │ - validateShipDates() - used for per-group validation                                                                                                                                          │  
     │ - getNextOrderNumber() - used for order number generation                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 2: src/app/api/drafts/[id]/submit/route.ts                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change A: Add getOrderGroupKey helper near top of file                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ function getOrderGroupKey(                                                                                                                                                                     │  
     │   item: { collectionId?: number | null; skuVariantId: bigint },                                                                                                                                │  
     │   skuPreOrderMap: Map<string, boolean>                                                                                                                                                         │  
     │ ): string {                                                                                                                                                                                    │  
     │   const isPreOrder = skuPreOrderMap.get(String(item.skuVariantId)) ?? false                                                                                                                    │  
     │   const typePrefix = isPreOrder ? 'preorder' : 'ats'                                                                                                                                           │  
     │   if (item.collectionId) return `${typePrefix}-collection-${item.collectionId}`                                                                                                                │  
     │   return `${typePrefix}-default`                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace submission logic                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Phase 9: Use planned shipments instead of splitting orders                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the JSON response with:                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof items>()                                                                                                                                             │  
     │ for (const item of items) {                                                                                                                                                                    │  
     │   const key = getOrderGroupKey(                                                                                                                                                                │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     items                                                                                                                                                                                      │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Cannot validate ship dates: ${names} missing ship window dates.` },                                                                                                            │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? formData.shipStartDate).split('T')[0]                                                                                                        │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? formData.shipEndDate).split('T')[0]                                                                                                              │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Invalid dates for ${names}: ${result.errors[0]?.message}` },                                                                                                                   │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const currency = formData.currency || 'CAD'                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof items                                                                                                                                                                          │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Delete the draft first (we'll create new orders)                                                                                                                                          │  
     │   await tx.customerOrdersItems.deleteMany({                                                                                                                                                    │  
     │     where: { CustomerOrderID: draft.ID },                                                                                                                                                      │  
     │   })                                                                                                                                                                                           │  
     │   await tx.customerOrders.delete({                                                                                                                                                             │  
     │     where: { ID: draft.ID },                                                                                                                                                                   │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │     const groupOrderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                              │  
     │     const groupAmount = groupItems.reduce((sum, item) => sum + item.price * item.quantity, 0)                                                                                                  │  
     │                                                                                                                                                                                                │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(formData.shipStartDate)                                                                                                                                                       │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(formData.shipEndDate)                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         BuyerName: formData.buyerName,                                                                                                                                                         │  
     │         StoreName: formData.storeName,                                                                                                                                                         │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: formData.customerEmail,                                                                                                                                                 │  
     │         CustomerPhone: formData.customerPhone,                                                                                                                                                 │  
     │         Country: currency,                                                                                                                                                                     │  
     │         OrderAmount: groupAmount,                                                                                                                                                              │  
     │         OrderNotes: formData.orderNotes || '',                                                                                                                                                 │  
     │         CustomerPO: formData.customerPO || '',                                                                                                                                                 │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: formData.website || '',                                                                                                                                                       │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder,                                                                                                                                                                │  
     │         RepID: parseInt(formData.salesRepId),                                                                                                                                                  │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map(item => ({                                                                                                                                                          │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: item.skuVariantId,                                                                                                                                                       │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: currency,                                                                                                                                                               │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: String(newOrder.ID),                                                                                                                                                            │  
     │       orderNumber: groupOrderNumber,                                                                                                                                                           │  
     │       collectionName: firstItem.collectionName,                                                                                                                                                │  
     │       shipWindowStart: firstItem.shipWindowStart,                                                                                                                                              │  
     │       shipWindowEnd: firstItem.shipWindowEnd,                                                                                                                                                  │  
     │       orderAmount: groupAmount,                                                                                                                                                                │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send confirmation emails for each created order (non-blocking)                                                                                                                              │  
     │ for (const order of createdOrders) {                                                                                                                                                           │  
     │   sendOrderEmails({                                                                                                                                                                            │  
     │     orderId: order.orderId,                                                                                                                                                                    │  
     │     orderNumber: order.orderNumber,                                                                                                                                                            │  
     │     storeName: formData.storeName,                                                                                                                                                             │  
     │     buyerName: formData.buyerName,                                                                                                                                                             │  
     │     salesRep: salesRepName,                                                                                                                                                                    │  
     │     customerEmail: formData.customerEmail,                                                                                                                                                     │  
     │     customerPhone: formData.customerPhone,                                                                                                                                                     │  
     │     shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(formData.shipStartDate),                                                                                 │  
     │     shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(formData.shipEndDate),                                                                                         │  
     │     orderDate: new Date(),                                                                                                                                                                     │  
     │     orderNotes: formData.orderNotes,                                                                                                                                                           │  
     │     customerPO: formData.customerPO,                                                                                                                                                           │  
     │     items: order.items.map(i => ({                                                                                                                                                             │  
     │       sku: i.sku,                                                                                                                                                                              │  
     │       quantity: i.quantity,                                                                                                                                                                    │  
     │       price: i.price,                                                                                                                                                                          │  
     │       lineTotal: i.price * i.quantity,                                                                                                                                                         │  
     │     })),                                                                                                                                                                                       │  
     │     currency,                                                                                                                                                                                  │  
     │     orderAmount: order.orderAmount,                                                                                                                                                            │  
     │   }).catch(err => {                                                                                                                                                                            │  
     │     console.error(`Failed to send order emails for ${order.orderNumber}:`, err)                                                                                                                │  
     │   })                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return NextResponse.json({                                                                                                                                                                     │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map(o => ({                                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 3: src/lib/schemas/order.ts                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Change: Replace orderItemSchema and createOrderInputSchema                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Remove the plannedShipmentSchema definition entirely.                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Replace orderItemSchema with:                                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ export const orderItemSchema = z.object({                                                                                                                                                      │  
     │   sku: z.string().min(1),                                                                                                                                                                      │  
     │   skuVariantId: z.union([z.bigint(), z.number()]),                                                                                                                                             │  
     │   quantity: z.number().int().positive(),                                                                                                                                                       │  
     │   price: z.number().nonnegative(),                                                                                                                                                             │  
     │   // Collection is the source for order splitting and pre-order detection                                                                                                                      │  
     │   collectionId: z.number().nullable().optional(),                                                                                                                                              │  
     │   collectionName: z.string().nullable().optional(),                                                                                                                                            │  
     │   // Ship window dates from Collection                                                                                                                                                         │  
     │   shipWindowStart: z.string().nullable().optional(),                                                                                                                                           │  
     │   shipWindowEnd: z.string().nullable().optional(),                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ export type OrderItem = z.infer<typeof orderItemSchema>                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Replace createOrderInputSchema with:                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ export const createOrderInputSchema = orderFormSchema.extend({                                                                                                                                 │  
     │   currency: z.enum(['USD', 'CAD']),                                                                                                                                                            │  
     │   items: z.array(orderItemSchema).min(1, 'Order must have at least one item'),                                                                                                                 │  
     │   isPreOrder: z.boolean().optional(),                                                                                                                                                          │  
     │   customerId: z.number().int().positive().nullable().optional(),                                                                                                                               │  
     │   skipEmail: z.boolean().optional(),                                                                                                                                                           │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 4: src/lib/types/order.ts                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ Change: Replace CreateOrderResult and UpdateOrderInput                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ export interface CreateOrderResult {                                                                                                                                                           │  
     │   success: boolean                                                                                                                                                                             │  
     │   orderId?: string                                                                                                                                                                             │  
     │   orderNumber?: string                                                                                                                                                                         │  
     │   orders?: Array<{                                                                                                                                                                             │  
     │     orderId: string                                                                                                                                                                            │  
     │     orderNumber: string                                                                                                                                                                        │  
     │     collectionName: string | null                                                                                                                                                              │  
     │     shipWindowStart: string | null                                                                                                                                                             │  
     │     shipWindowEnd: string | null                                                                                                                                                               │  
     │     orderAmount?: number                                                                                                                                                                       │  
     │   }>                                                                                                                                                                                           │  
     │   error?: string                                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ export interface UpdateOrderInput {                                                                                                                                                            │  
     │   orderId: string                                                                                                                                                                              │  
     │   storeName: string                                                                                                                                                                            │  
     │   buyerName: string                                                                                                                                                                            │  
     │   salesRepId: string                                                                                                                                                                           │  
     │   customerEmail: string                                                                                                                                                                        │  
     │   customerPhone: string                                                                                                                                                                        │  
     │   currency: 'USD' | 'CAD'                                                                                                                                                                      │  
     │   shipStartDate: string                                                                                                                                                                        │  
     │   shipEndDate: string                                                                                                                                                                          │  
     │   orderNotes?: string                                                                                                                                                                          │  
     │   customerPO?: string                                                                                                                                                                          │  
     │   website?: string                                                                                                                                                                             │  
     │   items: Array<{                                                                                                                                                                               │  
     │     sku: string                                                                                                                                                                                │  
     │     skuVariantId: number                                                                                                                                                                       │  
     │     quantity: number                                                                                                                                                                           │  
     │     price: number                                                                                                                                                                              │  
     │   }>                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 5: src/components/buyer/order-form.tsx                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ Change A: Remove shipment validation guard at top of onSubmit                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ Replace the start of onSubmit with:                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ const onSubmit = async (data: OrderFormData) => {                                                                                                                                              │  
     │   if (isSubmitting) return // Prevent double-click                                                                                                                                             │  
     │   setIsSubmitting(true)                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ (Remove the hasShipmentValidationErrors && !overrideConfirmed check if present)                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace createOrder payload                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Find the createOrder({ call and replace the payload with:                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ const result = await createOrder({                                                                                                                                                             │  
     │   ...data,                                                                                                                                                                                     │  
     │   currency,                                                                                                                                                                                    │  
     │   items: cartItems.map((item) => ({                                                                                                                                                            │  
     │     sku: item.sku,                                                                                                                                                                             │  
     │     skuVariantId: item.skuVariantId,                                                                                                                                                           │  
     │     quantity: item.quantity,                                                                                                                                                                   │  
     │     price: item.price,                                                                                                                                                                         │  
     │     collectionId: item.collectionId,                                                                                                                                                           │  
     │     collectionName: item.collectionName,                                                                                                                                                       │  
     │     shipWindowStart: item.shipWindowStart,                                                                                                                                                     │  
     │     shipWindowEnd: item.shipWindowEnd,                                                                                                                                                         │  
     │   })),                                                                                                                                                                                         │  
     │   isPreOrder,                                                                                                                                                                                  │  
     │   customerId: selectedCustomerId,                                                                                                                                                              │  
     │   skipEmail: true,                                                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Change C: Handle orders[] response                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Replace the success handling block with:                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ if (result.success && result.orders?.length) {                                                                                                                                                 │  
     │   // Store order summaries for the modal (orders[] is the canonical return)                                                                                                                    │  
     │   setSubmittedShipments(result.orders.map((o) => ({                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount ?? orderTotal,                                                                                                                                                  │  
     │   })))                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else if (result.success && result.orderId) {                                                                                                                                                 │  
     │   // Backwards compatibility: single order without orders array                                                                                                                                │  
     │   setSubmittedShipments([{                                                                                                                                                                     │  
     │     orderId: result.orderId,                                                                                                                                                                   │  
     │     orderNumber: result.orderNumber || '',                                                                                                                                                     │  
     │     collectionName: null,                                                                                                                                                                      │  
     │     shipWindowStart: null,                                                                                                                                                                     │  
     │     shipWindowEnd: null,                                                                                                                                                                       │  
     │     orderAmount: orderTotal,                                                                                                                                                                   │  
     │   }])                                                                                                                                                                                          │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else {                                                                                                                                                                                       │  
     │   toast.error(result.error || 'Failed to create order')                                                                                                                                        │  
     │   setIsSubmitting(false)                                                                                                                                                                       │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Verification                                                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ Automated Checks                                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ npm run type-check   # No type errors                                                                                                                                                          │  
     │ npm run lint         # No lint errors                                                                                                                                                          │  
     │ npm run build        # Builds successfully                                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Manual Testing                                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ 1. Single collection order:                                                                                                                                                                    │  
     │   - Add items from 1 collection to cart                                                                                                                                                        │  
     │   - Submit → 1 order created                                                                                                                                                                   │  
     │   - Verify order has correct ship dates from collection                                                                                                                                        │  
     │ 2. Multi-collection order (split test):                                                                                                                                                        │  
     │   - Add items from 2 different collections to cart                                                                                                                                             │  
     │   - Submit → 2 separate orders created (different order numbers)                                                                                                                               │  
     │   - Each order has ship dates from its respective collection                                                                                                                                   │  
     │ 3. Ship date validation:                                                                                                                                                                       │  
     │   - Try to submit with dates earlier than collection window                                                                                                                                    │  
     │   - Should receive validation error                                                                                                                                                            │  
     │ 4. Draft submission:                                                                                                                                                                           │  
     │   - Save as draft with items from 2 collections                                                                                                                                                │  
     │   - Submit draft → 2 separate orders created                                                                                                                                                   │  
     │ 5. Edit existing order:                                                                                                                                                                        │  
     │   - Open an existing Pending order in edit mode                                                                                                                                                │  
     │   - Modify items/quantities                                                                                                                                                                    │  
     │   - Save → Order updated without errors                                                                                                                                                        │  
     │   - Verify no planned-shipment related errors                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Branch Strategy                                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Create new branch from current HEAD:                                                                                                                                                           │  
     │ git checkout -b fix/revert-planned-shipments                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Post-Phase 1 Status                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ Working:                                                                                                                                                                                       │  
     │ - Orders split by collection ✓                                                                                                                                                                 │  
     │ - Each order has correct ship dates ✓                                                                                                                                                          │  
     │ - Ship window validation enforced ✓                                                                                                                                                            │  
     │ - Emails sent per order ✓                                                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ Still inconsistent (Phase 2):                                                                                                                                                                  │  
     │ - Modal language says "shipments" instead of "orders"                                                                                                                                          │  
     │ - Multi-shipment UI cards still visible (but ignored)                                                                                                                                          │  
     │ - Admin/rep tables show shipment counts                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Orphaned (Phase 3 cleanup):                                                                                                                                                                    │  
     │ - PlannedShipment table (unused)                                                                                                                                                               │  
     │ - Admin planned shipments UI components                                                                                                                                                        │  
     │ - Item movement feature                                                                                                                                                                        │  
     ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯  
                                                                                                                                                                                                         
❯ Here is the latest review with Codex as engineering advisor to sharpen the plan: I've updated the plan to include:                                                                                     
                                                                                                                                                                                                         
      1. File 1b: updateOrder() revert - Full pre-Phase-5 block that removes planned-shipment sync logic                                                                                                 
      2. File 1c: Import cleanup - List of imports/functions to remove to avoid lint/type errors                                                                                                         
      3. Additional test case - Edit existing order verification                                                                                                                                         
                                                                                                                                                                                                         
      The plan now addresses both critical gaps identified by Codex:                                                                                                                                     
      - updateOrder() no longer references input.plannedShipments                                                                                                                                        
      - Unused planned-shipment imports are explicitly called out for removal                                                                                                                            
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • I'm preparing to read the specified file to verify the updated plan before proceeding.                                                                                                               
                                                                                                                                                                                                         
  • Explored                                                                                                                                                                                             
    └ Read curious-baking-melody.md                                                                                                                                                                      
                                                                                                                                                                                                         
  • The import cleanup plan rightly removes obsolete items including PlannedShipmentData, adjusting the orders.ts imports accordingly. The email send uses an outdated                                   
    salesRep field—consider updating to the actual rep later but not urgent now. The current ship window presence check may miss collections absent from the map, risking                                
    missed missing-window detection; this needs tightening to fully validate all required groups.                                                                                                        
                                                                                                                                                                                                         
    Highlighting validation gaps and import cleanup details                                                                                                                                              
                                                                                                                                                                                                         
    The plan properly removes planned-shipment imports and types, with needed tweaks to orders.ts imports. It needs a guard to error if groupCollectionIds are missing                                   
    from the map to avoid skipped validation. The current approach always using collection windows for ship dates may block allowing later user dates, which contradicts                                 
    stated requirements—consider adjusting to use form dates validated against collection windows. Leftover unused state in order-form might trigger lint warnings but                                   
    isn't urgent. Also, keeping salesRep as storeName risks degrading email precision but can be deferred. Overall the plan looks solid with these minor adjustments                                     
    recommended.                                                                                                                                                                                         
                                                                                                                                                                                                         
  ─ Worked for 52s ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────                                
                                                                                                                                                                                                         
  • Plan looks solid now — the two critical gaps are covered. I only see a few remaining nits worth adding as small clarifications so Phase 1 doesn’t surprise you:                                      
                                                                                                                                                                                                         
    Remaining tweaks to consider adding                                                                                                                                                                  
                                                                                                                                                                                                         
    - Import cleanup detail: after removing planned‑shipment types, also remove PlannedShipmentData from the createOrderInputSchema import in src/lib/data/actions/                                      
      orders.ts. Otherwise TS will fail once the type is deleted.                                                                                                                                        
    - Validation edge case: in both createOrder() and draft submit, the validation block filters out undefined collections. If a collection ID is missing in the DB, the                                 
      group gets treated as “ATS/no validation.” Consider guarding for groupCollectionIds.length > 0 && groupCollections.length === 0 → error, so missing collections                                    
      don’t silently skip validation.                                                                                                                                                                    
    - “Later dates allowed” behavior: the current plan writes ship dates from collection windows when present (same as old behavior). If you want to honor the “later                                    
      allowed” rule, you should use form dates for the order header and only validate they are not earlier than the collection window. That’s a business decision; Phase                                 
      1 can keep legacy behavior, but call it out explicitly.                                                                                                                                            
                                                                                                                                                                                                         
    Everything else reads clean and implementable. If you want, I can draft a short addendum section for the plan that includes the two guard clauses + the optional                                     
    “later allowed” alternative.                                                                                                                                                                         
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  › draft a short addendum section for the plan that includes the two guard clauses + the optional                                                                                                       
      “later allowed” alternative.                                                                                                                                                                       
                                                                                                                                                                                                         
                                                                                                                                                                                                         
  • Addendum: Edge‑Case Guards + Optional “Later Allowed” Behavior                                                                                                                                       
                                                                                                                                                                                                         
    A) Guard: Missing collections should not silently skip validation                                                                                                                                    
    In both createOrder() and draft submit validation blocks, add a safeguard:                                                                                                                           
                                                                                                                                                                                                         
    if (groupCollectionIds.length > 0 && groupCollections.length === 0) {                                                                                                                                
      return {                                                                                                                                                                                           
        success: false,                                                                                                                                                                                  
        error: 'Cannot validate ship dates: collection records missing for one or more items.',                                                                                                          
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    (For draft submit, return NextResponse.json({ error: ... }, { status: 400 }).)                                                                                                                       
                                                                                                                                                                                                         
    B) Guard: Missing window dates should be explicit                                                                                                                                                    
    Already included, but call out explicitly that the error is blocking (no override in Phase 1):                                                                                                       
                                                                                                                                                                                                         
    if (missingWindows.length > 0) {                                                                                                                                                                     
      const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                            
      return {                                                                                                                                                                                           
        success: false,                                                                                                                                                                                  
        error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                        
      }                                                                                                                                                                                                  
    }                                                                                                                                                                                                    
                                                                                                                                                                                                         
    C) Optional “Later Allowed” Alternative (Business Rule‑Aligned)                                                                                                                                      
    If you want to allow reps/customers to set later ship dates, use the form dates for the order header and keep validation as “not earlier than collection window.”                                    
    Replace:                                                                                                                                                                                             
                                                                                                                                                                                                         
    const shipStart = firstItem.shipWindowStart                                                                                                                                                          
      ? new Date(firstItem.shipWindowStart)                                                                                                                                                              
      : new Date(data.shipStartDate)                                                                                                                                                                     
    const shipEnd = firstItem.shipWindowEnd                                                                                                                                                              
      ? new Date(firstItem.shipWindowEnd)                                                                                                                                                                
      : new Date(data.shipEndDate)                                                                                                                                                                       
                                                                                                                                                                                                         
    with:                                                                                                                                                                                                
                                                                                                                                                                                                         
    const shipStart = new Date(data.shipStartDate)                                                                                                                                                       
    const shipEnd = new Date(data.shipEndDate)                                                                                                                                                           
                                                                                                                                                                                                         
    (and keep the validation block intact). This preserves the “later allowed” requirement without planned shipments.                                                                                    
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ I've added the addendum section to the plan with:                                                                                                                                                      
                                                                                                                                                                                                         
  1. Guard A: Missing collections safeguard - prevents groups from silently bypassing validation if collection records don't exist in DB                                                                 
  2. Guard B: Explicit note that missing window dates is blocking with no override in Phase 1                                                                                                            
  3. Guard C: Optional "Later Allowed" alternative - documents how to switch to form dates if you want to honor the "later dates allowed" business rule                                                  
                                                                                                                                                                                                         
  There's one decision point flagged:                                                                                                                                                                    
  - Current behavior: Ship dates come from collection windows (legacy behavior)                                                                                                                          
  - Alternative: Use form dates and just validate against collection windows (honors "later allowed" rule)                                                                                               
                                                                                                                                                                                                         
⏺ User answered Claude's questions:                                                                                                                                                                      
  ⎿  · For Phase 1, should ship dates come from collection windows (current plan) or from form dates with validation (allows reps to set later dates)? → I'm not sure what you mean by legacy. And       
     I'm also not sure where in the UI/UX you are talking about. The logic of how shipments get split (by collection) and how dates get assigned needs to be exactly as it is now.                       
                                                                                                                                                                                                         
⏺ I apologize for the confusion. Let me clarify:                                                                                                                                                         
                                                                                                                                                                                                         
  The date assignment logic is NOT changing. The current system already:                                                                                                                                 
  1. Uses collection's shipWindowStart/shipWindowEnd when available                                                                                                                                      
  2. Falls back to form dates when collection windows are missing                                                                                                                                        
                                                                                                                                                                                                         
  This stays exactly the same. The only things changing in Phase 1:                                                                                                                                      
  - Orders will split by collection (instead of staying as one order with multiple PlannedShipments)                                                                                                     
  - PlannedShipment records won't be created (the table stays, just unused)                                                                                                                              
                                                                                                                                                                                                         
  The "legacy" reference was to the pre-PlannedShipment code from commit 8d9f99a, which had the same date logic.                                                                                         
                                                                                                                                                                                                         
  Let me update the plan to remove that confusing decision point and make it clear that date handling is unchanged.                                                                                      
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  Error editing file                                                                                                                                                                                  
                                                                                                                                                                                                         
⏺ Searched for 1 pattern (ctrl+o to expand)                                                                                                                                                              
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ Searched for 1 pattern (ctrl+o to expand)                                                                                                                                                              
                                                                                                                                                                                                         
⏺ Updated plan                                                                                                                                                                                           
  ⎿  /plan to preview                                                                                                                                                                                    
                                                                                                                                                                                                         
⏺ The plan is now cleaned up. To summarize what Phase 1 covers:                                                                                                                                          
                                                                                                                                                                                                         
  5 files, 6 major changes:                                                                                                                                                                              
  1. File 1a: createOrder() - restore grouping loop + per-group validation                                                                                                                               
  2. File 1b: updateOrder() - revert to pre-Phase-5 (remove planned-shipment sync)                                                                                                                       
  3. File 1c: Import cleanup - remove unused planned-shipment imports                                                                                                                                    
  4. File 2: Draft submit - restore grouping + add getOrderGroupKey helper                                                                                                                               
  5. File 3: Schema - remove plannedShipments from input                                                                                                                                                 
  6. File 4: Types - CreateOrderResult with orders[], simplified UpdateOrderInput                                                                                                                        
  7. File 5: order-form.tsx - remove shipment validation, handle orders[] response                                                                                                                       
                                                                                                                                                                                                         
  Addendum guards:                                                                                                                                                                                       
  - A: Missing collections safeguard                                                                                                                                                                     
  - B: Missing windows is blocking (no override)                                                                                                                                                         
  - C: Date handling unchanged                                                                                                                                                                           
                                                                                                                                                                                                         
  Key point: The splitting behavior and date assignment logic remain exactly as they work now. The only change is orders split by collection instead of creating PlannedShipment records within a single 
  order.                                                                                                                                                                                                 
  ⎿  User rejected Claude's plan:                                                                                                                                                                        
     ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮  
     │ Phase 1: Revert to Order Splitting (Collection-Based)                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Context                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ The PlannedShipment feature was built based on a misinterpretation of CEO feedback. The original order splitting behavior (one cart → multiple orders by collection) was actually correct and  │  
     │ preferred. This plan reverts to that behavior while keeping Collection as the canonical source for ship windows and PreOrder detection.                                                        │  
     │                                                                                                                                                                                                │  
     │ Pre-Implementation Decisions (Confirmed)                                                                                                                                                       │  
     │ ┌───────────────────────────┬────────────────────────────────────────────┬────────────────────────────────────┐                                                                                │  
     │ │         Decision          │                   Choice                   │             Rationale              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Ship window source        │ Collection (shipWindowStart/shipWindowEnd) │ Now canonical in prod              │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PreOrder detection        │ Collection.type                            │ Consistent with current data model │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ Missing collection window │ Block with error                           │ Enforce data quality               │                                                                                │  
     │ ├───────────────────────────┼────────────────────────────────────────────┼────────────────────────────────────┤                                                                                │  
     │ │ PlannedShipment table     │ Leave in place, don't populate             │ Avoid migration risk               │                                                                                │  
     │ └───────────────────────────┴────────────────────────────────────────────┴────────────────────────────────────┘                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Files to Change (5 files, 6 major changes)                                                                                                                                                     │  
     │ ┌─────┬─────────────────────────────────────────┬────────────────────────────────────────────────────────────────────┐                                                                         │  
     │ │  #  │                  File                   │                              Summary                               │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1a  │ src/lib/data/actions/orders.ts          │ Restore createOrder() grouping loop + per-group validation         │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1b  │ src/lib/data/actions/orders.ts          │ Revert updateOrder() to pre-Phase-5 (remove planned-shipment sync) │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 1c  │ src/lib/data/actions/orders.ts          │ Remove unused planned-shipment imports                             │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 2   │ src/app/api/drafts/[id]/submit/route.ts │ Restore grouping + validation, add helper                          │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 3   │ src/lib/schemas/order.ts                │ Remove plannedShipments, use collection* fields                    │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 4   │ src/lib/types/order.ts                  │ Restore orders[] return type, simplify UpdateOrderInput            │                                                                         │  
     │ ├─────┼─────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤                                                                         │  
     │ │ 5   │ src/components/buyer/order-form.tsx     │ Remove shipment validation block, handle orders[] response         │                                                                         │  
     │ └─────┴─────────────────────────────────────────┴────────────────────────────────────────────────────────────────────┘                                                                         │  
     │ ---                                                                                                                                                                                            │  
     │ File 1: src/lib/data/actions/orders.ts                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ Change: Replace createOrder() core logic                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Derive order type from SKU data (master source: Collection.type)                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the return { success: true, ... } with:                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Derive order type from SKU data (master source: Collection.type)                                                                                                                            │  
     │ const skuVariantIds = data.items.map((item) => BigInt(item.skuVariantId))                                                                                                                      │  
     │ const skuPreOrderMap = await deriveIsPreOrderFromSkus(skuVariantIds)                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof data.items>()                                                                                                                                        │  
     │ for (const item of data.items) {                                                                                                                                                               │  
     │   const key = _getOrderGroupKey(                                                                                                                                                               │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     data.items                                                                                                                                                                                 │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // ATS / uncategorized: no validation                                                                                                                                                        │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   // Block if any collection lacks windows                                                                                                                                                     │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Use the same ship dates that will be written to the order header                                                                                                                          │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? data.shipStartDate).split('T')[0]                                                                                                            │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? data.shipEndDate).split('T')[0]                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return {                                                                                                                                                                                   │  
     │       success: false,                                                                                                                                                                          │  
     │       error: `Invalid dates for ${names}: ${result.errors[0]?.message}`,                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof data.items                                                                                                                                                                     │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ // Create orders in a single transaction for atomicity                                                                                                                                         │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Look up rep by ID - fail if not found                                                                                                                                                     │  
     │   const rep = await tx.reps.findUnique({                                                                                                                                                       │  
     │     where: { ID: parseInt(data.salesRepId) },                                                                                                                                                  │  
     │     select: { Name: true, Code: true },                                                                                                                                                        │  
     │   })                                                                                                                                                                                           │  
     │   if (!rep) {                                                                                                                                                                                  │  
     │     throw new Error('Invalid sales rep')                                                                                                                                                       │  
     │   }                                                                                                                                                                                            │  
     │   const salesRepName = rep.Name ?? ''                                                                                                                                                          │  
     │   const salesRepCode = rep.Code?.trim() || rep.Name || ''                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │   // Determine customerId for strong ownership                                                                                                                                                 │  
     │   let customerId: number | null = data.customerId ?? null                                                                                                                                      │  
     │   if (!customerId) {                                                                                                                                                                           │  
     │     const existingByName = await tx.customers.findFirst({                                                                                                                                      │  
     │       where: { StoreName: data.storeName },                                                                                                                                                    │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │     if (existingByName) {                                                                                                                                                                      │  
     │       customerId = existingByName.ID                                                                                                                                                           │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     // Determine order type from first item's SKU (all items in group have same type)                                                                                                          │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Generate order number with appropriate prefix                                                                                                                                           │  
     │     const orderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │     // Calculate group total                                                                                                                                                                   │  
     │     const orderAmount = groupItems.reduce(                                                                                                                                                     │  
     │       (sum, item) => sum + item.price * item.quantity,                                                                                                                                         │  
     │       0                                                                                                                                                                                        │  
     │     )                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Use item's ship window if available, else form dates                                                                                                                                    │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(data.shipStartDate)                                                                                                                                                           │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(data.shipEndDate)                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │     // Create order header                                                                                                                                                                     │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         BuyerName: data.buyerName,                                                                                                                                                             │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: data.customerEmail,                                                                                                                                                     │  
     │         CustomerPhone: data.customerPhone,                                                                                                                                                     │  
     │         Country: data.currency, // Legacy: stores currency, not country                                                                                                                        │  
     │         OrderAmount: orderAmount,                                                                                                                                                              │  
     │         OrderNotes: data.orderNotes ?? '',                                                                                                                                                     │  
     │         CustomerPO: data.customerPO ?? '',                                                                                                                                                     │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder, // Derived from Collection.type                                                                                                                                │  
     │         RepID: parseInt(data.salesRepId),                                                                                                                                                      │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Create line items for this group (NO PlannedShipmentID)                                                                                                                                 │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map((item) => ({                                                                                                                                                        │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: orderNumber,                                                                                                                                                              │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                               │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: data.currency,                                                                                                                                                          │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: newOrder.ID.toString(),                                                                                                                                                         │  
     │       orderNumber,                                                                                                                                                                             │  
     │       collectionName: firstItem.collectionName ?? null,                                                                                                                                        │  
     │       shipWindowStart: firstItem.shipWindowStart ?? null,                                                                                                                                      │  
     │       shipWindowEnd: firstItem.shipWindowEnd ?? null,                                                                                                                                          │  
     │       orderAmount,                                                                                                                                                                             │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   // Find or create customer (only once, not per order)                                                                                                                                        │  
     │   const existingCustomer = await tx.customers.findFirst({                                                                                                                                      │  
     │     where: { StoreName: data.storeName },                                                                                                                                                      │  
     │     select: { ID: true, OrderCount: true },                                                                                                                                                    │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   if (existingCustomer) {                                                                                                                                                                      │  
     │     await tx.customers.update({                                                                                                                                                                │  
     │       where: { ID: existingCustomer.ID },                                                                                                                                                      │  
     │       data: {                                                                                                                                                                                  │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: (existingCustomer.OrderCount ?? 0) + createdOrders.length,                                                                                                                 │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   } else {                                                                                                                                                                                     │  
     │     // Create new customer and update all orders with CustomerID                                                                                                                               │  
     │     const newCustomer = await tx.customers.create({                                                                                                                                            │  
     │       data: {                                                                                                                                                                                  │  
     │         StoreName: data.storeName,                                                                                                                                                             │  
     │         CustomerName: data.buyerName,                                                                                                                                                          │  
     │         Email: data.customerEmail,                                                                                                                                                             │  
     │         Phone: data.customerPhone,                                                                                                                                                             │  
     │         Rep: salesRepCode,                                                                                                                                                                     │  
     │         Street1: data.street1,                                                                                                                                                                 │  
     │         Street2: data.street2 ?? '',                                                                                                                                                           │  
     │         City: data.city,                                                                                                                                                                       │  
     │         StateProvince: data.stateProvince,                                                                                                                                                     │  
     │         ZipPostal: data.zipPostal,                                                                                                                                                             │  
     │         Country: data.country,                                                                                                                                                                 │  
     │         ShippingStreet1: data.shippingStreet1,                                                                                                                                                 │  
     │         ShippingStreet2: data.shippingStreet2 ?? '',                                                                                                                                           │  
     │         ShippingCity: data.shippingCity,                                                                                                                                                       │  
     │         ShippingStateProvince: data.shippingStateProvince,                                                                                                                                     │  
     │         ShippingZipPostal: data.shippingZipPostal,                                                                                                                                             │  
     │         ShippingCountry: data.shippingCountry,                                                                                                                                                 │  
     │         Website: data.website ?? '',                                                                                                                                                           │  
     │         FirstOrderDate: new Date(),                                                                                                                                                            │  
     │         LastOrderDate: new Date(),                                                                                                                                                             │  
     │         OrderCount: createdOrders.length,                                                                                                                                                      │  
     │       },                                                                                                                                                                                       │  
     │       select: { ID: true },                                                                                                                                                                    │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     // Update all created orders with new customer's ID                                                                                                                                        │  
     │     for (const order of createdOrders) {                                                                                                                                                       │  
     │       await tx.customerOrders.update({                                                                                                                                                         │  
     │         where: { ID: BigInt(order.orderId) },                                                                                                                                                  │  
     │         data: { CustomerID: newCustomer.ID },                                                                                                                                                  │  
     │       })                                                                                                                                                                                       │  
     │     }                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send order confirmation emails (non-blocking) unless skipEmail is set                                                                                                                       │  
     │ if (!data.skipEmail) {                                                                                                                                                                         │  
     │   for (const order of createdOrders) {                                                                                                                                                         │  
     │     sendOrderEmails({                                                                                                                                                                          │  
     │       orderId: order.orderId,                                                                                                                                                                  │  
     │       orderNumber: order.orderNumber,                                                                                                                                                          │  
     │       storeName: data.storeName,                                                                                                                                                               │  
     │       buyerName: data.buyerName,                                                                                                                                                               │  
     │       customerEmail: data.customerEmail,                                                                                                                                                       │  
     │       customerPhone: data.customerPhone,                                                                                                                                                       │  
     │       salesRep: data.storeName,                                                                                                                                                                │  
     │       orderAmount: order.orderAmount,                                                                                                                                                          │  
     │       currency: data.currency,                                                                                                                                                                 │  
     │       shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(data.shipStartDate),                                                                                   │  
     │       shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(data.shipEndDate),                                                                                           │  
     │       orderDate: new Date(),                                                                                                                                                                   │  
     │       orderNotes: data.orderNotes,                                                                                                                                                             │  
     │       customerPO: data.customerPO,                                                                                                                                                             │  
     │       items: order.items.map((item) => ({                                                                                                                                                      │  
     │         sku: item.sku,                                                                                                                                                                         │  
     │         quantity: item.quantity,                                                                                                                                                               │  
     │         price: item.price,                                                                                                                                                                     │  
     │         lineTotal: item.price * item.quantity,                                                                                                                                                 │  
     │       })),                                                                                                                                                                                     │  
     │     }).catch((err) => {                                                                                                                                                                        │  
     │       console.error(`Order email error for ${order.orderNumber}:`, err)                                                                                                                        │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ revalidatePath('/admin/orders')                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ // Return first order for backwards compatibility, plus full orders array                                                                                                                      │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return {                                                                                                                                                                                       │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map((o) => ({                                                                                                                                                          │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 1b: src/lib/data/actions/orders.ts - Revert updateOrder()                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ Change: Replace entire updateOrder() function with pre-Phase-5 version                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ The current updateOrder() references input.plannedShipments and has planned-shipment sync logic that will fail TypeScript once plannedShipments is removed from the type.                      │  
     │                                                                                                                                                                                                │  
     │ Replace the entire updateOrder() function with:                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ // ============================================================================                                                                                                                │  
     │ // Order Update (Edit Items)                                                                                                                                                                   │  
     │ // ============================================================================                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ /**                                                                                                                                                                                            │  
     │  * Update an existing order.                                                                                                                                                                   │  
     │  * Matches .NET MyOrder.aspx.cs behavior for edit mode:                                                                                                                                        │  
     │  * - Updates CustomerOrders header                                                                                                                                                             │  
     │  * - Deletes old items, inserts new items                                                                                                                                                      │  
     │  * - Recalculates order amount                                                                                                                                                                 │  
     │  *                                                                                                                                                                                             │  
     │  * @param input - Order update data                                                                                                                                                            │  
     │  * @returns Success status with order number                                                                                                                                                   │  
     │  */                                                                                                                                                                                            │  
     │ export async function updateOrder(                                                                                                                                                             │  
     │   input: UpdateOrderInput                                                                                                                                                                      │  
     │ ): Promise<UpdateOrderResult> {                                                                                                                                                                │  
     │   try {                                                                                                                                                                                        │  
     │     const { orderId, items, ...headerData } = input                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │     // Verify order exists and is editable                                                                                                                                                     │  
     │     const existingOrder = await prisma.customerOrders.findUnique({                                                                                                                             │  
     │       where: { ID: BigInt(orderId) },                                                                                                                                                          │  
     │       select: {                                                                                                                                                                                │  
     │         ID: true,                                                                                                                                                                              │  
     │         OrderNumber: true,                                                                                                                                                                     │  
     │         OrderStatus: true,                                                                                                                                                                     │  
     │         IsTransferredToShopify: true,                                                                                                                                                          │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     if (!existingOrder) {                                                                                                                                                                      │  
     │       return { success: false, error: 'Order not found' }                                                                                                                                      │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Check edit conditions: Pending AND NOT in Shopify                                                                                                                                       │  
     │     if (existingOrder.OrderStatus !== 'Pending') {                                                                                                                                             │  
     │       return { success: false, error: 'Only Pending orders can be edited' }                                                                                                                    │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     if (existingOrder.IsTransferredToShopify) {                                                                                                                                                │  
     │       return {                                                                                                                                                                                 │  
     │         success: false,                                                                                                                                                                        │  
     │         error: 'Orders transferred to Shopify cannot be edited',                                                                                                                               │  
     │       }                                                                                                                                                                                        │  
     │     }                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Calculate new total                                                                                                                                                                     │  
     │     const orderAmount = items.reduce(                                                                                                                                                          │  
     │       (sum, item) => sum + item.price * item.quantity,                                                                                                                                         │  
     │       0                                                                                                                                                                                        │  
     │     )                                                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │     // Update order in transaction                                                                                                                                                             │  
     │     await prisma.$transaction(async (tx) => {                                                                                                                                                  │  
     │       // Look up rep by ID                                                                                                                                                                     │  
     │       const rep = await tx.reps.findUnique({                                                                                                                                                   │  
     │         where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                        │  
     │         select: { Name: true },                                                                                                                                                                │  
     │       })                                                                                                                                                                                       │  
     │       if (!rep) {                                                                                                                                                                              │  
     │         throw new Error('Invalid sales rep')                                                                                                                                                   │  
     │       }                                                                                                                                                                                        │  
     │       const salesRepName = rep.Name ?? ''                                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │       // Update order header                                                                                                                                                                   │  
     │       await tx.customerOrders.update({                                                                                                                                                         │  
     │         where: { ID: BigInt(orderId) },                                                                                                                                                        │  
     │         data: {                                                                                                                                                                                │  
     │           StoreName: headerData.storeName,                                                                                                                                                     │  
     │           BuyerName: headerData.buyerName,                                                                                                                                                     │  
     │           SalesRep: salesRepName,                                                                                                                                                              │  
     │           CustomerEmail: headerData.customerEmail,                                                                                                                                             │  
     │           CustomerPhone: headerData.customerPhone,                                                                                                                                             │  
     │           Country: headerData.currency, // Legacy: stores currency                                                                                                                             │  
     │           OrderAmount: orderAmount,                                                                                                                                                            │  
     │           OrderNotes: headerData.orderNotes ?? '',                                                                                                                                             │  
     │           CustomerPO: headerData.customerPO ?? '',                                                                                                                                             │  
     │           ShipStartDate: new Date(headerData.shipStartDate),                                                                                                                                   │  
     │           ShipEndDate: new Date(headerData.shipEndDate),                                                                                                                                       │  
     │           Website: headerData.website ?? '',                                                                                                                                                   │  
     │         },                                                                                                                                                                                     │  
     │       })                                                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │       // Delete old items                                                                                                                                                                      │  
     │       await tx.customerOrdersItems.deleteMany({                                                                                                                                                │  
     │         where: { CustomerOrderID: BigInt(orderId) },                                                                                                                                           │  
     │       })                                                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │       // Insert new items (NO PlannedShipmentID)                                                                                                                                               │  
     │       await tx.customerOrdersItems.createMany({                                                                                                                                                │  
     │         data: items.map((item) => ({                                                                                                                                                           │  
     │           CustomerOrderID: BigInt(orderId),                                                                                                                                                    │  
     │           OrderNumber: existingOrder.OrderNumber,                                                                                                                                              │  
     │           SKU: item.sku,                                                                                                                                                                       │  
     │           SKUVariantID: BigInt(item.skuVariantId),                                                                                                                                             │  
     │           Quantity: item.quantity,                                                                                                                                                             │  
     │           Price: item.price,                                                                                                                                                                   │  
     │           PriceCurrency: headerData.currency,                                                                                                                                                  │  
     │           Notes: '',                                                                                                                                                                           │  
     │         })),                                                                                                                                                                                   │  
     │       })                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     revalidatePath('/admin/orders')                                                                                                                                                            │  
     │     revalidatePath('/rep/orders')                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │     // Look up the rep name for email                                                                                                                                                          │  
     │     const repForEmail = await prisma.reps.findUnique({                                                                                                                                         │  
     │       where: { ID: parseInt(headerData.salesRepId) },                                                                                                                                          │  
     │       select: { Name: true },                                                                                                                                                                  │  
     │     })                                                                                                                                                                                         │  
     │     const salesRepName = repForEmail?.Name ?? ''                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │     // Send update notification emails (async, non-blocking)                                                                                                                                   │  
     │     const currency = headerData.currency.toUpperCase().includes('CAD') ? 'CAD' : 'USD' as 'CAD' | 'USD'                                                                                        │  
     │     sendOrderEmails(                                                                                                                                                                           │  
     │       {                                                                                                                                                                                        │  
     │         orderId: orderId,                                                                                                                                                                      │  
     │         orderNumber: existingOrder.OrderNumber,                                                                                                                                                │  
     │         storeName: headerData.storeName,                                                                                                                                                       │  
     │         buyerName: headerData.buyerName,                                                                                                                                                       │  
     │         customerEmail: headerData.customerEmail,                                                                                                                                               │  
     │         customerPhone: headerData.customerPhone,                                                                                                                                               │  
     │         salesRep: salesRepName,                                                                                                                                                                │  
     │         orderAmount: orderAmount,                                                                                                                                                              │  
     │         currency: currency,                                                                                                                                                                    │  
     │         shipStartDate: new Date(headerData.shipStartDate),                                                                                                                                     │  
     │         shipEndDate: new Date(headerData.shipEndDate),                                                                                                                                         │  
     │         orderDate: new Date(),                                                                                                                                                                 │  
     │         orderNotes: headerData.orderNotes ?? '',                                                                                                                                               │  
     │         customerPO: headerData.customerPO ?? '',                                                                                                                                               │  
     │         items: items.map((item) => ({                                                                                                                                                          │  
     │           sku: item.sku,                                                                                                                                                                       │  
     │           quantity: item.quantity,                                                                                                                                                             │  
     │           price: item.price,                                                                                                                                                                   │  
     │           lineTotal: item.price * item.quantity,                                                                                                                                               │  
     │         })),                                                                                                                                                                                   │  
     │       },                                                                                                                                                                                       │  
     │       true // isUpdate = true                                                                                                                                                                  │  
     │     ).catch((err) => {                                                                                                                                                                         │  
     │       console.error('Failed to send order update emails:', err)                                                                                                                                │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     return {                                                                                                                                                                                   │  
     │       success: true,                                                                                                                                                                           │  
     │       orderNumber: existingOrder.OrderNumber,                                                                                                                                                  │  
     │     }                                                                                                                                                                                          │  
     │   } catch (e) {                                                                                                                                                                                │  
     │     console.error('updateOrder error:', e)                                                                                                                                                     │  
     │     const message = e instanceof Error ? e.message : 'Failed to update order'                                                                                                                  │  
     │     return { success: false, error: message }                                                                                                                                                  │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 1c: src/lib/data/actions/orders.ts - Remove Unused Imports                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change: Remove planned-shipment imports that become unused                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ After reverting createOrder() and updateOrder(), these imports/functions are no longer used and should be removed to avoid lint/type errors:                                                   │  
     │                                                                                                                                                                                                │  
     │ Remove these imports (if present):                                                                                                                                                             │  
     │ // Remove these - no longer used after revert:                                                                                                                                                 │  
     │ // import { PlannedShipmentData } from ...                                                                                                                                                     │  
     │ // import { findShipmentIdForSku } from ...                                                                                                                                                    │  
     │ // import { deriveShipmentsFromItems } from ...                                                                                                                                                │  
     │ // import { getMultiCollectionOverlap } from ...                                                                                                                                               │  
     │ // import { logShipmentDatesOverride } from ...                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Also remove these helper functions if they exist in the file and are now unused:                                                                                                               │  
     │ - getLegacyDatesFromShipments()                                                                                                                                                                │  
     │ - deriveShipmentsFromItems()                                                                                                                                                                   │  
     │ - Any other planned-shipment-specific helpers                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ Keep these (still used):                                                                                                                                                                       │  
     │ - _getOrderGroupKey() - used for grouping                                                                                                                                                      │  
     │ - deriveIsPreOrderFromSkus() - used for PreOrder detection                                                                                                                                     │  
     │ - validateShipDates() - used for per-group validation                                                                                                                                          │  
     │ - getNextOrderNumber() - used for order number generation                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 2: src/app/api/drafts/[id]/submit/route.ts                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change A: Add getOrderGroupKey helper near top of file                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ function getOrderGroupKey(                                                                                                                                                                     │  
     │   item: { collectionId?: number | null; skuVariantId: bigint },                                                                                                                                │  
     │   skuPreOrderMap: Map<string, boolean>                                                                                                                                                         │  
     │ ): string {                                                                                                                                                                                    │  
     │   const isPreOrder = skuPreOrderMap.get(String(item.skuVariantId)) ?? false                                                                                                                    │  
     │   const typePrefix = isPreOrder ? 'preorder' : 'ats'                                                                                                                                           │  
     │   if (item.collectionId) return `${typePrefix}-collection-${item.collectionId}`                                                                                                                │  
     │   return `${typePrefix}-default`                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace submission logic                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Find anchor: // Phase 9: Use planned shipments instead of splitting orders                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Replace everything from that anchor through the JSON response with:                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ // Group items by order type AND collection (auto-split mixed ATS/Pre-Order)                                                                                                                   │  
     │ const itemGroups = new Map<string, typeof items>()                                                                                                                                             │  
     │ for (const item of items) {                                                                                                                                                                    │  
     │   const key = getOrderGroupKey(                                                                                                                                                                │  
     │     { collectionId: item.collectionId, skuVariantId: item.skuVariantId },                                                                                                                      │  
     │     skuPreOrderMap                                                                                                                                                                             │  
     │   )                                                                                                                                                                                            │  
     │   if (!itemGroups.has(key)) {                                                                                                                                                                  │  
     │     itemGroups.set(key, [])                                                                                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │   itemGroups.get(key)!.push(item)                                                                                                                                                              │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ // Fetch collection windows once for validation                                                                                                                                                │  
     │ const allCollectionIds = [                                                                                                                                                                     │  
     │   ...new Set(                                                                                                                                                                                  │  
     │     items                                                                                                                                                                                      │  
     │       .map((i) => i.collectionId)                                                                                                                                                              │  
     │       .filter((id): id is number => id !== null && id !== undefined)                                                                                                                           │  
     │   ),                                                                                                                                                                                           │  
     │ ]                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const collections = allCollectionIds.length > 0                                                                                                                                                │  
     │   ? await prisma.collection.findMany({                                                                                                                                                         │  
     │       where: { id: { in: allCollectionIds } },                                                                                                                                                 │  
     │       select: { id: true, name: true, shipWindowStart: true, shipWindowEnd: true },                                                                                                            │  
     │     })                                                                                                                                                                                         │  
     │   : []                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ const collectionMap = new Map(collections.map((c) => [c.id, c]))                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ // Validate each group against its collection window                                                                                                                                           │  
     │ for (const [, groupItems] of itemGroups) {                                                                                                                                                     │  
     │   const groupCollectionIds = [                                                                                                                                                                 │  
     │     ...new Set(                                                                                                                                                                                │  
     │       groupItems                                                                                                                                                                               │  
     │         .map((i) => i.collectionId)                                                                                                                                                            │  
     │         .filter((id): id is number => id !== null && id !== undefined)                                                                                                                         │  
     │     ),                                                                                                                                                                                         │  
     │   ]                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (groupCollectionIds.length === 0) continue                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const groupCollections = groupCollectionIds                                                                                                                                                  │  
     │     .map((id) => collectionMap.get(id))                                                                                                                                                        │  
     │     .filter((c): c is NonNullable<typeof c> => c !== undefined)                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │   const missingWindows = groupCollections.filter(                                                                                                                                              │  
     │     (c) => !c.shipWindowStart || !c.shipWindowEnd                                                                                                                                              │  
     │   )                                                                                                                                                                                            │  
     │   if (missingWindows.length > 0) {                                                                                                                                                             │  
     │     const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                    │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Cannot validate ship dates: ${names} missing ship window dates.` },                                                                                                            │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   const firstItem = groupItems[0]                                                                                                                                                              │  
     │   const shipStart = (firstItem.shipWindowStart ?? formData.shipStartDate).split('T')[0]                                                                                                        │  
     │   const shipEnd = (firstItem.shipWindowEnd ?? formData.shipEndDate).split('T')[0]                                                                                                              │  
     │                                                                                                                                                                                                │  
     │   const result = validateShipDates(                                                                                                                                                            │  
     │     shipStart,                                                                                                                                                                                 │  
     │     shipEnd,                                                                                                                                                                                   │  
     │     groupCollections.map((c) => ({                                                                                                                                                             │  
     │       id: c.id,                                                                                                                                                                                │  
     │       name: c.name ?? '',                                                                                                                                                                      │  
     │       shipWindowStart: c.shipWindowStart!.toISOString().split('T')[0],                                                                                                                         │  
     │       shipWindowEnd: c.shipWindowEnd!.toISOString().split('T')[0],                                                                                                                             │  
     │     }))                                                                                                                                                                                        │  
     │   )                                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │   if (!result.valid) {                                                                                                                                                                         │  
     │     const names = groupCollections.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                  │  
     │     return NextResponse.json(                                                                                                                                                                  │  
     │       { error: `Invalid dates for ${names}: ${result.errors[0]?.message}` },                                                                                                                   │  
     │       { status: 400 }                                                                                                                                                                          │  
     │     )                                                                                                                                                                                          │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const currency = formData.currency || 'CAD'                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ // Track created orders                                                                                                                                                                        │  
     │ const createdOrders: Array<{                                                                                                                                                                   │  
     │   orderId: string                                                                                                                                                                              │  
     │   orderNumber: string                                                                                                                                                                          │  
     │   collectionName: string | null                                                                                                                                                                │  
     │   shipWindowStart: string | null                                                                                                                                                               │  
     │   shipWindowEnd: string | null                                                                                                                                                                 │  
     │   orderAmount: number                                                                                                                                                                          │  
     │   items: typeof items                                                                                                                                                                          │  
     │ }> = []                                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ await prisma.$transaction(async (tx) => {                                                                                                                                                      │  
     │   // Delete the draft first (we'll create new orders)                                                                                                                                          │  
     │   await tx.customerOrdersItems.deleteMany({                                                                                                                                                    │  
     │     where: { CustomerOrderID: draft.ID },                                                                                                                                                      │  
     │   })                                                                                                                                                                                           │  
     │   await tx.customerOrders.delete({                                                                                                                                                             │  
     │     where: { ID: draft.ID },                                                                                                                                                                   │  
     │   })                                                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │   // Create one order per collection group (and order type)                                                                                                                                    │  
     │   for (const [, groupItems] of itemGroups) {                                                                                                                                                   │  
     │     const firstItemVariantId = String(groupItems[0].skuVariantId)                                                                                                                              │  
     │     const isPreOrder = skuPreOrderMap.get(firstItemVariantId) ?? false                                                                                                                         │  
     │     const groupOrderNumber = await getNextOrderNumber(isPreOrder)                                                                                                                              │  
     │     const groupAmount = groupItems.reduce((sum, item) => sum + item.price * item.quantity, 0)                                                                                                  │  
     │                                                                                                                                                                                                │  
     │     const firstItem = groupItems[0]                                                                                                                                                            │  
     │     const shipStart = firstItem.shipWindowStart                                                                                                                                                │  
     │       ? new Date(firstItem.shipWindowStart)                                                                                                                                                    │  
     │       : new Date(formData.shipStartDate)                                                                                                                                                       │  
     │     const shipEnd = firstItem.shipWindowEnd                                                                                                                                                    │  
     │       ? new Date(firstItem.shipWindowEnd)                                                                                                                                                      │  
     │       : new Date(formData.shipEndDate)                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     const newOrder = await tx.customerOrders.create({                                                                                                                                          │  
     │       data: {                                                                                                                                                                                  │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         OrderStatus: 'Pending',                                                                                                                                                                │  
     │         BuyerName: formData.buyerName,                                                                                                                                                         │  
     │         StoreName: formData.storeName,                                                                                                                                                         │  
     │         SalesRep: salesRepName,                                                                                                                                                                │  
     │         CustomerEmail: formData.customerEmail,                                                                                                                                                 │  
     │         CustomerPhone: formData.customerPhone,                                                                                                                                                 │  
     │         Country: currency,                                                                                                                                                                     │  
     │         OrderAmount: groupAmount,                                                                                                                                                              │  
     │         OrderNotes: formData.orderNotes || '',                                                                                                                                                 │  
     │         CustomerPO: formData.customerPO || '',                                                                                                                                                 │  
     │         ShipStartDate: shipStart,                                                                                                                                                              │  
     │         ShipEndDate: shipEnd,                                                                                                                                                                  │  
     │         OrderDate: new Date(),                                                                                                                                                                 │  
     │         Website: formData.website || '',                                                                                                                                                       │  
     │         IsShipped: false,                                                                                                                                                                      │  
     │         IsTransferredToShopify: false,                                                                                                                                                         │  
     │         IsPreOrder: isPreOrder,                                                                                                                                                                │  
     │         RepID: parseInt(formData.salesRepId),                                                                                                                                                  │  
     │         CustomerID: customerId,                                                                                                                                                                │  
     │       },                                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     await tx.customerOrdersItems.createMany({                                                                                                                                                  │  
     │       data: groupItems.map(item => ({                                                                                                                                                          │  
     │         CustomerOrderID: newOrder.ID,                                                                                                                                                          │  
     │         OrderNumber: groupOrderNumber,                                                                                                                                                         │  
     │         SKU: item.sku,                                                                                                                                                                         │  
     │         SKUVariantID: item.skuVariantId,                                                                                                                                                       │  
     │         Quantity: item.quantity,                                                                                                                                                               │  
     │         Price: item.price,                                                                                                                                                                     │  
     │         PriceCurrency: currency,                                                                                                                                                               │  
     │         Notes: '',                                                                                                                                                                             │  
     │       })),                                                                                                                                                                                     │  
     │     })                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │     createdOrders.push({                                                                                                                                                                       │  
     │       orderId: String(newOrder.ID),                                                                                                                                                            │  
     │       orderNumber: groupOrderNumber,                                                                                                                                                           │  
     │       collectionName: firstItem.collectionName,                                                                                                                                                │  
     │       shipWindowStart: firstItem.shipWindowStart,                                                                                                                                              │  
     │       shipWindowEnd: firstItem.shipWindowEnd,                                                                                                                                                  │  
     │       orderAmount: groupAmount,                                                                                                                                                                │  
     │       items: groupItems,                                                                                                                                                                       │  
     │     })                                                                                                                                                                                         │  
     │   }                                                                                                                                                                                            │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ // Send confirmation emails for each created order (non-blocking)                                                                                                                              │  
     │ for (const order of createdOrders) {                                                                                                                                                           │  
     │   sendOrderEmails({                                                                                                                                                                            │  
     │     orderId: order.orderId,                                                                                                                                                                    │  
     │     orderNumber: order.orderNumber,                                                                                                                                                            │  
     │     storeName: formData.storeName,                                                                                                                                                             │  
     │     buyerName: formData.buyerName,                                                                                                                                                             │  
     │     salesRep: salesRepName,                                                                                                                                                                    │  
     │     customerEmail: formData.customerEmail,                                                                                                                                                     │  
     │     customerPhone: formData.customerPhone,                                                                                                                                                     │  
     │     shipStartDate: order.shipWindowStart ? new Date(order.shipWindowStart) : new Date(formData.shipStartDate),                                                                                 │  
     │     shipEndDate: order.shipWindowEnd ? new Date(order.shipWindowEnd) : new Date(formData.shipEndDate),                                                                                         │  
     │     orderDate: new Date(),                                                                                                                                                                     │  
     │     orderNotes: formData.orderNotes,                                                                                                                                                           │  
     │     customerPO: formData.customerPO,                                                                                                                                                           │  
     │     items: order.items.map(i => ({                                                                                                                                                             │  
     │       sku: i.sku,                                                                                                                                                                              │  
     │       quantity: i.quantity,                                                                                                                                                                    │  
     │       price: i.price,                                                                                                                                                                          │  
     │       lineTotal: i.price * i.quantity,                                                                                                                                                         │  
     │     })),                                                                                                                                                                                       │  
     │     currency,                                                                                                                                                                                  │  
     │     orderAmount: order.orderAmount,                                                                                                                                                            │  
     │   }).catch(err => {                                                                                                                                                                            │  
     │     console.error(`Failed to send order emails for ${order.orderNumber}:`, err)                                                                                                                │  
     │   })                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ const primaryOrder = createdOrders[0]                                                                                                                                                          │  
     │ return NextResponse.json({                                                                                                                                                                     │  
     │   success: true,                                                                                                                                                                               │  
     │   orderId: primaryOrder?.orderId,                                                                                                                                                              │  
     │   orderNumber: primaryOrder?.orderNumber,                                                                                                                                                      │  
     │   orders: createdOrders.map(o => ({                                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount,                                                                                                                                                                │  
     │   })),                                                                                                                                                                                         │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 3: src/lib/schemas/order.ts                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ Change: Replace orderItemSchema and createOrderInputSchema                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Remove the plannedShipmentSchema definition entirely.                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Replace orderItemSchema with:                                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ export const orderItemSchema = z.object({                                                                                                                                                      │  
     │   sku: z.string().min(1),                                                                                                                                                                      │  
     │   skuVariantId: z.union([z.bigint(), z.number()]),                                                                                                                                             │  
     │   quantity: z.number().int().positive(),                                                                                                                                                       │  
     │   price: z.number().nonnegative(),                                                                                                                                                             │  
     │   // Collection is the source for order splitting and pre-order detection                                                                                                                      │  
     │   collectionId: z.number().nullable().optional(),                                                                                                                                              │  
     │   collectionName: z.string().nullable().optional(),                                                                                                                                            │  
     │   // Ship window dates from Collection                                                                                                                                                         │  
     │   shipWindowStart: z.string().nullable().optional(),                                                                                                                                           │  
     │   shipWindowEnd: z.string().nullable().optional(),                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ export type OrderItem = z.infer<typeof orderItemSchema>                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Replace createOrderInputSchema with:                                                                                                                                                           │  
     │                                                                                                                                                                                                │  
     │ export const createOrderInputSchema = orderFormSchema.extend({                                                                                                                                 │  
     │   currency: z.enum(['USD', 'CAD']),                                                                                                                                                            │  
     │   items: z.array(orderItemSchema).min(1, 'Order must have at least one item'),                                                                                                                 │  
     │   isPreOrder: z.boolean().optional(),                                                                                                                                                          │  
     │   customerId: z.number().int().positive().nullable().optional(),                                                                                                                               │  
     │   skipEmail: z.boolean().optional(),                                                                                                                                                           │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 4: src/lib/types/order.ts                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ Change: Replace CreateOrderResult and UpdateOrderInput                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │ export interface CreateOrderResult {                                                                                                                                                           │  
     │   success: boolean                                                                                                                                                                             │  
     │   orderId?: string                                                                                                                                                                             │  
     │   orderNumber?: string                                                                                                                                                                         │  
     │   orders?: Array<{                                                                                                                                                                             │  
     │     orderId: string                                                                                                                                                                            │  
     │     orderNumber: string                                                                                                                                                                        │  
     │     collectionName: string | null                                                                                                                                                              │  
     │     shipWindowStart: string | null                                                                                                                                                             │  
     │     shipWindowEnd: string | null                                                                                                                                                               │  
     │     orderAmount?: number                                                                                                                                                                       │  
     │   }>                                                                                                                                                                                           │  
     │   error?: string                                                                                                                                                                               │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ export interface UpdateOrderInput {                                                                                                                                                            │  
     │   orderId: string                                                                                                                                                                              │  
     │   storeName: string                                                                                                                                                                            │  
     │   buyerName: string                                                                                                                                                                            │  
     │   salesRepId: string                                                                                                                                                                           │  
     │   customerEmail: string                                                                                                                                                                        │  
     │   customerPhone: string                                                                                                                                                                        │  
     │   currency: 'USD' | 'CAD'                                                                                                                                                                      │  
     │   shipStartDate: string                                                                                                                                                                        │  
     │   shipEndDate: string                                                                                                                                                                          │  
     │   orderNotes?: string                                                                                                                                                                          │  
     │   customerPO?: string                                                                                                                                                                          │  
     │   website?: string                                                                                                                                                                             │  
     │   items: Array<{                                                                                                                                                                               │  
     │     sku: string                                                                                                                                                                                │  
     │     skuVariantId: number                                                                                                                                                                       │  
     │     quantity: number                                                                                                                                                                           │  
     │     price: number                                                                                                                                                                              │  
     │   }>                                                                                                                                                                                           │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ File 5: src/components/buyer/order-form.tsx                                                                                                                                                    │  
     │                                                                                                                                                                                                │  
     │ Change A: Remove shipment validation guard at top of onSubmit                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ Replace the start of onSubmit with:                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ const onSubmit = async (data: OrderFormData) => {                                                                                                                                              │  
     │   if (isSubmitting) return // Prevent double-click                                                                                                                                             │  
     │   setIsSubmitting(true)                                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ (Remove the hasShipmentValidationErrors && !overrideConfirmed check if present)                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Change B: Replace createOrder payload                                                                                                                                                          │  
     │                                                                                                                                                                                                │  
     │ Find the createOrder({ call and replace the payload with:                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ const result = await createOrder({                                                                                                                                                             │  
     │   ...data,                                                                                                                                                                                     │  
     │   currency,                                                                                                                                                                                    │  
     │   items: cartItems.map((item) => ({                                                                                                                                                            │  
     │     sku: item.sku,                                                                                                                                                                             │  
     │     skuVariantId: item.skuVariantId,                                                                                                                                                           │  
     │     quantity: item.quantity,                                                                                                                                                                   │  
     │     price: item.price,                                                                                                                                                                         │  
     │     collectionId: item.collectionId,                                                                                                                                                           │  
     │     collectionName: item.collectionName,                                                                                                                                                       │  
     │     shipWindowStart: item.shipWindowStart,                                                                                                                                                     │  
     │     shipWindowEnd: item.shipWindowEnd,                                                                                                                                                         │  
     │   })),                                                                                                                                                                                         │  
     │   isPreOrder,                                                                                                                                                                                  │  
     │   customerId: selectedCustomerId,                                                                                                                                                              │  
     │   skipEmail: true,                                                                                                                                                                             │  
     │ })                                                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Change C: Handle orders[] response                                                                                                                                                             │  
     │                                                                                                                                                                                                │  
     │ Replace the success handling block with:                                                                                                                                                       │  
     │                                                                                                                                                                                                │  
     │ if (result.success && result.orders?.length) {                                                                                                                                                 │  
     │   // Store order summaries for the modal (orders[] is the canonical return)                                                                                                                    │  
     │   setSubmittedShipments(result.orders.map((o) => ({                                                                                                                                            │  
     │     orderId: o.orderId,                                                                                                                                                                        │  
     │     orderNumber: o.orderNumber,                                                                                                                                                                │  
     │     collectionName: o.collectionName,                                                                                                                                                          │  
     │     shipWindowStart: o.shipWindowStart,                                                                                                                                                        │  
     │     shipWindowEnd: o.shipWindowEnd,                                                                                                                                                            │  
     │     orderAmount: o.orderAmount ?? orderTotal,                                                                                                                                                  │  
     │   })))                                                                                                                                                                                         │  
     │                                                                                                                                                                                                │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else if (result.success && result.orderId) {                                                                                                                                                 │  
     │   // Backwards compatibility: single order without orders array                                                                                                                                │  
     │   setSubmittedShipments([{                                                                                                                                                                     │  
     │     orderId: result.orderId,                                                                                                                                                                   │  
     │     orderNumber: result.orderNumber || '',                                                                                                                                                     │  
     │     collectionName: null,                                                                                                                                                                      │  
     │     shipWindowStart: null,                                                                                                                                                                     │  
     │     shipWindowEnd: null,                                                                                                                                                                       │  
     │     orderAmount: orderTotal,                                                                                                                                                                   │  
     │   }])                                                                                                                                                                                          │  
     │   setShowEmailModal(true)                                                                                                                                                                      │  
     │ } else {                                                                                                                                                                                       │  
     │   toast.error(result.error || 'Failed to create order')                                                                                                                                        │  
     │   setIsSubmitting(false)                                                                                                                                                                       │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Verification                                                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ Automated Checks                                                                                                                                                                               │  
     │                                                                                                                                                                                                │  
     │ npm run type-check   # No type errors                                                                                                                                                          │  
     │ npm run lint         # No lint errors                                                                                                                                                          │  
     │ npm run build        # Builds successfully                                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ Manual Testing                                                                                                                                                                                 │  
     │                                                                                                                                                                                                │  
     │ 1. Single collection order:                                                                                                                                                                    │  
     │   - Add items from 1 collection to cart                                                                                                                                                        │  
     │   - Submit → 1 order created                                                                                                                                                                   │  
     │   - Verify order has correct ship dates from collection                                                                                                                                        │  
     │ 2. Multi-collection order (split test):                                                                                                                                                        │  
     │   - Add items from 2 different collections to cart                                                                                                                                             │  
     │   - Submit → 2 separate orders created (different order numbers)                                                                                                                               │  
     │   - Each order has ship dates from its respective collection                                                                                                                                   │  
     │ 3. Ship date validation:                                                                                                                                                                       │  
     │   - Try to submit with dates earlier than collection window                                                                                                                                    │  
     │   - Should receive validation error                                                                                                                                                            │  
     │ 4. Draft submission:                                                                                                                                                                           │  
     │   - Save as draft with items from 2 collections                                                                                                                                                │  
     │   - Submit draft → 2 separate orders created                                                                                                                                                   │  
     │ 5. Edit existing order:                                                                                                                                                                        │  
     │   - Open an existing Pending order in edit mode                                                                                                                                                │  
     │   - Modify items/quantities                                                                                                                                                                    │  
     │   - Save → Order updated without errors                                                                                                                                                        │  
     │   - Verify no planned-shipment related errors                                                                                                                                                  │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Branch Strategy                                                                                                                                                                                │  
     │                                                                                                                                                                                                │  
     │ Create new branch from current HEAD:                                                                                                                                                           │  
     │ git checkout -b fix/revert-planned-shipments                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ ---                                                                                                                                                                                            │  
     │ Addendum: Edge-Case Guards                                                                                                                                                                     │  
     │                                                                                                                                                                                                │  
     │ A) Guard: Missing collections should not silently skip validation                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ In both createOrder() and draft submit validation blocks, add this safeguard after filtering groupCollections:                                                                                 │  
     │                                                                                                                                                                                                │  
     │ In createOrder():                                                                                                                                                                              │  
     │ if (groupCollectionIds.length > 0 && groupCollections.length === 0) {                                                                                                                          │  
     │   return {                                                                                                                                                                                     │  
     │     success: false,                                                                                                                                                                            │  
     │     error: 'Cannot validate ship dates: collection records missing for one or more items.',                                                                                                    │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ In draft submit:                                                                                                                                                                               │  
     │ if (groupCollectionIds.length > 0 && groupCollections.length === 0) {                                                                                                                          │  
     │   return NextResponse.json(                                                                                                                                                                    │  
     │     { error: 'Cannot validate ship dates: collection records missing for one or more items.' },                                                                                                │  
     │     { status: 400 }                                                                                                                                                                            │  
     │   )                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ This prevents groups with collection IDs that don't exist in the DB from silently bypassing validation.                                                                                        │  
     │                                                                                                                                                                                                │  
     │ B) Guard: Missing window dates is blocking (no override in Phase 1)                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ Already included in the plan, but explicitly note: there is no override mechanism in Phase 1. If a collection lacks ship window dates, the order is blocked:                                   │  
     │                                                                                                                                                                                                │  
     │ if (missingWindows.length > 0) {                                                                                                                                                               │  
     │   const names = missingWindows.map((c) => c.name ?? 'Unknown').join(', ')                                                                                                                      │  
     │   return {                                                                                                                                                                                     │  
     │     success: false,                                                                                                                                                                            │  
     │     error: `Cannot validate ship dates: ${names} missing ship window dates.`,                                                                                                                  │  
     │   }                                                                                                                                                                                            │  
     │ }                                                                                                                                                                                              │  
     │                                                                                                                                                                                                │  
     │ C) Date Handling (Unchanged)                                                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ No change to date logic. Ship dates are assigned exactly as they are now:                                                                                                                      │  
     │ - Collection's shipWindowStart/shipWindowEnd when available on cart items                                                                                                                      │  
     │ - Form dates as fallback when collection windows are missing                                                                                                                                   │  
     │                                                                                                                                                                                                │  
     │ This behavior is preserved. The validation ensures dates are not earlier than collection windows.                                                                                              │  
     │                                                                                                                                                                                                │  
     │ ---                                                                                                                                                                                            │  
     │ Post-Phase 1 Status                                                                                                                                                                            │  
     │                                                                                                                                                                                                │  
     │ Working:                                                                                                                                                                                       │  
     │ - Orders split by collection ✓                                                                                                                                                                 │  
     │ - Each order has correct ship dates ✓                                                                                                                                                          │  
     │ - Ship window validation enforced ✓                                                                                                                                                            │  
     │ - Emails sent per order ✓                                                                                                                                                                      │  
     │                                                                                                                                                                                                │  
     │ Still inconsistent (Phase 2):                                                                                                                                                                  │  
     │ - Modal language says "shipments" instead of "orders"                                                                                                                                          │  
     │ - Multi-shipment UI cards still visible (but ignored)                                                                                                                                          │  
     │ - Admin/rep tables show shipment counts                                                                                                                                                        │  
     │                                                                                                                                                                                                │  
     │ Orphaned (Phase 3 cleanup):                                                                                                                                                                    │  
     │ - PlannedShipment table (unused)                                                                                                                                                               │  
     │ - Admin planned shipments UI components                                                                                                                                                        │  
     │ - Item movement feature                                                             